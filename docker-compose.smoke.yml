services:
  neo4j:
    image: neo4j:5.26.12
    environment:
      NEO4J_AUTH: "${NEO4J_AUTH:-neo4j/password}"
      NEO4J_PLUGINS: '["apoc"]'
      NEO4J_server_default__listen__address: 0.0.0.0
      NEO4J_server_bolt_advertised__address: "neo4j:7687"
      NEO4J_server_http_advertised__address: "neo4j:7474"
      NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7474/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 40
    networks:
      - rag-net
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
      - neo4j-plugins:/plugins

  embedding-stub:
    image: python:3.12-slim
    command:
      - python
      - -c
      - |
        import json
        from http.server import BaseHTTPRequestHandler, ThreadingHTTPServer

        class _Handler(BaseHTTPRequestHandler):
            def do_POST(self):  # noqa: N802 - inherited signature
                if self.path != '/v1/embeddings':
                    self.send_response(404)
                    self.end_headers()
                    return

                length = int(self.headers.get('Content-Length', '0'))
                if length:
                    self.rfile.read(length)

                payload = {
                    'data': [
                        {
                            'embedding': [0.42, 0.13, 0.88],
                            'index': 0,
                            'object': 'embedding',
                        }
                    ],
                    'model': 'stub-model',
                }
                body = json.dumps(payload).encode('utf-8')
                self.send_response(200)
                self.send_header('Content-Type', 'application/json')
                self.send_header('Content-Length', str(len(body)))
                self.end_headers()
                self.wfile.write(body)

            def log_message(self, *_args, **_kwargs):
                return

        server = ThreadingHTTPServer(('0.0.0.0', 8000), _Handler)
        try:
            server.serve_forever()
        finally:
            server.server_close()
    healthcheck:
      test: [
        "CMD-SHELL",
        "python - <<'PY'\nimport json, urllib.request\ntry:\n    req = urllib.request.Request('http://localhost:8000/v1/embeddings', data=b'{}', headers={'Content-Type': 'application/json'})\n    urllib.request.urlopen(req, timeout=2)\nexcept Exception:\n    raise SystemExit(1)\nPY",
      ]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - rag-net

  mcp:
    build:
      context: .
    image: fancryrag-mcp:local
    depends_on:
      neo4j:
        condition: service_healthy
      embedding-stub:
        condition: service_healthy
    env_file:
      - "${MCP_ENV_FILE:-.env.local}"
    environment:
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USERNAME: "${NEO4J_USERNAME:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-password}"
      NEO4J_DATABASE: "${NEO4J_DATABASE:-neo4j}"
      INDEX_NAME: "${INDEX_NAME:-text_embeddings}"
      FULLTEXT_INDEX_NAME: "${FULLTEXT_INDEX_NAME:-chunk_text_fulltext}"
      EMBEDDING_API_BASE_URL: http://embedding-stub:8000/v1
      EMBEDDING_API_KEY: dummy-key
      EMBEDDING_MODEL: text-embedding-3-small
      EMBEDDING_TIMEOUT_SECONDS: "${EMBEDDING_TIMEOUT_SECONDS:-5}"
      EMBEDDING_MAX_RETRIES: "${EMBEDDING_MAX_RETRIES:-1}"
      GOOGLE_OAUTH_CLIENT_ID: test-client
      GOOGLE_OAUTH_CLIENT_SECRET: test-secret
      GOOGLE_OAUTH_REQUIRED_SCOPES: openid
      MCP_BASE_URL: http://localhost:8080/mcp
      MCP_SERVER_HOST: 0.0.0.0
      MCP_SERVER_PORT: "${MCP_SERVER_PORT:-8080}"
      MCP_SERVER_PATH: /mcp
      MCP_STATIC_TOKEN: smoke-token
      HYBRID_RETRIEVAL_QUERY_PATH: /app/queries/hybrid_retrieval.cypher
    networks:
      - rag-net

  smoke-tests:
    image: python:3.12-slim
    depends_on:
      neo4j:
        condition: service_healthy
      mcp:
        condition: service_started
      embedding-stub:
        condition: service_started
    environment:
      PIP_DISABLE_PIP_VERSION_CHECK: "1"
      PYTHONUNBUFFERED: "1"
      UV_NO_TRACK_CALLER_LOCATION: "1"
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USERNAME: "${NEO4J_USERNAME:-neo4j}"
      NEO4J_PASSWORD: "${NEO4J_PASSWORD:-password}"
      NEO4J_DATABASE: "${NEO4J_DATABASE:-neo4j}"
      INDEX_NAME: "${INDEX_NAME:-text_embeddings}"
      FULLTEXT_INDEX_NAME: "${FULLTEXT_INDEX_NAME:-chunk_text_fulltext}"
      MCP_URL: http://mcp:8080/mcp
      MCP_TOKEN: smoke-token
    working_dir: /workspace
    volumes:
      - .:/workspace
    entrypoint: ["bash", "-lc"]
    command:
      - >-
        python -m pip install --upgrade --quiet pip &&
        python -m pip install --quiet uv &&
        uv pip install --system ".[dev]" &&
        python scripts/wait_for_bolt.py &&
        pytest -q tests/smoke/test_stack.py
    networks:
      - rag-net

networks:
  rag-net:

volumes:
  neo4j-data:
  neo4j-logs:
  neo4j-plugins:
