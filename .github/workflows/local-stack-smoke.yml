name: local-stack-smoke

on:
  push:
    paths:
      - docker-compose.neo4j-qdrant.yml
      - scripts/check_local_stack.sh
      - tests/integration/local_stack/**
      - docs/architecture/overview.md
      - .github/workflows/local-stack-smoke.yml
  pull_request:
    paths:
      - docker-compose.neo4j-qdrant.yml
      - scripts/check_local_stack.sh
      - tests/integration/local_stack/**
      - docs/architecture/overview.md
      - .github/workflows/local-stack-smoke.yml
  workflow_dispatch:

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Prepare environment file
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python scripts/prepare_local_stack_env.py \
            --input .env.example \
            --output .env \
            --write-github-env
          if grep -q 'NEO4J_PASSWORD' .env; then
            echo 'NEO4J_PASSWORD present in .env'
          else
            echo 'Missing NEO4J_PASSWORD in .env' >&2
            exit 1
          fi

      - name: Validate compose configuration
        run: scripts/check_local_stack.sh --config

      - name: Start local stack services
        run: docker compose -f docker-compose.neo4j-qdrant.yml up -d --wait neo4j

      - name: Run smoke tests inside compose
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          docker compose -f docker-compose.neo4j-qdrant.yml run --rm --no-deps \
            -e OPENAI_API_KEY="$OPENAI_API_KEY" \
            -e LOCAL_STACK_SKIP_DOCKER_CHECK=1 \
            -e LOCAL_STACK_SKIP_QDRANT=1 \
            smoke-tests bash -lc "set -euo pipefail; pip install --upgrade pip >/dev/null; pip install --no-cache-dir -r requirements.lock; pytest tests/integration/local_stack/test_minimal_path_smoke.py"

      - name: Collect service logs
        if: failure()
        run: docker compose -f docker-compose.neo4j-qdrant.yml logs neo4j qdrant

      - name: Tear down stack
        if: always()
        run: docker compose -f docker-compose.neo4j-qdrant.yml down --volumes
