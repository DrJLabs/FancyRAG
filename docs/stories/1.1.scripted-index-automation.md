# Story 1.1: Scripted Index Automation

## Status
Done

## Story
**As a** Neo4j operator,
**I want** a scripted workflow that provisions both vector and full-text indexes,
**so that** hybrid retrieval can be bootstrapped consistently across environments.

## Acceptance Criteria
1. Script creates `chunk_text_fulltext` via GraphRAG helper and reruns without error.
2. Makefile exposes a `fulltext-index` target documented alongside `index`.
3. `.env.example` lists index-related variables with sensible defaults.

## Tasks / Subtasks
- [x] Author idempotent full-text index script (AC: 1) `[Ref: docs/architecture.md#application-architecture]`
  - [x] Instantiate Neo4j driver using environment variables and call `neo4j_graphrag.indexes.create_fulltext_index` (AC: 1) `[Ref: docs/architecture.md#domain--data-architecture]`
  - [x] Add logging for success/skip states following JSON logging guidance (AC: 1) `[Ref: docs/architecture.md#observability]`
  - [x] Provide command-line entry or main guard so script runs via Docker `python` invocation (AC: 1) `[Ref: docs/architecture/source-tree.md]`
- [x] Extend Makefile with `fulltext-index` target (AC: 2) `[Ref: docs/architecture.md#deployment-pipeline]`
  - [x] Ensure target executes `docker compose exec neo4j python scripts/create_fulltext_index.py` with proper dependency on `neo4j` service (AC: 2) `[Ref: docs/architecture.md#operational-runbook-summary]`
  - [x] Update Makefile comments to document usage mirroring existing `index` target (AC: 2) `[Ref: docs/architecture/coding-standards.md]`
- [x] Update `.env.example` with index variables (AC: 3) `[Ref: docs/architecture.md#security-architecture]`
  - [x] Document defaults for `INDEX_NAME`, `FULLTEXT_INDEX_NAME`, full-text label, and property (AC: 3) `[Ref: docs/architecture.md#technical-summary]`
  - [x] Add notes for operators to re-run index scripts after ingestion (AC: 3) `[Ref: docs/architecture.md#operational-runbook-summary]`
- [x] Create or update developer docs describing index workflow (AC: 1,2,3) `[Ref: docs/architecture.md#operational-runbook-summary]`
  - [x] Insert Makefile and script usage into `README.md` (primary operator guide) and note follow-on ops doc updates if needed (AC: 1,2,3) `[Ref: docs/architecture/source-tree.md]`
  - [x] Capture idempotency and rerun guidance for operational reruns (AC: 1,3) `[Ref: docs/architecture.md#risks--mitigations]`
- [x] Add automated tests or smoke checks (AC: 1) `[Ref: docs/architecture.md#testing-strategy]`
  - [x] Write pytest covering helper invocation and idempotent behavior using Neo4j test double (AC: 1) `[Ref: docs/architecture.md#testing-strategy]`
  - [x] Add integration smoke note for `make fulltext-index` in CI plan (AC: 1,2) `[Ref: docs/architecture.md#deployment-pipeline]`

## Dev Notes

### Previous Story Insights
- No previous stories exist; this is the first deliverable in Epic 1, so there are no prior Dev Agent learnings to incorporate.

### Data Models
- Index targets `Chunk` nodes, which store `text` and `embedding` fields consumed by retrieval. The vector index `text_embeddings` already exists; full-text index `chunk_text_fulltext` must cover `Chunk.text` for lexical queries. `[Source: docs/architecture.md#domain--data-architecture]`

### API Specifications
- Use GraphRAG helper `neo4j_graphrag.indexes.create_fulltext_index` to build the full-text index, ensuring the script imports from the project-managed GraphRAG package versions. `[Source: docs/architecture.md#application-architecture]`
- Connect via the Neo4j Python driver using credentials from environment variables (`NEO4J_URI`, `NEO4J_USERNAME`, `NEO4J_PASSWORD`, `NEO4J_DATABASE`). `[Source: docs/epics/epic-1-hybrid-retrieval-foundation.md#dependencies--inputs]`

### Component Specifications
- No UI or frontend components are involved in this story; all work occurs in backend scripts and Makefile automation. `[Source: docs/architecture/source-tree.md]`

### File Locations
- Place the script under `scripts/` to align with repository automation conventions, and ensure Makefile targets live at repo root. `[Source: docs/architecture/source-tree.md]`
- Environment samples reside in `.env.example`; document new variables there with descriptive comments. `[Source: docs/architecture.md#operational-runbook-summary]`

### Testing Requirements
- Follow `pytest` for unit tests and plan integration smoke tests that run index targets against Neo4j (via Testcontainers or docker compose). `[Source: docs/architecture.md#testing-strategy]`
- Enforce linting and formatting with `ruff check`/`ruff format` when adding scripts or tests. `[Source: docs/architecture/coding-standards.md#python-style]`

### Technical Constraints
- All configuration must be environment-driven; scripts should validate required variables and avoid hard-coded secrets. `[Source: docs/architecture.md#security-architecture]`
- Scripts and Makefile targets must output structured JSON logs to stdout/stderr to support log aggregation. `[Source: docs/architecture.md#observability]`
- Ensure Docker Compose workflows remain reproducible (`docker compose up -d neo4j mcp` followed by index targets). `[Source: docs/architecture.md#deployment-pipeline]`

### Project Structure Notes
- Align documentation updates with `README.md` (primary bootstrap flow) and ensure any supplemental ops guides remain consistent. `[Source: docs/architecture.md#operational-runbook-summary]`

#### Testing
- Unit: Cover GraphRAG helper invocation, idempotency check, and environment validation using `pytest`. `[Source: docs/architecture.md#testing-strategy]`
- Integration: Compose-based smoke that runs `make fulltext-index` after Neo4j starts to confirm script integration. `[Source: docs/architecture.md#testing-strategy]`
- Continuous: Add job to CI pipeline (planned GitHub Actions) to execute indexing script as part of hybrid regression. `[Source: docs/architecture.md#deployment-pipeline]`

## Change Log
| Date       | Version | Description                       | Author |
|------------|---------|-----------------------------------|--------|
| 2025-10-08 | 0.1     | Initial draft of Story 1.1 (SM)   | Bob    |
| 2025-10-09 | 0.2     | Implementation ready for QA       | James  |
| 2025-10-09 | 1.0     | QA + PO sign-off; ready to release | Quinn & Sarah |

## Dev Agent Record

### Agent Model Used

- Codex GPT-5 (developer profile)

### Debug Log References

- `uv run pytest`

### Completion Notes List

- Added `scripts/create_fulltext_index.py` with JSON-structured logging and environment validation around the GraphRAG helper.
- Extended Makefile with `fulltext-index` target (host-executed via `uv run` because the Neo4j container lacks Python/GraphRAG tooling) and documented usage in `README.md` alongside rerun guidance.
- Updated `.env.example` defaults and documented hybrid index configuration plus rerun expectations for operators.
- Implemented pytest coverage for idempotent runs, config validation, and `.env.example` contract.
- Recorded QA risk profile & test design artifacts under `docs/qa/assessments` for Story 1.1.

### File List

- `scripts/__init__.py`
- `scripts/create_fulltext_index.py`
- `tests/scripts/test_create_fulltext_index.py`
- `.env.example`
- `Makefile`
- `README.md`
- `docs/qa/assessments/1.1-risk-20251009.md`
- `docs/qa/assessments/1.1-test-design-20251009.md`

## QA Results

- **Reviewer**: Quinn (QA) — 2025-10-09
- **Outcome**: PASS — readiness guard and CI smoke in place; proceed to Done.
- **Evidence**:
  - Traceability matrix: `docs/qa/assessments/1.1-trace-20251009.md`
  - Risk profile: `docs/qa/assessments/1.1-risk-20251009.md`
  - Test design: `docs/qa/assessments/1.1-test-design-20251009.md`
  - NFR assessment: `docs/qa/assessments/1.1-nfr-20251009.md`
- **Validations Executed**:
  - `uv run pytest tests/scripts/test_create_fulltext_index.py` (pass; 6 tests after readiness additions, pytest deprecation warning acknowledged).
  - Workflow `.github/workflows/fulltext-index-smoke.yml` provisions Neo4j via compose and executes `make fulltext-index` twice per run (new automation evidence).
- **Key Findings**:
  - Readiness wait (configurable attempts/delay) prevents races with Neo4j startup.
  - CI smoke continuously validates Makefile + README alignment; keep optional doc lint on backlog for future expansion.
- Gate: PASS → docs/qa/gates/1.1-scripted-index-automation.yml

## PO Validation

- **Reviewer**: Sarah (PO) — 2025-10-09
- **Decision**: GO — approves release with readiness guard + CI smoke ensuring operator workflow stability.
- **Evidence Reviewed**:
  - QA gate: `docs/qa/gates/1.1-scripted-index-automation.yml`
  - README & `.env.example` readiness defaults verifying operator guidance.
  - GitHub Actions smoke: `.github/workflows/fulltext-index-smoke.yml`
- **Notes**: Monitor long-running Neo4j operations; optional doc lint backlog item acknowledged.
