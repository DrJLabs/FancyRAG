# Story 3.1: Adaptive Chunking Profiles & Source-Aware Ingestion

## Status
Ready for Review

## Story
**As a** FancyRAG operator working with mixed documentation and source repositories,
**I want** the ingestion pipeline to offer configurable chunking presets and capture rich source metadata,
**so that** I can ingest diverse corpora without manual preprocessing while preserving traceability for downstream retrieval.

## Acceptance Criteria
1. `scripts/kg_build.py` exposes chunking presets (e.g., `--profile text`, `--profile markdown`, `--profile code`) that map to documented splitter configurations using GraphRAG-supported components, defaulting to the current 600/100 fixed-size behaviour when no profile is supplied. [Source: docs/bmad/focused-epics/ingestion-quality/epic.md#Stories] [Source: docs/architecture/overview.md#Minimal Path Workflow] [Source: docs/architecture/coding-standards.md#Script Conventions]
2. The ingestion CLI accepts directories (and optional glob filters), walks files deterministically, and records per-chunk metadata including relative path, git commit (when available), checksum, and chunk index on both Neo4j nodes and log output. [Source: docs/bmad/focused-epics/ingestion-quality/epic.md#Enhancement Details] [Source: docs/architecture.md#Database & Collection Schema]
3. Metadata persisted during ingestion propagates to Qdrant payloads via downstream scripts without breaking existing retrieval defaults, and the local sample pipeline (`docs/samples/pilot.txt`) continues to succeed with no additional flags. [Source: docs/bmad/focused-epics/ingestion-quality/epic.md#Success criteria] [Source: docs/architecture/overview.md#Minimal Path Workflow]
4. Unit and integration tests cover each profile path, directory ingestion, and metadata propagation, reusing existing mocking strategy and keeping compose smoke green. [Source: docs/bmad/focused-epics/ingestion-quality/epic.md#Stories] [Source: docs/architecture/coding-standards.md#Testing Expectations]

## Tasks / Subtasks
- [x] Extend `scripts/kg_build.py` CLI with `--profile` (text/markdown/code) and optional splitter tuning flags, wiring to GraphRAG splitter components per profile while preserving the fixed-size default (AC1). [Source: docs/architecture/overview.md#Minimal Path Workflow]
- [x] Implement directory ingestion support (e.g., `--source-dir`, `--include-pattern`) that yields deterministic ordering, normalises paths relative to repo root, and coalesces file text before chunking (AC1, AC2). [Source: docs/architecture/source-tree.md#Source Tree Blueprint]
- [x] Capture metadata (relative path, git commit SHA, checksum, chunk index) when constructing `Chunk` properties and ensure sanitisation logic stores these fields in Neo4j (AC2). [Source: docs/architecture.md#Database & Collection Schema]
- [x] Propagate new metadata fields to Qdrant payload generation in `scripts/export_to_qdrant.py`, guarding against payload bloat and documenting optional filters (AC2, AC3). [Source: docs/architecture/overview.md#Local Stack Automation]
- [x] Verify backward compatibility by running the minimal path with default options and updated scripts, confirming logs and artifacts remain stable (AC3). [Source: docs/architecture/overview.md#Minimal Path Workflow]
- [x] Add unit tests for profile selection, directory walking, and metadata hashing using existing mock drivers; extend integration smoke (or new fixture corpus) to exercise at least one non-default profile (AC4). [Source: docs/architecture/coding-standards.md#Testing Expectations]
- [x] Update developer-facing docs (README, architecture overview) with profile usage instructions and metadata notes (AC1, AC2). [Source: docs/architecture/overview.md#Minimal Path Workflow]

## Change Log
| Date       | Version | Description                                                      | Author |
|------------|---------|------------------------------------------------------------------|--------|
| 2025-10-01 | 0.1     | Story drafted with adaptive chunking requirements captured       | Bob    |
| 2025-10-01 | 0.2     | Implemented profiles, directory ingestion, metadata, docs, tests | Codex  |

## QA Results
### Risk Profile
- See docs/qa/assessments/3.1-risk-20251001.md

### Test Design
- See docs/qa/assessments/3.1-test-design-20251001.md

### Traceability
- 4/4 acceptance criteria fully covered. Matrix: docs/qa/assessments/3.1-trace-20251001.md

### NFR Assessment
- Security PASS / Performance MONITOR / Reliability PASS / Maintainability PASS. Details: docs/qa/assessments/3.1-nfr-20251001.md

### QA Review
- Summary recorded in docs/qa/assessments/3.1-review-20251001.md

### QA Gate
- Status PASS (monitor). Gate file: docs/qa/gates/3.1-adaptive-chunking.yml

## Dev Agent Record
### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- 2025-10-01: `pytest tests/unit/scripts/test_kg_build.py tests/unit/scripts/test_export_to_qdrant.py`

### Completion Notes List
- Added chunking profiles (`--profile`), directory ingestion, and deterministic file traversal to `scripts/kg_build.py` while persisting per-chunk metadata (relative path, checksum, git commit).
- Propagated metadata to Qdrant payloads and added unit coverage validating ingest/export behaviours including binary skips and profile selection.
- Updated README and architecture overview instructions for new CLI flows; emitted QA artefacts (risk, test design, trace, NFR, review) and registered QA gate + PO validation.

### File List
- scripts/kg_build.py
- scripts/export_to_qdrant.py
- tests/unit/scripts/test_kg_build.py
- tests/unit/scripts/test_export_to_qdrant.py
- README.md
- docs/architecture/overview.md
- docs/qa/assessments/3.1-risk-20251001.md
- docs/qa/assessments/3.1-test-design-20251001.md
- docs/qa/assessments/3.1-trace-20251001.md
- docs/qa/assessments/3.1-nfr-20251001.md
- docs/qa/assessments/3.1-review-20251001.md
- docs/qa/gates/3.1-adaptive-chunking.yml
- docs/qa/assessments/3.1-po-validation-20251001.md
## PO Validation
- 2025-10-01: GO decision confirmed after QA gate; monitor performance follow-up (compose smoke) per docs/qa/gates/3.1-adaptive-chunking.yml. Report: docs/qa/assessments/3.1-po-validation-20251001.md
