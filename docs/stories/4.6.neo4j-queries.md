# Story 4.6: Neo4j Query Helpers Module

## Status
Done — 2025-10-04

## Story
**As a** FancyRAG pipeline maintainer,
**I want** the Neo4j ingestion and rollback Cypher helpers extracted into a dedicated database module shared by pipeline and QA components,
**so that** ingestion runs keep consistent, testable graph mutations aligned with the refactor guardrails while preserving existing CLI behaviour.

## Acceptance Criteria
1. Implement `src/fancyrag/db/neo4j_queries.py` housing reset, document relationship, rollback, and QA count helpers currently embedded in the pipeline/evaluator, exposing typed functions that accept a Neo4j driver, optional database name, and structured payloads without altering query semantics. [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-1-kg_buildpy-monolith-decomposition] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: src/fancyrag/kg/pipeline.py]
2. Refactor `src/fancyrag/kg/pipeline.py` to invoke the new helpers, retaining ingest run key handling, rollback semantics, relative-path provenance updates, and the CLI → pipeline → db import direction documented for the refactor. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/overview.md#Built-In Tool Playbook] [Source: src/fancyrag/kg/pipeline.py]
3. Update `src/fancyrag/qa/evaluator.py` to consume the shared db helpers for graph counts, chunk anomaly queries, and semantic checks so QA gating uses the same Cypher catalogue without duplicating string literals. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/stories/4.4.qa-evaluator.md#Acceptance Criteria] [Source: src/fancyrag/qa/evaluator.py]
4. Add automated coverage for the shared db helpers, including unit tests for ingest rollback edge cases, chunk provenance updates, and QA count queries, and close QA’s 4.5 follow-ups by landing integration scenario 4.5-INT-002 (`kg.run --qa-report-dir` against an external directory) plus clearing the `resolve_repo_root` cache issue so `tests/unit/fancyrag/utils/test_paths.py` passes without manual intervention. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations] [Source: docs/stories/4.5.qa-report.md#Risks & Recommendations] [Source: tests/unit/fancyrag/kg/test_pipeline.py]
5. Update architecture and epic documentation to mark the db module delivered, and provide evidence that Story 4.5’s CONCERNS are closed (updated QA gate, integration test artifacts, and QA sign-off notes). [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Stories] [Source: docs/stories/4.5.qa-report.md#Risks & Recommendations]

## Tasks / Subtasks
- [x] Catalogue the reset, document relationship, rollback, and QA query helpers in `src/fancyrag/kg/pipeline.py` and `src/fancyrag/qa/evaluator.py` to confirm extraction scope. (AC: 1) [Source: src/fancyrag/kg/pipeline.py] [Source: src/fancyrag/qa/evaluator.py]
- [x] Implement `src/fancyrag/db/neo4j_queries.py` with typed functions that encapsulate the shared Cypher catalogue, preserving sanitisation, ingest run key behaviour, and optional database routing. (AC: 1) [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
- [x] Refactor pipeline orchestration to import the db helpers, keeping rollback semantics, provenance mutations, and CLI wiring unchanged for operators. (AC: 2) [Source: docs/architecture/overview.md#Built-In Tool Playbook] [Source: src/fancyrag/kg/pipeline.py]
- [x] Update the QA evaluator to rely on the shared helpers for counts, anomaly queries, and semantic metrics while maintaining threshold enforcement. (AC: 3) [Source: docs/stories/4.4.qa-evaluator.md#Acceptance Criteria] [Source: src/fancyrag/qa/evaluator.py]
- [x] Add unit tests under `tests/unit/fancyrag/db/`, update pipeline/evaluator tests and fixtures to mock the shared helpers, implement the 4.5-INT-002 integration scenario, and clear the `resolve_repo_root` cache fixture so `tests/unit/fancyrag/utils/test_paths.py` passes without manual intervention. (AC: 4) [Source: docs/architecture/coding-standards.md#Testing Expectations] [Source: docs/stories/4.5.qa-report.md#Risks & Recommendations]
- [x] Refresh `docs/architecture/source-tree.md`, the refactor project shard, and Epic 4 documentation to register the delivered db module and attach QA artifacts demonstrating closure of Story 4.5 CONCERNS (updated gate, integration logs, QA sign-off). (AC: 5) [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/stories/4.5.qa-report.md#Risks & Recommendations]

## Dev Notes
### Previous Story Insights
- Story 4.5 left a QA gate CONCERNS on CLI integration coverage and cached path helpers; the db module landed alongside the cache fix and the new integration test to clear those items. [Source: docs/stories/4.5.qa-report.md#Risks & Recommendations]
- Story 4.4 emphasised maintaining the CLI → pipeline → QA import direction; the new db module slots beneath pipeline/QA without reverse dependencies. [Source: docs/stories/4.4.qa-evaluator.md#Component Specifications]

### Data Models
- Document and Chunk nodes, HAS_CHUNK relationships, and ingest run key semantics remain unchanged now that the helpers sit inside `src/fancyrag/db/neo4j_queries.py`. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]

### API Specifications
- Pipeline options for reset flags, ingest run keys, and provenance updates continue to route through the shared helpers without altering CLI contracts. [Source: src/fancyrag/kg/pipeline.py] [Source: docs/architecture/overview.md#Built-In Tool Playbook]

### Component Specifications
- The db module exposes pure functions (no global driver state) to keep the module testable and respect the documented module boundary (CLI → pipeline → QA/report/db). [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#2-high-level-design]

### Testing Requirements
- Unit coverage exercises helper functions, pipeline/evaluator wiring, and the previously deferred integration scenario, matching Story 4.5 follow-ups. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy]

### Technical Constraints
- Target Python 3.12 with the pinned Neo4j driver; helper tests rely on in-memory doubles rather than live services. [Source: docs/architecture/tech-stack.md#Technology Stack]

### Open Risks & Follow-Ups
- Monitor future stories (4.7+) for schema helper overlap so db helpers remain the single source of Cypher definitions.

## Testing
- [x] `PYTHONPATH=src pytest tests/unit/fancyrag/db/test_neo4j_queries.py tests/unit/fancyrag/kg/test_pipeline.py tests/unit/fancyrag/qa/test_evaluator.py tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir`
- [x] `set -a && source .env && set +a && PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py::test_minimal_path_smoke`
- [x] `PYTHONPATH=src python scripts/kg_build.py --help`

## Change Log
| Date       | Version | Description                                   | Author |
|------------|---------|-----------------------------------------------|--------|
| 2025-10-04 | 0.1     | Draft story for Neo4j query helpers module     | Bob    |
| 2025-10-04 | 1.0     | Story completed, QA sign-off recorded, smoke rerun | drj |

## Dev Agent Record
### Agent Model Used
- Codex (GPT-5) — 2025-10-04

### Debug Log References
- 2025-10-04 — `PYTHONPATH=src pytest tests/unit/fancyrag/db/test_neo4j_queries.py tests/unit/fancyrag/kg/test_pipeline.py tests/unit/fancyrag/qa/test_evaluator.py`
- 2025-10-04 — `PYTHONPATH=src pytest tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir`
- 2025-10-04 — `set -a && source .env && set +a && PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py::test_minimal_path_smoke`

### Completion Notes List
- Extracted Neo4j helper catalogue into `src/fancyrag/db/neo4j_queries.py` and wired pipeline/QA consumers to the shared functions.
- Refreshed unit and integration coverage, clearing Story 4.5 follow-ups and validating CLI smoke against the local Docker stack with the real OpenAI key.
- Updated architecture shards, epic notes, and QA gate references to reflect the shared db module delivery.

## QA Results
### Risk Profile
- PASS — docs/qa/assessments/4.6-trace-20251004.md captured all acceptance criteria with no residual risk items.

### Test Design
- PASS — docs/qa/assessments/4.6-test-design-20251004.md executed as planned; integration scenario 4.5-INT-002 verified helper wiring.

### Traceability
- PASS — docs/qa/assessments/4.6-trace-20251004.md links helper functions to acceptance criteria and test coverage.

### NFR Assessment
- PASS — docs/qa/assessments/4.6-nfr-20251004.md confirmed security, performance, reliability, and maintainability expectations.

### PO Validation
- PASS — Epic 4 updated to mark Story 4.6 complete; override from Story 2.6 lifted.
