# Story 2.5: Minimal Path Script Automation

## Status
Draft

## Story
**As a** GraphRAG operator,
**I want** Python scripts that create the Neo4j vector index and run the `SimpleKGPipeline` ingestion workflow against sample content,
**so that** the local minimal path can be executed end-to-end with consistent guardrails, logging, and retries ahead of vector export and retrieval steps.

## Acceptance Criteria
1. Add `scripts/create_vector_index.py` that connects to Neo4j using shared settings, creates or verifies the `chunks_vec` vector index (1536 dimensions, cosine similarity), idempotently handles reruns, and emits structured JSON logs aligned with coding standards while respecting `.env` overrides. [Source: docs/bmad/focused-epics/local-stack/epic.md#stories] [Source: docs/architecture/overview.md#minimal-path-workflow] [Source: docs/architecture.md#database--collection-schema] [Source: docs/architecture/coding-standards.md#script-conventions]
2. Provide `scripts/kg_build.py` that loads sample content from `docs/samples/`, invokes `SimpleKGPipeline` with the shared OpenAI client for embeddings, streams progress metrics, and gracefully retries OpenAI rate limits using the configured backoff while masking secrets. [Source: docs/bmad/focused-epics/local-stack/epic.md#story-manager-handoff] [Source: docs/architecture/overview.md#high-level-components] [Source: docs/architecture/coding-standards.md#critical-rules]
3. Document the ingestion workflow in `docs/architecture/overview.md` (and related operator guides) detailing prerequisites (`docker compose up`), script parameters, `.env` expectations, and teardown sequencing so operators can run steps 2â€“3 of the minimal path without guesswork. [Source: docs/architecture/overview.md#minimal-path-workflow] [Source: docs/architecture/overview.md#environment-configuration] [Source: docs/bmad/focused-epics/local-stack/epic.md#epic-goal]
4. Add automated coverage (unit + integration-ready smoke) that stubs Neo4j/OpenAI for script reruns, asserts structured logging fields, ensures retries honour `OPENAI_MAX_ATTEMPTS`, and produces fixtures reusable by the upcoming Qdrant export story. [Source: docs/architecture/coding-standards.md#testing-expectations] [Source: docs/architecture/overview.md#minimal-path-workflow] [Source: docs/stories/2.3.openai-shared-client.md#acceptance-criteria]

## Tasks / Subtasks
- [ ] Implement `scripts/create_vector_index.py` using shared configuration helpers, ensuring idempotent index creation and structured logging (AC: 1). [Source: docs/architecture.md#core-workflows] [Source: docs/architecture/coding-standards.md#script-conventions]
  - [ ] Accept CLI options for index name, dimensions, and sample source while defaulting to values documented in the minimal path (AC: 1). [Source: docs/architecture/overview.md#minimal-path-workflow]
  - [ ] Verify retries/backoff around Neo4j driver operations and exit with actionable diagnostics on failure (AC: 1). [Source: docs/architecture/coding-standards.md#critical-rules]
- [ ] Add `scripts/kg_build.py` that orchestrates `SimpleKGPipeline`, streams structlog progress, and honours `.env` plus CLI overrides (AC: 2). [Source: docs/architecture/overview.md#high-level-components] [Source: docs/architecture/coding-standards.md#logging-guidance]
  - [ ] Centralise OpenAI access through `cli.openai_client.SharedOpenAIClient` and expose batch sizing options for embeddings to manage token budgets (AC: 2). [Source: docs/stories/2.3.openai-shared-client.md#acceptance-criteria]
  - [ ] Ensure the pipeline persists document and chunk nodes with relationships expected by downstream export scripts (AC: 2). [Source: docs/architecture.md#database--collection-schema]
- [ ] Seed `docs/samples/pilot.txt` (or equivalent) with representative content and note replacement guidance for operators (AC: 3). [Source: docs/architecture/overview.md#minimal-path-workflow]
- [ ] Update `docs/architecture/overview.md` ingestion section with runbook steps, CLI examples, and teardown reminders tied to Compose (AC: 3). [Source: docs/architecture/overview.md#environment-configuration]
- [ ] Extend tests: add unit suites for both scripts (mocking Neo4j/OpenAI) and integration harness that can plug into the Compose stack once available, producing reusable fixtures (AC: 4). [Source: docs/architecture/coding-standards.md#testing-expectations]
  - [ ] Capture structured log snapshots and ensure retries stop at `OPENAI_MAX_ATTEMPTS`, raising clear errors for exhaustion (AC: 4). [Source: docs/architecture/coding-standards.md#critical-rules]
  - [ ] Document how upcoming Qdrant export smoke tests consume these fixtures to avoid duplicate setup (AC: 4). [Source: docs/bmad/focused-epics/local-stack/epic.md#success-criteria]

## Dev Notes


<!-- override-note -->
Warning: override of incomplete story status executed.
- Timestamp (UTC): 2025-09-29T18:28:59.685589+00:00
- Actor: drj
- Prior Story: 2.4
- Prior Status: Draft
- Reason: Unblock script automation while Story 2.4 remains Draft

### Previous Story Insights
- Story 2.4â€™s Docker Compose stack establishes Neo4j and Qdrant containers, so these scripts must assume the stack is running and reuse the `.env` configuration documented there. [Source: docs/stories/2.4.docker-compose-neo4j-qdrant.md#dev-notes]
- Story 2.3 centralised OpenAI guardrails; leverage `SharedOpenAIClient` for embeddings to avoid duplicated retry and telemetry logic. [Source: docs/stories/2.3.openai-shared-client.md#dev-notes]

### Data Models
- Neo4j graph should persist `Document` and `Chunk` nodes plus relationships created by `SimpleKGPipeline`, with the vector index targeting `Chunk.embedding` at 1536 dimensions. [Source: docs/architecture.md#database--collection-schema]

### API Specifications
- `SimpleKGPipeline` orchestrates embeddings generation and graph writes; ensure scripts expose parameters consistent with documented minimal path commands and honour `.env` overrides for service URIs and credentials. [Source: docs/architecture/overview.md#minimal-path-workflow]

### Component Specifications
- Scripts belong under `scripts/` and must integrate with shared configuration helpers so future CLI commands remain consistent with the source tree blueprint. [Source: docs/architecture/source-tree.md#source-tree-blueprint]

### File Locations
- Place new scripts in `scripts/` and sample content under `docs/samples/`, keeping documentation updates within `docs/architecture/overview.md` to align with existing workflow narrative. [Source: docs/architecture/source-tree.md#source-tree-blueprint]

### Testing Requirements
- Follow coding standards: provide pytest suites that mock external services, maintain log redaction, and support eventual integration runs against the Compose stack without leaking secrets. [Source: docs/architecture/coding-standards.md#testing-expectations]

### Technical Constraints
- Support Python 3.12 runtime, `neo4j-graphrag[experimental,openai,qdrant]`, Neo4j 5.26, Qdrant â‰¥â€¯1.8, and the OpenAI models declared in `.env`. [Source: docs/architecture/tech-stack.md#technology-stack]

### Project Structure Notes
- No dedicated `unified-project-structure.md` shard exists; use `docs/architecture/source-tree.md` to verify script placement and naming consistency. [Source: docs/architecture/source-tree.md#source-tree-blueprint]

### Documentation Alignment
- Update the architecture overview so the ingestion steps mirror the new scripts and call out when to rerun diagnostics versus Compose health checks. [Source: docs/architecture/overview.md#workspace-verification]

### Secrets Handling
- Ensure scripts load credentials from `.env`/environment without logging sensitive values; reuse sanitization helpers for any output. [Source: docs/architecture/coding-standards.md#critical-rules]

### Monitoring & Observability
- Emit structured logs (`operation`, `status`, `duration_ms`, counts) that feed existing telemetry dashboards and align with expectations set for Compose smoke tests. [Source: docs/architecture/coding-standards.md#logging-guidance]

## Testing
- Unit tests: `PYTHONPATH=src pytest tests/unit/scripts/test_create_vector_index.py tests/unit/scripts/test_kg_build.py` covering idempotency, retry, and logging behaviour via mocks. [Source: docs/architecture/coding-standards.md#testing-expectations]
- Integration prep: scaffold `tests/integration/local_stack/test_ingest_minimal_path.py` to run against Compose once the stack is available, ensuring fixtures can chain into Qdrant export later. [Source: docs/architecture/overview.md#minimal-path-workflow]
- Log fixtures: capture JSON log snapshots under `tests/fixtures/minimal_path/` for reuse when verifying Qdrant export telemetry. [Source: docs/bmad/focused-epics/local-stack/epic.md#success-criteria]

## Change Log
| Date       | Version | Description                        | Author |
|------------|---------|------------------------------------|--------|
| 2025-09-29 | 0.1     | Initial draft of Story 2.5 created | Bob    |

## Dev Agent Record
### Agent Model Used
- Pending (to be completed during implementation)

### Debug Log References
- Pending

### Completion Notes List
- Pending

### File List
- Pending

## QA Results
### Risk Profile
- Pending

### Test Design
- Pending

### Traceability
- Pending

### NFR Assessment
- Pending

### PO Validation
- Pending

## ðŸ”¬ Research & Validation Log
- Pending (request researcher review when ready)
