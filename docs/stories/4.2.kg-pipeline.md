# Story 4.2: Pipeline Orchestrator Module

## Status
Done — 2025-10-04

## Story
**As a** FancyRAG pipeline maintainer,
**I want** the ingestion orchestration and dependency validation logic relocated into `src/fancyrag/kg/pipeline.py` with a cohesive interface,
**so that** the CLI stays thin while the GraphRAG build workflow becomes modular, testable, and aligned with the refactor guardrails.

## Acceptance Criteria
1. Create `src/fancyrag/kg/pipeline.py` housing the pipeline orchestrator previously embedded in `fancyrag.cli.kg_build_main`, exposing a typed entry point that coordinates ingestion stages (schema load, chunking, pipeline execution, QA reporting) described for Epic 4. [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Stories] [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-1-kg_buildpy-monolith-decomposition] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
2. Ensure the new orchestrator centralises dependency validation—GraphRAG module availability, environment variables, sanitized Neo4j writes, semantic enrichment toggles—and returns structured results that the CLI can log without duplicating business logic. [Source: docs/architecture/overview.md#Built-In Tool Playbook] [Source: docs/architecture/coding-standards.md#Critical Rules] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]
3. Update `fancyrag.cli.kg_build_main` to call the orchestrator interface, limiting the module to argument parsing, profile resolution, and output handling while preserving behavioural parity (flags, logging, error handling). [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/architecture/overview.md#High-Level Components]
4. Add focused unit tests under `tests/unit/fancyrag/kg/` plus refreshed integration/smoke coverage proving the orchestrator handles reset flags, multi-file ingestion, and QA gating, following the documented testing strategy and coding standards. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations]
5. Refresh architecture documentation (source tree + refactor addendum) to mark the pipeline module as delivered and document its public interface/import direction (CLI → pipeline → QA/DB helpers). [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#2-high-level-design]

## Tasks / Subtasks
- [x] Catalogue the orchestration, dependency checks, and helper functions currently living in `fancyrag.cli.kg_build_main` to define the extraction scope (AC: 1, 2). [Source: src/fancyrag/cli/kg_build_main.py] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
- [x] Implement `src/fancyrag/kg/pipeline.py` with a typed orchestrator that runs ingestion for one or more sources, applies dependency validation, and yields structured results (counts, QA report, chunk metadata) for the CLI (AC: 1, 2). [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Stories] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]
- [x] Refactor `fancyrag.cli.kg_build_main` to rely on the new orchestrator while keeping flag resolution, logging shape, and error semantics unchanged for operators (AC: 3). [Source: docs/architecture/overview.md#Built-In Tool Playbook] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
- [x] Add unit tests under `tests/unit/fancyrag/kg/` covering dependency failure paths, successful ingestion with semantic enrichment enabled, and reset safeguards; update integration smoke tests to import the orchestrator (AC: 4). [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations]
- [x] Update `docs/architecture/source-tree.md` and the refactor addendum to mark `kg/pipeline.py` as complete and describe the CLI → pipeline import boundary (AC: 5). [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#2-high-level-design]

## Dev Notes
### Previous Story Insights
- Story 4.1 reduced `scripts/kg_build.py` to a CLI wrapper and emphasised preserving semantic enrichment toggles and telemetry when delegating; the pipeline module must inherit those behaviours. [Source: docs/stories/4.1.cli-kg-build-main.md#Dev Notes]

### Data Models
- The orchestrator continues to populate Neo4j Document and Chunk nodes along with semantic enrichment relationships via `SimpleKGPipeline`; schema helpers remain responsible for graph shape. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/overview.md#High-Level Components]

### API Specifications
- Invocation flows rely on `neo4j_graphrag.experimental.pipeline.SimpleKGPipeline`, `GraphSchema`, `Neo4jWriter`, and shared OpenAI adapters; maintain their wiring exactly as documented. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/overview.md#Built-In Tool Playbook]

### Component Specifications
- Import direction must remain CLI → pipeline → QA/report/db modules, avoiding reverse imports or circular dependencies. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#2-high-level-design]

### File Locations
- Place the new orchestrator at `src/fancyrag/kg/pipeline.py`, keep CLI code under `src/fancyrag/cli/`, and mirror the structure in tests. [Source: docs/architecture/source-tree.md#Upcoming Module Layout]

### Testing Requirements
- Follow the refactor testing strategy: unit coverage per module plus the existing CLI smoke to validate pipeline parity after extraction. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations]

### Technical Constraints
- Continue targeting Python 3.12 with the pinned GraphRAG, Neo4j, Qdrant, and OpenAI packages; guard secrets and enforce retry/idempotency rules during orchestration. [Source: docs/architecture/tech-stack.md#technology-stack] [Source: docs/architecture/coding-standards.md#Critical Rules]

## Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag/cli/test_kg_build_main.py tests/unit/fancyrag/kg/test_pipeline.py`
- `LOCAL_STACK_SKIP_DOCKER_CHECK=1 PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs`
- `PYTHONPATH=stubs:src python3 scripts/kg_build.py --help`
  
### Debug Log References
- `PYTHONPATH=src pytest tests/unit/fancyrag/cli/test_kg_build_main.py tests/unit/fancyrag/kg/test_pipeline.py`
- `LOCAL_STACK_SKIP_DOCKER_CHECK=1 PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs`
- `PYTHONPATH=stubs:src python3 scripts/kg_build.py --help`

## Change Log

| Date       | Version | Description                                   | Author |
|------------|---------|-----------------------------------------------|--------|
| 2025-10-03 | 0.1     | Draft story for pipeline orchestrator module  | Bob    |
| 2025-10-03 | 0.2     | Story moved to InProgress for implementation   | James  |
| 2025-10-03 | 0.3     | Implemented pipeline module, CLI delegation, tests, docs updates | James |
| 2025-10-04 | 1.0     | QA gate passed; story marked Done and documentation synced | James |


## Dev Agent Record
### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- `PYTHONPATH=src pytest tests/unit/fancyrag/cli/test_kg_build_main.py tests/unit/fancyrag/kg/test_pipeline.py`
- `LOCAL_STACK_SKIP_DOCKER_CHECK=1 PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs`
- `PYTHONPATH=stubs:src python3 scripts/kg_build.py --help`

### Completion Notes List
- Extracted orchestration, QA, and dependency validation logic into `fancyrag.kg.pipeline`, exposing a typed `PipelineOptions` + `run_pipeline()` interface.
- Trimmed `fancyrag.cli.kg_build_main` to argument parsing and delegation, preserving CLI behaviour and help surface.
- Added dedicated unit coverage for both CLI and pipeline layers and refreshed docs to register the new module boundaries.

### File List
- `docs/architecture/projects/fancyrag-kg-build-refactor.md`
- `docs/architecture/source-tree.md`
- `docs/stories/4.2.kg-pipeline.md`
- `src/fancyrag/cli/kg_build_main.py`
- `src/fancyrag/kg/__init__.py`
- `src/fancyrag/kg/pipeline.py`
- `tests/unit/fancyrag/cli/test_kg_build_main.py`
- `tests/unit/fancyrag/kg/test_pipeline.py`

## QA Results
- Gate: PASS → docs/qa/gates/4.2-kg-pipeline.yml
