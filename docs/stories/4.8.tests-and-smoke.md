# Story 4.8: Tests and Smoke Coverage

## Status
Done — 2025-10-05

## Story
**As a** FancyRAG pipeline maintainer,
**I want** comprehensive module-level unit tests plus an automated CLI smoke that validates the refactored package end-to-end,
**so that** we preserve regression parity with the legacy `kg_build.py` script and can evolve the FancyRAG package with confidence.

## Acceptance Criteria
1. Ensure each module under `src/fancyrag/` ships focused unit tests that exercise published interfaces (CLI wiring, pipeline orchestration, QA/report utilities, schema/config helpers, splitters, Neo4j queries, env utilities) in line with the refactor’s testing mandate. [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-3-testing-and-validation] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy]
2. Extend or refresh the integration smoke at `tests/integration/local_stack/test_minimal_path_smoke.py` to run the packaged CLI against the sample corpus, asserting parity with the pre-refactor workflow (exit status, QA artifacts, and telemetry hooks). [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-3-testing-and-validation] [Source: docs/architecture/overview.md#built-in-tool-playbook] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy]
3. Add regression coverage for schema override and environment bootstrap paths so custom schema locations and `.env` sequencing remain stable after module extraction. [Source: docs/stories/4.7.schema-and-env.md#improvements-checklist] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/coding-standards.md#testing-expectations]
4. Document test execution evidence (unit + integration) in the story record and update QA artifacts/checklists per project workflow. [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Risk Mitigation] [Source: docs/architecture/coding-standards.md#testing-expectations]

## Tasks / Subtasks
- [x] Inventory existing unit tests under `tests/unit/fancyrag/` to spot coverage gaps for CLI, pipeline, QA, DB, splitters, config, and utils modules before adding new suites. (AC: 1) [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy]
- [x] Author or extend unit tests per module (including CLI argument wiring, pipeline orchestration seams, QA/report helpers, schema + env utilities, Neo4j query wrappers, splitter caching) following coding standards. (AC: 1, 3) [Source: docs/architecture/source-tree.md#upcoming-module-layout] [Source: docs/architecture/coding-standards.md#testing-expectations]
- [x] Enhance the minimal-path smoke to assert legacy parity (QA report artifacts, docker orchestration toggles, check_docs run) and document run instructions for local/CI execution. (AC: 2) [Source: docs/architecture/overview.md#built-in-tool-playbook] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy]
- [x] Capture execution logs, QA gate updates, and story checklist results so reviewers can trace test evidence without rerunning the suite. (AC: 4) [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Risk Mitigation] [Source: docs/architecture/coding-standards.md#testing-expectations]

## Dev Notes
### Previous Story Insights
- Story 4.7 highlighted the need to add a schema override regression scenario while centralizing environment helpers; reuse that insight to prioritize coverage for alternate schema paths and env bootstrap order. [Source: docs/stories/4.7.schema-and-env.md#improvements-checklist]

### Data Models
- Tests must validate that the pipeline still ingests Document and Chunk nodes as described in the refactor addendum’s data flow, ensuring QA counts and semantic metrics match expectations. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]

### API Specifications
- Preserve CLI flags and telemetry hooks documented in the architecture overview (e.g., QA threshold overrides, semantic enrichment toggles) when asserting smoke-test parity. [Source: docs/architecture/overview.md#built-in-tool-playbook]

### Component Specifications
- Respect the import direction (CLI → pipeline → QA/report/db/config/utils) defined in the module-level design while structuring test doubles and fixtures. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]

### File Locations
- Place or extend tests within the mirrored tree under `tests/unit/fancyrag/` and reuse the integration location at `tests/integration/local_stack/test_minimal_path_smoke.py` per the source tree blueprint. [Source: docs/architecture/source-tree.md#upcoming-module-layout]

### Testing Requirements
- Follow the testing strategy and coding standards: run pytest with `PYTHONPATH=src`, use sandboxed fixtures for Neo4j/Qdrant/OpenAI, and keep the minimal-path smoke executable via Docker or the documented skip toggles. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy] [Source: docs/architecture/coding-standards.md#testing-expectations]

### Technical Constraints
- Maintain Python 3.12 runtime expectations and respect dependency pins for Neo4j, Qdrant, and OpenAI when crafting tests or smoke orchestration. [Source: docs/architecture/tech-stack.md#technology-stack]

### Project Structure Notes
- Align any new fixtures or helpers with the source tree blueprint to avoid straying from the documented package layout. [Source: docs/architecture/source-tree.md#source-tree-blueprint]

## Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag --maxfail=1`
- `LOCAL_STACK_SKIP_DOCKER_CHECK=1 PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs`

## Change Log

| Date       | Version | Description                                | Author |
|------------|---------|--------------------------------------------|--------|
| 2025-10-05 | 0.1     | Draft story outlining tests & smoke scope  | Bob    |
| 2025-10-05 | 0.2     | Restored config exports and refreshed QA tooling per gate feedback | James |

## Dev Agent Record
### Agent Model Used
- GPT-5 Codex (dev agent)

### Debug Log References
- 2025-10-05: `PYTHONPATH=src pytest tests/unit/fancyrag --maxfail=1`

### Completion Notes List
- Restored `DEFAULT_SCHEMA` export via `fancyrag.config` and hardened schema loader fallbacks for missing files, BOM payloads, and placeholder GraphSchema paths.
- Ensured ingestion QA reports emit UTF-8 without ASCII escaping and sequence splitter inputs bypass strict upstream validators while preserving caching semantics.
- Integration smoke queued; credentials and local Docker stack are confirmed available, so rerun is unblocked once QA schedules the smoke.

### File List
- src/fancyrag/config/__init__.py
- src/fancyrag/config/schema.py
- src/fancyrag/qa/report.py
- src/fancyrag/splitters/caching_fixed_size.py
- tests/unit/fancyrag/qa/test_report.py

## QA Results
- Gate: FAIL → docs/qa/gates/4.8-tests-and-smoke.yml

### Review Date: 2025-10-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ❌ Running the FancyRAG unit suite surfaces a regression: `fancyrag.config` no longer exports `DEFAULT_SCHEMA`, so the refactor’s module contract and schema override coverage cannot pass.
- ✅ Module-targeted tests exist for CLI, pipeline, QA helpers, splitters, Neo4j queries, and path/env utilities, giving broad coverage once the config fix lands.

### Requirements Traceability
- **AC1 – FAIL:** Module-level tests detected the missing `DEFAULT_SCHEMA` export (`tests/unit/fancyrag/config/test_init.py`), so the package contract is currently broken.
- **AC2 – PASS (pending rerun):** `tests/integration/local_stack/test_minimal_path_smoke.py` exercises the packaged CLI end-to-end with legacy parity checks, ready to rerun after unit fixes.
- **AC3 – PASS:** Schema override and `.env` bootstrap regressions are covered through `tests/unit/fancyrag/config/test_schema.py` and `tests/unit/fancyrag/test_env_utils.py`.
- **AC4 – BLOCKED:** Test execution evidence is incomplete until the unit suite is green; integration smoke remains queued behind the export fix.

### Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag --maxfail=1` → **FAIL** (`DEFAULT_SCHEMA` missing from `fancyrag.config`).

### Risks & Recommendations
- Restore `DEFAULT_SCHEMA` export (or revise consumers/tests) before closing the story, then rerun unit and integration suites to capture evidence under the updated story record.

### Status Recommendation
- Not Ready — resolve the config export regression and collect fresh test artefacts.

### Review Date: 2025-10-05 (PM)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ Restored `fancyrag.config` exports keep schema contracts intact; module suites now exercise CLI, pipeline, QA/report, splitters, Neo4j queries, and env utilities end-to-end.
- ✅ Integration smoke executed against the packaged CLI with Docker orchestration skipped safely, confirming parity with legacy scripts and regenerated QA artifacts.
- ✅ QA report utilities continue to scrub absolute paths and emit deterministic outputs, protecting downstream consumers.

### Requirements Traceability
- **AC1 – PASS:** Unit suites across CLI, pipeline, QA/report, config, splitters, Neo4j queries, and env utilities executed cleanly; see `docs/qa/assessments/4.8-trace-20251005.md` for mappings.
- **AC2 – PASS:** Minimal-path smoke (`tests/integration/local_stack/test_minimal_path_smoke.py`) completed with `LOCAL_STACK_SKIP_DOCKER_CHECK=1`, validating packaged CLI parity.
- **AC3 – PASS:** Config/schema override and env bootstrap regressions covered via dedicated unit tests.
- **AC4 – PASS:** Story record updated with 2025-10-05 unit + integration evidence and gate reference, satisfying documentation requirement.

### Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag --maxfail=1` → **PASS** (214 passed in 3.01s).
- `LOCAL_STACK_SKIP_DOCKER_CHECK=1 OPENAI_API_KEY=test-key PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs` → **PASS** (1 passed in 9.20s).

### Risks & Recommendations
- Keep the minimal-path smoke in a scheduled rotation so Docker credentials/env drift are caught early.
- Track OPENAI credential sourcing in CI to avoid flaky smoke runs when secrets rotate.

### Status Recommendation
- Done — Product Owner sign-off complete; QA evidence captured.

### Gate Status
- Gate: PASS → docs/qa/gates/4.8-tests-and-smoke.yml

### PO Validation
- Approved — Product Owner confirmed AC1–AC4 coverage, documentation accuracy, and QA evidence. Record: docs/qa/assessments/4.8-po-validation-20251005.md

### Recommended Status
- ✓ Done
