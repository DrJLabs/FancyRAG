# Story 4.7: Schema and Environment Utilities

## Status
Done — 2025-10-05

## Story
**As a** FancyRAG pipeline maintainer,
**I want** schema loading and environment bootstrap helpers extracted into dedicated modules under the FancyRAG package,
**so that** ingestion runs share validated schema definitions and consistent environment handling across CLI and automation guardrails.

## Acceptance Criteria
1. Create `src/fancyrag/config/schema.py` to own default schema discovery, loading, and validation, relocating the logic currently embedded in `src/fancyrag/kg/pipeline.py` while preserving guardrails for the packaged JSON schema and typed `GraphSchema` output. [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-1-kg_buildpy-monolith-decomposition] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: src/fancyrag/kg/pipeline.py]
2. Expose a typed schema interface (e.g., `load_default_schema`, `resolve_schema_path`) from the new module and update pipeline/CLI call sites to import it without altering CLI → pipeline → config layering or schema fallback semantics. [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Stories] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/source-tree.md#Upcoming Module Layout]
3. Consolidate environment helpers in `src/fancyrag/utils/env.py` so that pipeline, CLI, and supporting scripts call shared utilities for `.env` discovery, required variable enforcement, and bootstrap sequencing (including loading before Neo4j/OpenAI configuration). [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-2-repository-restructuring] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/architecture/overview.md#Built-In Tool Playbook]
4. Refresh automated coverage to exercise the schema module and environment helpers (unit tests plus targeted pipeline/CLI integration paths) in line with coding standards, ensuring fixtures and smoke tests load the shared helpers instead of ad-hoc env handling. [Source: docs/architecture/coding-standards.md#Testing Expectations] [Source: tests/unit/fancyrag/test_env_utils.py] [Source: tests/unit/scripts/test_kg_build.py]
5. Update documentation (epic shard, architecture source tree, refactor addendum) to mark schema/config utilities delivered and note the centralized environment helpers, keeping project structure diagrams accurate. [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Stories]

## Tasks / Subtasks
- [x] Catalogue existing schema loading, default path constants, and environment lookups inside `src/fancyrag/kg/pipeline.py`, `scripts/config/kg_schema.json`, and helper usage in scripts/tests to confirm extraction scope. (AC: 1, 3) [Source: src/fancyrag/kg/pipeline.py] [Source: scripts/config/kg_schema.json]
- [x] Implement `src/fancyrag/config/schema.py` with loader/validator helpers (default + override path support) and expose convenience exports via `src/fancyrag/config/__init__.py`. (AC: 1, 2) [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-1-kg_buildpy-monolith-decomposition] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
- [x] Refactor pipeline, CLI entry points, and any schema consumers to import the new module, ensuring CLI → pipeline → config boundaries remain intact and schema fallbacks stay identical. (AC: 2) [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/source-tree.md#Upcoming Module Layout]
- [x] Extend `src/fancyrag/utils/env.py` if needed (e.g., explicit bootstrap helper) and switch remaining scripts/tests to rely on the shared utilities for `.env` loading and credential enforcement. (AC: 3) [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-2-repository-restructuring] [Source: docs/architecture/overview.md#Built-In Tool Playbook]
- [x] Add or update unit tests under `tests/unit/fancyrag/config/` and refresh existing env/pipeline/CLI suites plus the minimal path smoke to cover the refactor. (AC: 4) [Source: docs/architecture/coding-standards.md#Testing Expectations] [Source: tests/integration/local_stack/test_minimal_path_smoke.py]
- [x] Refresh epic and architecture documentation shards so schema/config utilities and env helpers appear as delivered, mirroring the final module layout. (AC: 5) [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/architecture/source-tree.md#Upcoming Module Layout]

## Dev Notes
### Previous Story Insights
- Story 4.6 highlighted that future schema work (Story 4.7 onward) must avoid duplicating Cypher helpers and keep DB abstractions as the single source of truth. [Source: docs/stories/4.6.neo4j-queries.md#Open Risks & Follow-Ups]

### Data Models
- The KG pipeline continues to load JSON schema definitions from `scripts/config/kg_schema.json`, validating into `GraphSchema` objects before ingestion; the new module must preserve this contract. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: scripts/config/kg_schema.json]

### API Specifications
- Pipeline execution loads the schema prior to chunking and Neo4j writes; CLI invocation should remain a thin wrapper that delegates schema resolution to the config module without exposing additional flags by default. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/overview.md#Built-In Tool Playbook]

### Component Specifications
- Maintain the documented module boundaries: CLI → pipeline → config/db/utils, with schema utilities isolated under `src/fancyrag/config/` and environment helpers under `src/fancyrag/utils/`. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/architecture/source-tree.md#Upcoming Module Layout]

### File Locations
- Add `src/fancyrag/config/__init__.py` and `src/fancyrag/config/schema.py`, mirror tests under `tests/unit/fancyrag/config/`, and update package exports only within the FancyRAG namespace. [Source: docs/architecture/source-tree.md#Upcoming Module Layout]

### Testing Requirements
- Follow the testing expectations: targeted unit coverage for config/env utilities plus refreshed pipeline/CLI suites and the minimal path smoke before sign-off. [Source: docs/architecture/coding-standards.md#Testing Expectations] [Source: tests/integration/local_stack/test_minimal_path_smoke.py]

### Technical Constraints
- Continue targeting Python 3.12 with pinned Neo4j/OpenAI dependencies; ensure environment helpers respect secret-handling guidance and avoid logging credentials. [Source: docs/architecture/tech-stack.md#Technology Stack] [Source: docs/architecture/coding-standards.md#Critical Rules]

### Project Structure Notes
- The source tree blueprint still tracks `config/schema.py` + `utils/env.py` as pending; ensure the new package structure matches the documented layout and update the shard once delivered. [Source: docs/architecture/source-tree.md#Upcoming Module Layout]

## Testing
- [x] `PYTHONPATH=src pytest tests/unit/fancyrag/test_env_utils.py tests/unit/fancyrag/config/test_schema.py` (executed via `PYTHONPATH=src:. pytest tests/unit/fancyrag/config/test_schema.py tests/unit/fancyrag/test_env_utils.py tests/unit/scripts/test_export_to_qdrant.py tests/unit/scripts/test_create_vector_index.py tests/unit/scripts/test_ask_qdrant.py tests/unit/fancyrag/kg/test_pipeline.py`) [Source: docs/architecture/coding-standards.md#Testing Expectations]
- [x] `PYTHONPATH=src pytest tests/unit/fancyrag/kg/test_pipeline.py tests/unit/scripts/test_kg_build.py` (executed via `PYTHONPATH=src:. pytest tests/unit/scripts/test_kg_build.py`) [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]
- [x] `LOCAL_STACK_SKIP_DOCKER_CHECK=1 PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs` [Source: docs/architecture/overview.md#Built-In Tool Playbook]

## Change Log

| Date       | Version | Description                                           | Author |
|------------|---------|-------------------------------------------------------|--------|
| 2025-10-04 | 0.1     | Draft story outlining schema/config and env utilities | Bob    |
| 2025-10-05 | 0.9     | Implemented shared schema/env modules, updated docs & unit suites | Codex |

## Dev Agent Record
### Agent Model Used
- GPT-5 Codex (dev persona)

### Debug Log References
- `PYTHONPATH=src:. pytest tests/unit/fancyrag/config/test_schema.py tests/unit/fancyrag/test_env_utils.py tests/unit/scripts/test_export_to_qdrant.py tests/unit/scripts/test_create_vector_index.py tests/unit/scripts/test_ask_qdrant.py tests/unit/fancyrag/kg/test_pipeline.py`
- `PYTHONPATH=src:. pytest tests/unit/scripts/test_kg_build.py`

### Completion Notes List
- Added `fancyrag.config.schema` module with schema discovery helpers, refactored pipeline and scripts to consume it, centralized environment bootstrap through `fancyrag.utils.env.bootstrap_environment`, and refreshed CLI/doc shards.
- Extended unit coverage for config/env utilities and script entry points, and executed the minimal-path integration smoke using `.env` credentials (2025-10-05).

### File List
- `src/fancyrag/config/schema.py`
- `src/fancyrag/config/__init__.py`
- `src/fancyrag/kg/pipeline.py`
- `src/fancyrag/utils/env.py`
- `src/fancyrag/utils/__init__.py`
- `scripts/ask_qdrant.py`
- `scripts/export_to_qdrant.py`
- `scripts/create_vector_index.py`
- `src/fancyrag/cli/kg_build_main.py`
- `tests/unit/fancyrag/config/test_schema.py`
- `tests/unit/fancyrag/test_env_utils.py`
- `tests/unit/scripts/test_export_to_qdrant.py`
- `tests/unit/scripts/test_create_vector_index.py`
- `tests/unit/scripts/test_ask_qdrant.py`
- `tests/unit/scripts/test_kg_build.py`
- `tests/integration/local_stack/test_minimal_path_smoke.py`
- `docs/architecture/source-tree.md`
- `docs/architecture/projects/fancyrag-kg-build-refactor.md`
- `docs/stories/4.7.schema-and-env.md`

## QA Results
- Done — QA gate PASS with unit + integration coverage; documentation and PO validation complete.

### Review Date: 2025-10-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Schema/env extraction matches documented layering; no regressions observed in pipeline or CLI wiring.
- Documentation shards updated alongside code, keeping architecture sources in sync.

### Refactoring Performed
- None — review focused on verification of delivered modules and documentation.

### Compliance Check
- Coding Standards: ✓ — naming, error handling, and testing approach adhere to `docs/architecture/coding-standards.md`.
- Project Structure: ✓ — new modules match `docs/architecture/source-tree.md` layout.
- Testing Strategy: ✓ — targeted unit suites plus minimal-path smoke executed 2025-10-05.
- All ACs Met: ✓ — AC1–AC5 satisfied with corresponding tests and documentation evidence.

### Improvements Checklist
- [ ] Update story testing checklist to tick the executed minimal-path smoke (`tests/integration/local_stack/test_minimal_path_smoke.py`).
- [ ] Add schema override regression scenario in Story 4.8 to cover custom path resolution.
- [ ] Keep minimal-path smoke in weekly rotation (`LOCAL_STACK_SKIP_DOCKER_CHECK=1`).

### Security Review
- No new security concerns; `bootstrap_environment` enforces required secrets and continues to fail closed when credentials are absent.

### Performance Considerations
- Helpers perform single-shot filesystem reads and cached lookups; no hot-path performance impact detected.

### Files Modified During Review
- docs/qa/assessments/4.7-risk-20251005.md
- docs/qa/assessments/4.7-test-design-20251005.md
- docs/qa/assessments/4.7-trace-20251005.md
- docs/qa/assessments/4.7-nfr-20251005.md
- docs/qa/assessments/4.7-review-20251005.md
- docs/qa/gates/4.7-schema-and-env.yml
- docs/stories/4.7.schema-and-env.md (QA Results entry only)

### Gate Status
- Gate: PASS → docs/qa/gates/4.7-schema-and-env.yml
- Risk profile: docs/qa/assessments/4.7-risk-20251005.md
- NFR assessment: docs/qa/assessments/4.7-nfr-20251005.md

### PO Validation
- Approved — Product Owner confirmed AC1–AC5 coverage, documentation accuracy, and regression evidence. Record: docs/qa/assessments/4.7-po-validation-20251005.md

### Recommended Status
- ✓ Done
