# Story 4.1: CLI Bridge for FancyRAG kg_build

## Status
Review

## Story
**As a** FancyRAG CLI maintainer,
**I want** to extract the kg_build command-line wiring into a dedicated module,
**so that** the ingestion workflow has a reusable entry point aligned with the new package structure.

## Acceptance Criteria
1. Create `src/fancyrag/cli/kg_build_main.py` that encapsulates the current argparse configuration and CLI orchestration from `scripts/kg_build.py`, leaving no parsing logic behind in the script. [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-1-kg_buildpy-monolith-decomposition] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
2. Update `scripts/kg_build.py` to import and invoke the packaged entry point so that running `python scripts/kg_build.py` retains all existing flags, logging semantics, and operator-facing behaviour. [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-2-repository-restructuring] [Source: docs/architecture/overview.md#built-in-tool-playbook]
3. Preserve environment loading, shared OpenAI client wiring, semantic enrichment toggles, and QA threshold defaults introduced in Story 3.5 while delegating control to the new module. [Source: docs/stories/3.5.semantic-enrichment-ingestion.md#Dev Notes] [Source: scripts/kg_build.py]

## Tasks / Subtasks
- [x] Catalogue existing CLI options, environment helpers, and semantic/QA toggles in `scripts/kg_build.py` to confirm the parity requirements before refactoring. (AC: 1, 3) [Source: scripts/kg_build.py] [Source: docs/architecture/overview.md#built-in-tool-playbook]
- [x] Capture baseline and post-refactor `python scripts/kg_build.py --help` output (store under `artifacts/cli/`) to demonstrate flag/default parity before delegating to the new module. (AC: 1, 2) [Source: scripts/kg_build.py] [Source: docs/qa/assessments/4.1-risk-20251003.md]
- [x] Implement `src/fancyrag/cli/kg_build_main.py` with a `main(argv: Sequence[str] | None = None) -> int` entry point that builds the argument parser, wires env/config helpers, and executes the pipeline without side effects on import. (AC: 1, 3) [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/architecture/source-tree.md#upcoming-module-layout]
- [x] Refactor `scripts/kg_build.py` to defer to the packaged `main()` while keeping the executable shebang, docstring, and import guard (`if __name__ == "__main__"`). (AC: 2) [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-2-repository-restructuring]
- [x] Add or update unit tests under `tests/unit/fancyrag/cli/` to exercise argument defaults, semantic toggle wiring, and delegation, and adjust existing kg_build tests to import the new entry point. (AC: 3) [Source: docs/architecture/coding-standards.md#testing-expectations] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy]
- [x] Regenerate documentation snippets or references (e.g., source tree shard) if new module paths need to be reflected after the refactor. (AC: 2) [Source: docs/architecture/source-tree.md#upcoming-module-layout]

## Dev Notes
### Previous Story Insights
- Story 3.5 added semantic enrichment flags, telemetry thresholds, and optional extractor wiring that must survive the CLI extraction. [Source: docs/stories/3.5.semantic-enrichment-ingestion.md#Dev Notes]

### Data Models
- No new schemas are introduced; CLI delegation must continue to target the existing Document, Chunk, and semantic enrichment nodes managed by downstream modules. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]

### API Specifications
- The new CLI module should invoke the same pipeline orchestration entry point, ensuring the script continues to call `SimpleKGPipeline` and related helpers via the packaged `kg` module boundaries. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]

### Component Specifications
- Module boundaries follow the FancyRAG package layout, with CLI logic isolated under `src/fancyrag/cli/` and pipeline responsibilities delegated downstream. [Source: docs/architecture/source-tree.md#upcoming-module-layout]

### File Locations
- Place the new entry point at `src/fancyrag/cli/kg_build_main.py`, keep the script at `scripts/kg_build.py`, and ensure tests mirror the `src/fancyrag/cli/` path. [Source: docs/architecture/source-tree.md#upcoming-module-layout]

### Testing Requirements
- Provide unit coverage for the CLI module (argument parsing, delegation) and preserve integration smoke coverage that exercises the full KG build via the script. [Source: docs/architecture/coding-standards.md#testing-expectations] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy]

### Technical Constraints
- Continue to target Python 3.12 with the documented dependency stack (`neo4j-graphrag`, `structlog`, Qdrant, OpenAI) and adhere to CLI logging, retry, and env-loading conventions. [Source: docs/architecture/tech-stack.md#technology-stack] [Source: docs/architecture/coding-standards.md#core-standards]

### Environment Variables
- Ensure the CLI continues to read GraphRAG configuration from the shared `.env` surface (`NEO4J_URI`, `NEO4J_USERNAME`, `NEO4J_PASSWORD`, `QDRANT_URL`, `OPENAI_API_KEY`) before executing the pipeline. [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#story-manager-handoff]

### Project Structure Notes
- Proposed module extraction aligns with the documented FancyRAG package plan and introduces no conflicts with the current source tree. [Source: docs/architecture/source-tree.md#upcoming-module-layout]

### QA & Risk References
- Follow the mitigations and evidence expectations captured in the Story 4.1 risk profile and test design to satisfy the QA gate (`docs/qa/assessments/4.1-risk-20251003.md`, `docs/qa/assessments/4.1-test-design-20251003.md`).

## Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag/cli/test_kg_build_main.py` [Source: docs/architecture/coding-standards.md#testing-expectations]
- `PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py` [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy]
- `PYTHONPATH=src python scripts/kg_build.py --help` (baseline and post-refactor) [Source: docs/qa/assessments/4.1-test-design-20251003.md]

## Change Log

| Date       | Version | Description                            | Author |
|------------|---------|----------------------------------------|--------|
| 2025-10-03 | 0.1     | Draft story for CLI module extraction  | Bob    |
| 2025-10-03 | 0.2     | Added QA references, CLI help parity task, testing updates | Bob    |
| 2025-10-03 | 1.0     | Implemented CLI extraction, wrapper delegation, tests, and docs | James |

## Dev Agent Record
### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- `PYTHONPATH=stubs:src python3 scripts/kg_build.py --help > artifacts/cli/kg_build_help_before.txt`
- `PYTHONPATH=stubs:src python3 scripts/kg_build.py --help > artifacts/cli/kg_build_help_after.txt`
- `PYTHONPATH=stubs:src pytest tests/unit/fancyrag/cli/test_kg_build_main.py`
- `PYTHONPATH=stubs:src pytest tests/unit/scripts/test_kg_build.py`

### Completion Notes List
- Promoted the legacy CLI implementation into `src/fancyrag/cli/kg_build_main.py` and reduced `scripts/kg_build.py` to a thin wrapper delegating to the packaged entrypoint.
- Captured pre- and post-refactor `--help` snapshots in `artifacts/cli/` to demonstrate argument parity.
- Added targeted unit coverage under `tests/unit/fancyrag/cli/` for parser defaults, env validation, and wrapper delegation; updated existing kg_build tests to import the packaged module.
- Refreshed `docs/architecture/source-tree.md` to register the new module layout and note the completed CLI extraction milestone.

### File List
- artifacts/cli/kg_build_help_after.txt
- artifacts/cli/kg_build_help_before.txt
- docs/architecture/source-tree.md
- docs/stories/4.1.cli-kg-build-main.md
- scripts/kg_build.py
- src/fancyrag/cli/__init__.py
- src/fancyrag/cli/kg_build_main.py
- tests/unit/fancyrag/cli/test_kg_build_main.py
- tests/unit/scripts/test_kg_build.py

## QA Results
- _To be completed by QA agent upon review_
