# Story 2.4: Docker Compose Stack for Neo4j + Qdrant

## Status
Draft

## Story
**As a** GraphRAG operator,
**I want** a project-owned Docker Compose stack for Neo4j 5.26 with APOC Core and Qdrant latest that honours shared environment settings,
**so that** I can stand up the local minimal path without touching managed infrastructure.

## Acceptance Criteria
1. Add `docker-compose.neo4j-qdrant.yml` at the repository root provisioning Neo4j 5.26 (APOC Core enabled) and Qdrant ≥ 1.8 with persistent volumes under `./.data/neo4j` and `./.data/qdrant`, exposing ports `7474/7687` and `6333`, and consuming credentials via `.env` (`NEO4J_URI`, `NEO4J_USERNAME`, `NEO4J_PASSWORD`, `QDRANT_URL`, `QDRANT_API_KEY`). [Source: docs/bmad/focused-epics/local-stack/epic.md#stories] [Source: docs/architecture/overview.md#environment-configuration] [Source: docs/architecture/tech-stack.md#technology-stack]
2. Compose services include documented health checks, APOC plugin mounts, and restart policies so that reruns of `docker compose up` remain idempotent and align with the minimal-path workflow’s expectations for `SimpleKGPipeline`, Qdrant export, and `GraphRAG.search()` scripts. [Source: docs/bmad/focused-epics/local-stack/epic.md#story-manager-handoff] [Source: docs/architecture/overview.md#minimal-path-workflow] [Source: docs/architecture/coding-standards.md#critical-rules]
3. Update documentation (e.g., `docs/architecture/overview.md` and linked operator guides) with runbooks covering boot, teardown, `.env` overrides, and compatibility guidance for promoting the stack to CI, matching logging/retry standards. [Source: docs/bmad/focused-epics/local-stack/epic.md#epic-goal] [Source: docs/architecture/overview.md#environment-configuration] [Source: docs/architecture/coding-standards.md#logging-guidance]
4. Provide automated verification: a CI-safe check (`docker compose config` + lint) and an integration smoke workflow that starts the stack, runs `scripts/create_vector_index.py`, `scripts/kg_build.py`, `scripts/export_to_qdrant.py`, and `scripts/ask_qdrant.py`, then tears down cleanly, ensuring logs remain redacted and exit codes propagate. [Source: docs/bmad/focused-epics/local-stack/epic.md#success-criteria] [Source: docs/architecture/overview.md#minimal-path-workflow] [Source: docs/architecture/coding-standards.md#testing-expectations]

## Tasks / Subtasks
- [ ] Author `docker-compose.neo4j-qdrant.yml` with versioned Neo4j and Qdrant images, persistent volumes, health checks, and `.env`-driven credentials (AC: 1,2). [Source: docs/architecture/source-tree.md#source-tree-blueprint] [Source: docs/architecture/overview.md#environment-configuration]
  - [ ] Enable APOC Core via Neo4j plugins/`apoc.conf`, ensure Bolt/HTTP ports map to documented defaults, and add restart/backoff policies aligned with coding standards (AC: 1,2). [Source: docs/architecture/overview.md#technical-summary] [Source: docs/architecture/coding-standards.md#critical-rules]
- [ ] Document operator workflow updates in `docs/architecture/overview.md` (and ancillary shards) covering boot/teardown commands, `.env` overrides, and CI usage (AC: 3). [Source: docs/architecture/overview.md#environment-configuration]
  - [ ] Cross-link to workspace bootstrap + diagnostics instructions so the sequence reads: bootstrap → `.env` → compose → scripts → teardown (AC: 3). [Source: docs/architecture/overview.md#workspace-verification]
- [ ] Add automation: CLI or Make target for `docker compose config` validation plus CI job stub (AC: 4). [Source: docs/architecture/coding-standards.md#testing-expectations]
  - [ ] Create integration smoke test harness (pytest or shell) that spins up the stack, runs all minimal-path scripts against sample content, cleans volumes, and asserts success logs (AC: 4). [Source: docs/architecture/overview.md#minimal-path-workflow]
- [ ] Update `.env.example` / configuration references to surface required variables, default ports, and override guidance without exposing secrets (AC: 1,3). [Source: docs/architecture/overview.md#environment-configuration]
- [ ] Prepare follow-up checklist for production parity (image tags, APOC config, volume retention) to mitigate drift when mirroring managed environments (AC: 2). [Source: docs/bmad/focused-epics/local-stack/epic.md#risk-mitigation]

## Dev Notes
<!-- override-note -->
Warning: override of incomplete story status executed.
- Timestamp (UTC): 2025-09-28T09:04:04.840579+00:00
- Actor: ScrumMaster
- Prior Story: 2.3
- Prior Status: Draft
- Reason: Kick off Local Stack epic while Story 2.3 is Draft

### Previous Story Insights
- Story 1.3’s diagnostics workflow already validates Neo4j, Qdrant, and OpenAI imports; ensure compose instructions reference running diagnostics after stack boot. [Source: docs/stories/1.3.environment-validation-command.md#dev-notes]
- Story 2.3 (OpenAI shared client) is still Draft; coordinate documentation updates so shared client telemetry references remain accurate once compose smoke tests exercise retrieval. [Source: docs/stories/2.3.openai-shared-client.md#dev-notes]

### Data Models
- Minimal path scripts rely on Neo4j knowledge graph nodes and embeddings produced by `SimpleKGPipeline`; compose volumes must persist graph data between runs. [Source: docs/architecture/overview.md#high-level-components]

### API Specifications
- Compose services expose Neo4j Bolt/HTTP and Qdrant HTTP endpoints consumed by scripts; maintain default URIs (`bolt://localhost:7687`, `http://localhost:6333`) consistent with `.env` guidance. [Source: docs/architecture/overview.md#environment-configuration]

### Component Specifications
- Neo4j container must load APOC Core plugin and accept configuration via mounted `conf/` folder or environmental flags. [Source: docs/bmad/focused-epics/local-stack/epic.md#epic-description]
- Qdrant service should support persistent storage paths for payloads so vector exports remain idempotent. [Source: docs/bmad/focused-epics/local-stack/epic.md#epic-description]

### File Locations
- Place compose file at repository root alongside existing scripts per source tree blueprint. [Source: docs/architecture/source-tree.md#source-tree-blueprint]
- Document updates live in `docs/architecture/overview.md` and reference minimal path steps. [Source: docs/architecture/overview.md#minimal-path-workflow]

### Testing Requirements
- Follow coding standards: use pytest integration suites or scripted harnesses that avoid leaking secrets, reuse structured logging assertions, and tear down containers to keep CI deterministic. [Source: docs/architecture/coding-standards.md#testing-expectations]
- Smoke workflow must execute all minimal path scripts in order while verifying exit codes and redacted logs. [Source: docs/architecture/overview.md#minimal-path-workflow]

### Technical Constraints
- Target Docker Compose 2.x, Neo4j 5.26 with APOC Core, Qdrant ≥ 1.8, and ensure compatibility with Python 3.12 scripts. [Source: docs/architecture/tech-stack.md#technology-stack]
- Scripts invoked by smoke tests must continue to honour `.env` overrides for managed deployments. [Source: docs/architecture/overview.md#environment-configuration]

### Project Structure Notes
- Update `docs/bmad/story-overrides.md` already captures override; ensure future stories reconcile sequencing once Story 2.3 is completed. [Source: docs/bmad/focused-epics/local-stack/epic.md#story-override-workflow]

### Documentation Alignment
- Compose runbook should clarify when to run diagnostics and OpenAI probes to maintain minimal path readiness. [Source: docs/architecture/overview.md#workspace-verification]

### Secrets Handling
- Never bake credentials into compose file; rely on `.env` or Docker secrets while masking logs per coding standards. [Source: docs/architecture/coding-standards.md#critical-rules]

### Monitoring & Observability
- Ensure stack logging integrates with existing structured logging expectations so pipeline telemetry remains consumable once scripts run. [Source: docs/architecture/coding-standards.md#logging-guidance]

## Testing
- Integration smoke test: `PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py` spins up compose stack, runs all minimal path scripts sequentially, validates redacted logs, and tears down containers (AC 4). [Source: docs/architecture/overview.md#minimal-path-workflow]
- CLI lint: add CI step executing `docker compose -f docker-compose.neo4j-qdrant.yml config` to catch syntax drift (AC 4). [Source: docs/architecture/coding-standards.md#testing-expectations]
- Optional local script: provide `scripts/check_local_stack.sh` to wrap config validation and health checks for operators. [Source: docs/architecture/overview.md#environment-configuration]

## Change Log
| Date       | Version | Description                        | Author |
|------------|---------|------------------------------------|--------|
| 2025-09-28 | 0.1     | Initial draft of Story 2.4 created | Bob    |

## Dev Agent Record
### Agent Model Used
- Pending (to be completed during implementation)

### Debug Log References
- Pending

### Completion Notes List
- Pending

### File List
- Pending

## QA Results
### Risk Profile
- Pending

### Test Design
- Pending

### Traceability
- Pending

### NFR Assessment
- Pending

### PO Validation
- Pending

