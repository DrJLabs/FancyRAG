# Story 1.3: Environment Validation Command

## Status
Ready for Review

## Story
**As a** GraphRAG operator,
**I want** a verification command that confirms workspace dependencies are healthy and captures their versions,
**so that** I can audit the environment before running ingestion or retrieval workflows.

## Acceptance Criteria
1. Running the workspace verification command from the repository root loads `neo4j_graphrag`, `neo4j`, `qdrant_client`, `openai`, `structlog`, and `pytest`, exiting non-zero with actionable remediation guidance while masking secrets whenever an import fails. [Source: docs/prd.md#epic-1--environment--workspace] [Source: docs/architecture/coding-standards.md#critical-rules]
2. The command emits a machine-readable report (e.g., `artifacts/environment/versions.json`) that records Python runtime, pinned package versions gathered via `importlib.metadata`, lockfile SHA-256 hash, git SHA, and timestamp for audit traceability. [Source: bmad/focused-epics/environment-workspace/epic.md#risk-mitigation] [Source: docs/prd.md#epic-1--environment--workspace] [Source: https://docs.python.org/3.12/library/importlib.metadata.html#distribution-versions]
3. Documentation under `docs/architecture/overview.md` (or companion workspace diagnostics shard) explains when and how to run the verification after `scripts/bootstrap.sh` and `.env` setup, reinforcing that no secrets are collected. [Source: docs/architecture/overview.md#environment-configuration] [Source: docs/prd.md#epic-1--environment--workspace]
4. Automated tests cover success, import-failure, and report-generation scenarios, gating regressions via `pytest` in CI and asserting the report schema (keys + hash formatting) stays stable. [Source: docs/architecture/coding-standards.md#testing-expectations]

## Tasks / Subtasks
- [x] Implement a Python CLI entry point (e.g., `src/cli/diagnostics.py`) invoked via `python -m cli.diagnostics workspace` that performs the import checks, masks secrets, and surfaces remediation guidance (AC: 1). [Source: docs/prd.md#epic-1--environment--workspace] [Source: docs/architecture/source-tree.md#source-tree-blueprint]
  - [x] Ensure the command logs structured status messages and never echoes credential values (AC: 1). [Source: docs/architecture/coding-standards.md#critical-rules]
  - [x] Use `importlib.metadata.version()` to collect dependency versions and gracefully handle `PackageNotFoundError` so remediation tips stay actionable (AC: 1,2). [Source: https://docs.python.org/3.12/library/importlib.metadata.html#distribution-versions]
- [x] Write the versions report to `artifacts/environment/versions.json`, including Python version, dependency versions, lockfile checksum, git SHA, and execution metadata (AC: 2). [Source: bmad/focused-epics/environment-workspace/epic.md#risk-mitigation]
  - [x] Compute the SHA-256 of `requirements.lock` (or note absence) to detect drift and note provenance fields for future PEP 710 adoption (AC: 2). [Source: bmad/focused-epics/environment-workspace/epic.md#risk-mitigation] [Source: https://packaging.python.org/en/latest/specifications/core-metadata/]
  - [x] Update `scripts/bootstrap.sh` to optionally call the verification command (flag or follow-up message) so operators know the next step (AC: 2,3). [Source: docs/prd.md#epic-1--environment--workspace]
- [x] Extend `docs/architecture/overview.md` with a "Workspace Verification" subsection that links the bootstrap, `.env`, and diagnostics steps (AC: 3). [Source: docs/architecture/overview.md#environment-configuration]
- [x] Add integration tests under `tests/integration/cli/test_environment_diagnostics.py` and supporting unit tests for the reporting helpers, covering success/failure paths and artifact creation (AC: 4). [Source: docs/architecture/coding-standards.md#testing-expectations]
  - [x] Add fixtures/mocks ensuring imports are simulated without hitting external services, following existing sandbox patterns (AC: 4). [Source: docs/architecture/coding-standards.md#testing-expectations]
  - [x] Snapshot the JSON schema (keys, value types, checksum formatting) and validate with unit assertions to prevent regressions (AC: 2,4). [Source: https://packaging.python.org/en/latest/specifications/core-metadata/]

## Dev Notes
### Previous Story Insights
- Story 1.2 directs operators to populate `.env` immediately after bootstrap, so the verification command should reference `.env` readiness in its guidance without reading secrets. [Source: docs/stories/1.2.environment-configuration-template.md#dev-agent-record]

### Workspace Diagnostics Requirements
- Epic expects recorded package versions and import validation to mitigate dependency drift before deeper feature work. [Source: docs/prd.md#epic-1--environment--workspace]
- Risk mitigation calls for an automated sanity check script; ensure failure messaging points back to bootstrap or dependency remediation. [Source: bmad/focused-epics/environment-workspace/epic.md#risk-mitigation]

### Logging & Observability
- Use structured logging (`structlog` or JSON) with operation name, status, and duration to aid auditing. [Source: docs/architecture/coding-standards.md#logging-guidance]
- Mask environment variables and secret-like tokens in all output. [Source: docs/architecture/coding-standards.md#critical-rules]

### Version and Metadata Capture
- Leverage `importlib.metadata.version()` and `packages_distributions()` to gather installed versions and map modules to distributions inside the verification command, handling `PackageNotFoundError` when extras are missing. [Source: research/python-importlib-metadata#distribution-versions]
- Record the Python runtime via `platform.python_version()` and include git metadata to align with audit requirements. [Source: docs/prd.md#epic-1--environment--workspace]

### Project Structure
- Place the new CLI entry within `src/cli/` consistent with the source tree blueprint; create the directory if it does not exist yet. [Source: docs/architecture/source-tree.md#source-tree-blueprint]
- Store generated artifacts under `artifacts/environment/` to avoid polluting repo root and align with telemetry patterns from reviewer tooling. [Source: docs/architecture/source-tree.md#source-tree-blueprint]

### Testing
- Tests should live in `tests/integration/cli/` and `tests/unit/cli/` (create directories if missing) mirroring CLI layout. [Source: docs/architecture/coding-standards.md#testing-expectations]
- Provide mocks for import failures to avoid network calls; rely on temporary directories for artifact assertions. [Source: docs/architecture/coding-standards.md#testing-expectations]
- Validate JSON report contents against an expected key set and ensure checksum strings follow lowercase hex formatting (64 chars) to keep telemetry consistent. [Source: https://packaging.python.org/en/latest/specifications/core-metadata/]

### Technical Constraints
- Target Python 3.12 runtime and pinned dependency versions established in Story 1.1 lockfile. [Source: docs/architecture/tech-stack.md#technology-stack]
- Command must execute within 30 minutes bootstrap window and not modify managed service endpoints. [Source: bmad/focused-epics/environment-workspace/epic.md#epic-goal]

## Testing
- Integration: Execute the verification command inside a temp repository with mocked imports to confirm success path, artifact creation, and structured output.
- Failure: Simulate missing package/import failure to assert non-zero exit, redacted messaging, and actionable remediation guidance.
- Regression: Ensure report schema stays stable by snapshotting expected keys and checksum formatting in tests; assert SHA output matches 64-char hex and versions align with lock entries via `importlib.metadata`. [Source: https://docs.python.org/3.12/library/importlib.metadata.html#distribution-versions]

## Change Log
| Date       | Version | Description                   | Author |
|------------|---------|-------------------------------|--------|
| 2025-09-25 | 0.1     | Initial draft created         | Bob    |
| 2025-09-25 | 1.0     | Diagnostics CLI, reporting, docs, and tests implemented | James  |

## ðŸ”¬ Research & Validation Log (2025-09-25)

- **Researcher:** Dr. Evelyn Reed
- **Active Mode:** solo
- **Primary Artifact:** docs/stories/1.3.environment-validation-command.md
- **Summary:** Validated story scope for workspace diagnostics, added concrete guidance on using Python's `importlib.metadata` for version capture, checksum expectations aligned with PyPA core metadata, and reinforced schema-focused testing to prevent drift.

### Findings & Actions

| Priority | Area            | Recommended Change                                                                 | Owner / Reviewer | Confidence | Mode | Controls | Evidence Location | Sources |
| -------- | --------------- | ---------------------------------------------------------------------------------- | ---------------- | ---------- | ---- | -------- | ----------------- | -------- |
| High     | Version audit   | Explicitly require `importlib.metadata.version()` usage and schema assertions for the diagnostic report. | Dev / QA         | High       | solo | N/A      | docs/stories/1.3.environment-validation-command.md | [Python 3.12 importlib.metadata](https://docs.python.org/3.12/library/importlib.metadata.html) (Accessed 2025-09-25)
| Medium   | Provenance data | Capture lockfile SHA-256 and reference PyPA core metadata expectations for audits. | Dev / QA         | Medium     | solo | N/A      | docs/stories/1.3.environment-validation-command.md | [PyPA Core Metadata Spec v2.4](https://packaging.python.org/en/latest/specifications/core-metadata/) (Accessed 2025-09-25)

### Tooling Guidance

- **FOSS-first Recommendation:** Use Python stdlib `importlib.metadata` + `hashlib` for versioning and checksum capture; no additional dependencies.
- **Paid Option (if required):** None â€“ existing tooling sufficient.
- **Automation / Scripts:** Extend `scripts/bootstrap.sh` follow-up to call `python -m cli.diagnostics workspace --write-report` after installation.

### Risk & Compliance Notes

- **Residual Risks:** Medium â€“ lockfile absence must surface actionable warning without blocking; monitor for dependency rename drift.
- **Compliance / Control Mapping:** Aligns with internal reproducibility guardrails; no external control ID mapping required in solo mode.
- **Monitoring / Observability:** Persist `versions.json` under `artifacts/environment/` for ingestion into telemetry dashboards.
- **Rollback / Contingency:** Operators can rerun bootstrap + diagnostics to regenerate artifact; failure guidance instructs re-installation.

### Follow-Up Tasks

- [x] Confirm `artifacts/` path is gitignored or documented to avoid accidental commits â€” Owner: Dev, Due: 2025-09-27
- [x] Draft sample `versions.json` for documentation to illustrate expected schema â€” Owner: QA, Due: 2025-09-28

### Source Appendix

1. Python Software Foundation. "`importlib.metadata` â€“ Accessing package metadata." (Accessed 2025-09-25).
2. Python Packaging Authority. "Core metadata specifications." (Accessed 2025-09-25).

## Dev Agent Record
### Agent Model Used
GPT-5 Codex (CLI)

### Debug Log References
* `pytest`

### Completion Notes List
* Added `src/cli/diagnostics.py` workspace command with dependency verification, secret redaction, and provenance report generation.
* Updated `scripts/bootstrap.sh` with `--verify` flag, diagnostics reminder, and ensured `.gitignore` covers `artifacts/` outputs.
* Extended `docs/architecture/overview.md` with workspace verification guidance and recorded change log entry.
* Implemented unit (`tests/unit/cli/test_diagnostics.py`) and integration (`tests/integration/cli/test_environment_diagnostics.py`) coverage for success, failure, redaction, schema, and git hygiene scenarios.

### File List
* .gitignore
* docs/architecture/overview.md
* docs/stories/1.3.environment-validation-command.md
* scripts/bootstrap.sh
* src/__init__.py
* src/cli/__init__.py
* src/cli/diagnostics.py
* tests/integration/cli/test_environment_diagnostics.py
* tests/unit/cli/test_diagnostics.py

## QA Results

### Risk Profile
- 2025-09-25: docs/qa/assessments/1.3-risk-20250925.md (risk_summary snippet embedded)

### Test Design
- 2025-09-25: docs/qa/assessments/1.3-test-design-20250925.md (scenarios matrix ready for gate)

### PO Validation
- 2025-09-25: docs/qa/assessments/1.3-po-validation-20250925.md (approved pending dev execution)
