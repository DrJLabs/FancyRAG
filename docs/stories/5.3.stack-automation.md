# Story 5.3: Automate Stack Lifecycle Workflows

## Status
Done — 2025-10-07

## Story
**As an** operations engineer,
**I want** a single automation surface that bootstraps, ingests, validates, and rolls back the stack,
**so that** anyone can run the FancyRAG service workflow reproducibly without hand-crafted command sequences. [Source: docs/prd.md#story-53-automate-stack-lifecycle-workflows]

## Acceptance Criteria
1. Provide a consolidated automation entry point (`make` target or wrapper script) that chains bootstrap, ingestion, export, evaluation, and teardown steps with clear logging. [Source: docs/prd.md#story-53-automate-stack-lifecycle-workflows]
2. Implement guarded rollback/cleanup commands that restore Docker services, Neo4j/Qdrant data, and artifacts when runs fail or are cancelled. [Source: docs/prd.md#story-53-automate-stack-lifecycle-workflows]
3. Wire automation to accept configurable presets (dataset path, chunking profile, telemetry toggle) while defaulting to the smoke dataset. [Source: docs/prd.md#story-53-automate-stack-lifecycle-workflows]
4. Document the workflow in `docs/brownfield-architecture.md` (or successor shard) and update developer onboarding instructions to reference the new command surface. [Source: docs/prd.md#story-53-automate-stack-lifecycle-workflows]
5. Extend integration smoke coverage (e.g., `tests/integration/local_stack/test_minimal_path_smoke.py`) to exercise the automation entry point end-to-end. [Source: docs/prd.md#story-53-automate-stack-lifecycle-workflows]

## Tasks / Subtasks
- [x] Inventory existing automation scripts (`scripts/check_local_stack.sh`, `scripts/kg_build.py`, `scripts/create_vector_index.py`, `scripts/export_to_qdrant.py`) and Docker Compose workflows to map required stages and failure modes before building the unified command surface. (AC: 1, 2) [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow] [Source: docs/architecture/overview.md#built-in-tool-playbook]
- [x] Implement a primary automation entry point (e.g., `Makefile` target plus optional `scripts/service.py`) that orchestrates bootstrap → ingest → export → evaluation → teardown via the pipeline helpers, emitting structured logs per stage. (AC: 1) [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
- [x] Add rollback and cleanup commands that invoke Docker lifecycle scripts and pipeline rollback helpers to restore Neo4j/Qdrant state, including optional volume purges. (AC: 2) [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]
- [x] Expose preset selection (smoke/full/enrichment) through typed settings integrations so automation defaults to the smoke dataset while allowing overrides for CI and local runs. (AC: 3) [Source: docs/brownfield-architecture.md#configuration-presets--contracts] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
- [x] Update developer documentation (`docs/brownfield-architecture.md`, onboarding guides) to describe the new automation surface, rollback expectations, and preset usage, aligning with epic compatibility requirements. (AC: 4) [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow] [Source: docs/bmad/focused-epics/fancyrag-service-hardening/epic.md#compatibility-requirements]
- [x] Extend integration coverage by wiring `tests/integration/local_stack/test_minimal_path_smoke.py` (and CI workflows) to call the new automation entry point, capturing artifacts for regression evidence. (AC: 5) [Source: docs/prd.md#story-53-automate-stack-lifecycle-workflows] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy]

## Dev Notes
### Previous Story Insights
- Story 5.2 centralized settings via `FancyRAGSettings`; automation must reuse the typed loader and close the pending integration smoke coverage flagged there to avoid regressions. [Source: docs/stories/5.2.centralise-typed-settings.md#dev-notes]
- Story 5.1 decomposed the pipeline into injectable helpers, enabling automation to orchestrate phases without direct environment access. [Source: docs/stories/5.1.pipeline-orchestrator.md#dev-notes]

### Data Models
- Automation continues to drive ingestion of `Document` and `Chunk` nodes plus rollback metadata; no new schema surfaces are introduced. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]

### API Specifications
- The automation entry point should compose existing CLI/pipeline surfaces (`scripts/check_local_stack.sh`, `scripts/kg_build.py`, `src/fancyrag/kg/pipeline.py`) while honouring typed settings and structured logging. [Source: docs/architecture/overview.md#built-in-tool-playbook] [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow]

### Component Specifications
- Place orchestration glue under `scripts/` or a dedicated `src/fancyrag/cli/service.py`, reusing pipeline helpers defined in `src/fancyrag/kg/` and rollback utilities from `src/fancyrag/db/neo4j_queries.py`. [Source: docs/architecture/source-tree.md#source-tree-blueprint] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]

### File Locations
- Follow the source tree blueprint so new automation code lives beside existing scripts and CLI modules, with tests mirrored under `tests/integration/cli/` or `tests/integration/local_stack/`. [Source: docs/architecture/source-tree.md#source-tree-blueprint]

### Testing Requirements
- Maintain structured unit coverage per coding standards and extend the minimal-path smoke to call the automation entry point, ensuring CI captures rollback paths and preset overrides. [Source: docs/architecture/coding-standards.md#testing-expectations] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-testing-strategy] [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow]

### Technical Constraints
- Continue targeting Python 3.12 with the pinned GraphRAG stack, reuse typed settings for configuration, and ensure automation logs mask secrets while respecting retry/idempotency guardrails. [Source: docs/architecture/tech-stack.md#technology-stack] [Source: docs/brownfield-architecture.md#orchestrator-decomposition--typed-settings] [Source: docs/architecture/coding-standards.md#critical-rules]

### Project Structure Notes
- No separate unified-structure shard exists; rely on the source tree blueprint and epic compatibility requirements when choosing locations for automation and rollback artifacts. [Source: docs/architecture/source-tree.md#source-tree-blueprint] [Source: docs/bmad/focused-epics/fancyrag-service-hardening/epic.md#compatibility-requirements]

## Testing
- [x] `PYTHONPATH=src pytest tests/unit/fancyrag/cli/test_service_workflow.py -q`
- [x] `PYTHONPATH=src pytest tests/unit/config/test_fancyrag_settings.py -q`
- [x] `PYTHONPATH=src python3 scripts/check_docs.py`
- [x] `PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -q`

## Change Log

| Date       | Version | Description                             | Author |
|------------|---------|-----------------------------------------|--------|
| 2025-10-07 | 0.1     | Draft initial automation story outline   | Bob    |

## Story Draft Checklist

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY — Story provides sufficient context for implementation once scheduled.

## Dev Agent Record
### Agent Model Used
- gpt-5 (Codex CLI default)

### Debug Log References
- artifacts/local_stack/service/*/service_run.json (stage summary)
- tests/unit/fancyrag/cli/test_service_workflow.py (stage sequencing coverage)

### Completion Notes List
- Added `fancyrag.cli.service_workflow` orchestration module with structured stage logging and artifact summaries.
- Introduced Make targets (`service-run`, `service-rollback`, `service-reset`) backed by `scripts/service.py` wrapper.
- Extended `FancyRAGSettings` with `ServiceSettings` presets and environment export (`FANCYRAG_PRESET`, `DATASET_PATH`, telemetry toggles).
- Refreshed integration smoke to call the automation entry point and validate generated artifacts.
- Updated documentation (.env template, README, Quickstart, brownfield architecture addendum) to cover automation workflow and presets.

### File List
- `Makefile`
- `.env.example`
- `scripts/service.py`
- `scripts/check_docs.py`
- `src/config/settings.py`
- `src/fancyrag/cli/service_workflow.py`
- `tests/unit/config/test_fancyrag_settings.py`
- `tests/unit/fancyrag/cli/test_service_workflow.py`
- `tests/integration/local_stack/test_minimal_path_smoke.py`
- `docs/brownfield-architecture.md`
- `docs/graphrag/QUICKSTART.md`
- `docs/stories/5.3.stack-automation.md`

## QA Results
- 2025-10-07 — Unit regression (`tests/unit/fancyrag/cli/test_service_workflow.py`, `tests/unit/config/test_fancyrag_settings.py`) passed locally with `PYTHONPATH=src pytest ... -q`.
- 2025-10-07 — Documentation lint (`PYTHONPATH=src python3 scripts/check_docs.py`) verifies onboarding automation references.
- 2025-10-07 — Integration smoke (`PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -q`) executed successfully in Docker-enabled environment.
- 2025-10-07 — QA traceability matrix refreshed (docs/qa/assessments/5.3-trace-20251007.md); all five ACs now have automated coverage including rollback verification.
- 2025-10-07 — NFR assessment updated (docs/qa/assessments/5.3-nfr-20251007.md); security/performance/reliability all PASS after sanitisation and rollback regressions.
- 2025-10-07 — QA gate set to PASS (docs/qa/gates/5.3-stack-automation.yml) following new rollback and StageFailure redaction tests.
- 2025-10-07 — Product Owner validation recorded (docs/qa/assessments/5.3-po-validation-20251007.md) confirming GO for release.

### Review Date: 2025-10-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

ServiceWorkflow orchestrator matches the architecture stage plan and integration smoke proves bootstrap → ingest → export → evaluation → teardown succeeds end to end (`tests/integration/local_stack/test_minimal_path_smoke.py::test_minimal_path_smoke`). Newly added regression coverage exercises rollback cleanup (`tests/unit/fancyrag/cli/test_service_workflow.py::test_service_rollback_invokes_cleanup`) and ensures StageFailure output is sanitised (`::test_stage_failure_sanitizes_summary`), closing the prior reliability/security gaps while existing unit fixtures continue to validate presets and dataset plumbing.

### Refactoring Performed

- None — review focused on QA artefacts (trace, NFR, gate) only.

### Compliance Check

- Coding Standards: ✓ — Automation keeps structured logging and typed settings per architecture guidance (`src/fancyrag/cli/service_workflow.py:169-218`).
- Project Structure: ✓ — Command wrappers remain under `scripts/` with orchestration isolated in `src/fancyrag/cli/` aligning with `docs/architecture/source-tree.md`.
- Testing Strategy: ✓ — Unit/regression additions cover rollback cleanup and failure sanitisation alongside existing smoke tests.
- All ACs Met: ✓ — AC2 now has automated verification; traceability and NFR artefacts show full coverage.

### Improvements Checklist

- [x] Publish traceability matrix (docs/qa/assessments/5.3-trace-20251007.md)
- [x] Capture NFR assessment (docs/qa/assessments/5.3-nfr-20251007.md)
- [x] Implement regression for `make service-rollback`/`make service-reset` (tests 5.3-UNIT-004, 5.3-INT-001)
- [x] Add StageFailure output redaction guard/test (src/fancyrag/cli/service_workflow.py)

### Security Review

Stage failures now scrub helper output before persisting summaries/logs (`src/fancyrag/cli/service_workflow.py:142-153,468-475`), and regression coverage confirms secrets are masked (`tests/unit/fancyrag/cli/test_service_workflow.py::test_stage_failure_sanitizes_summary`).

### Performance Considerations

Smoke baseline durations (<35s bootstrap→teardown) are documented in `docs/brownfield-architecture.md`, providing a regression threshold for future runs.

### Files Modified During Review

- docs/qa/assessments/5.3-trace-20251007.md
- docs/qa/assessments/5.3-nfr-20251007.md
- docs/qa/assessments/5.3-po-validation-20251007.md
- docs/qa/gates/5.3-stack-automation.yml
- docs/qa/assessments/5.3-risk-20251007.md
- docs/qa/assessments/5.3-test-design-20251007.md
- docs/brownfield-architecture.md
- docs/stories/5.3.stack-automation.md (QA Results entry only)

### Tests Executed

- `PYTHONPATH=src pytest tests/unit/fancyrag/cli/test_service_workflow.py -q`

### Gate Status

Gate: PASS → docs/qa/gates/5.3-stack-automation.yml
Risk profile: docs/qa/assessments/5.3-risk-20251007.md
NFR assessment: docs/qa/assessments/5.3-nfr-20251007.md

### Recommended Status

[x] Ready for Done
[ ] Changes Required
