# Story 2.6: OpenAI Custom API Endpoint Support

## Status
Ready for Merge — 2025-10-04

## Story
**As a** GraphRAG operator,
**I want** to configure the OpenAI client with a custom API base URL while retaining model guardrails and telemetry,
**so that** self-hosted or gateway deployments can reuse the existing pipelines without forking or bypassing safety checks.

## Acceptance Criteria
1. Extend `config.settings.OpenAISettings` to accept an optional `OPENAI_BASE_URL`, validate it as an HTTPS/HTTP URL, log overrides, expose it on the settings dataclass, and update `.env.example` plus architecture docs to describe the knob. [Source: docs/architecture/overview.md#openai-api] [Source: docs/stories/2.3.openai-shared-client.md#Acceptance Criteria]
2. Ensure `cli.openai_client.SharedOpenAIClient` passes the configured base URL to the OpenAI SDK (chat and embeddings), preserves existing retries/telemetry, and masks the host in redacted logs. [Source: src/cli/openai_client.py] [Source: docs/architecture/coding-standards.md#critical-rules]
3. Update all call sites that build the shared client (diagnostics probe, FancyRAG pipeline adapters, `scripts/ask_qdrant.py`) to rely on the enriched settings without behavioural regressions. [Source: docs/stories/2.5.minimal-path-scripts.md#Acceptance Criteria] [Source: src/fancyrag/kg/pipeline.py]
4. Add unit tests covering valid/invalid base URLs, ensure monkeypatched OpenAI clients receive the override, and refresh docs/QA artifacts to record the new configuration control and expected telemetry impact. [Source: docs/qa/assessments/2.3-trace-20250928.md] [Source: docs/architecture/coding-standards.md#testing-expectations]

## Tasks / Subtasks
- [x] Update `OpenAISettings` dataclass/loader to include `api_base_url`, validation helpers, and logging for overrides (AC: 1).
  - [x] Parse `OPENAI_BASE_URL` from env and persist on the settings dataclass.
  - [x] Enforce http/https schema validation with structured logging for overrides and errors.
  - [x] Document the new field within config docstrings and surface it in settings consumers.
- [x] Thread the optional base URL through `SharedOpenAIClient` and all construction paths (AC: 2, 3).
  - [x] Pass `base_url` into the OpenAI SDK client factory with fallback to defaults.
  - [x] Ensure diagnostics probe, FancyRAG pipeline adapters, and `scripts/ask_qdrant.py` request the shared client without duplicating setup.
  - [x] Confirm the sanitizer masks custom hosts in logs/telemetry artifacts.
- [x] Broaden unit coverage for configuration and client integration (AC: 4).
  - [x] Extend `tests/unit/config/test_openai_settings.py` with valid/invalid base URL cases.
  - [x] Verify `tests/unit/cli/test_openai_client.py` propagates the override into the SDK client.
  - [x] Add pipeline/script entry point tests asserting the shared client sees the configured base URL.
- [x] Refresh documentation and operator runbooks (AC: 1, 4).
  - [x] Add `OPENAI_BASE_URL` guidance to `.env.example` and architecture overviews.
  - [x] Update troubleshooting/runbook sections covering OpenAI configuration and telemetry expectations.
  - [x] Capture QA/PO awareness of the new knob within relevant assessment artifacts.

## Testing
- [x] `PYTHONPATH=src pytest tests/unit/config/test_openai_settings.py tests/unit/cli/test_openai_client.py`
- [x] `PYTHONPATH=src pytest tests/unit/scripts/test_ask_qdrant.py::test_embedding_cli_base_url`
- [x] `PYTHONPATH=src pytest tests/unit/fancyrag/kg/test_pipeline.py::test_shared_client_base_url`

## Change Log


| Date       | Version | Description                                   | Author |
|------------|---------|-----------------------------------------------|--------|
| 2025-10-04 | 0.1     | Draft story capturing OpenAI custom API base URL support | Bob    |
| 2025-10-04 | 0.2     | Implemented base URL override, telemetry masking, docs, and tests | James |


## Story Draft Checklist
- [x] Story goal and business context are clear and linked to Epic 2 guardrails.
- [x] Key implementation surfaces and integration points are called out.
- [x] References cite specific architecture shards relevant to this change.
- [x] Story summarises required assumptions and dependencies without external hunts.
- [x] Testing guidance describes suites and scenarios needed for acceptance.

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   |        |
| 2. Technical Implementation Guidance | PASS   |        |
| 3. Reference Effectiveness           | PASS   |        |
| 4. Self-Containment Assessment       | PASS   |        |
| 5. Testing Guidance                  | PASS   |        |

**Final Assessment:** READY — Story is actionable for development once prioritised.

## Dev Notes
- Dependency cleared: Story 4.6 returned to Done on 2025-10-04 after the Neo4j helper module shipped and smoke passed.
- Confirm telemetry sanitiser redacts custom hosts before rolling out to shared environments.

<!-- override-note -->
Warning: override of incomplete story status executed.
- Timestamp (UTC): 2025-10-04T09:13:51.239237+00:00
- Actor: drj
- Prior Story: 4.6
- Prior Status: On Hold — 2025-10-04
- Reason: Prioritising OpenAI custom endpoint support while 4.6 is on hold
- Resolution: 2025-10-04 — Story 4.6 completed; override closed.

## Dev Agent Record
### Agent Model Used
- GPT-5 Codex (CLI)

### Debug Log References
- `PYTHONPATH=src pytest tests/unit/config/test_openai_settings.py tests/unit/cli/test_openai_client.py`
- `PYTHONPATH=src pytest tests/unit/scripts/test_ask_qdrant.py::test_embedding_cli_base_url`
- `PYTHONPATH=src pytest tests/unit/fancyrag/kg/test_pipeline.py::test_shared_client_base_url`

### Completion Notes List
- Added optional `api_base_url` handling to `OpenAISettings.load`, including http/https validation, redacted logging, and docstring updates.
- Passed base URL overrides through `SharedOpenAIClient`, logged masked overrides, and extended the CLI sanitizer to redact configured hosts.
- Extended unit coverage across config, shared client, pipeline, and ask CLI flows to assert override propagation and sanitisation.
- Refreshed `.env.example`, architecture overview, and QA trace documentation to highlight the new configuration control.
- Completed Story DoD checklist with no outstanding items.

### File List
- .env.example
- docs/architecture/overview.md
- docs/qa/assessments/2.3-trace-20250928.md
- docs/stories/2.6.openai-custom-endpoint.md
- src/cli/openai_client.py
- src/cli/sanitizer.py
- src/config/settings.py
- tests/unit/cli/test_openai_client.py
- tests/unit/cli/test_sanitizer.py
- tests/unit/config/test_openai_settings.py
- tests/unit/fancyrag/kg/test_pipeline.py
- tests/unit/scripts/test_ask_qdrant.py
## QA Results

### Review Date: 2025-10-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- PASS – Base URL override flows validated across settings, shared client, sanitizer, diagnostics probe, and docs; logging redaction meets guardrail expectations.
- Verified FancyRAG pipeline regression and diagnostics probe smoke execute using neo4j/pandas stubs; pandas wheel mismatch no longer blocks the suite.

### Refactoring Performed
- None.

### Compliance Check
- Coding Standards: ✓ – Structured logging, sanitization, and tests follow documented conventions.
- Project Structure: ✓ – Config/docs updates remain within established folders; no stray assets detected.
- Testing Strategy: ✓ – Expanded unit suites cover valid/invalid base URLs, diagnostics probe smoke, and call-site propagation; FancyRAG pipeline regression passes via stubs.
- All ACs Met: ✓ – AC1–AC4 satisfied based on code inspection and unit test evidence.

### Improvements Checklist
- [x] Verified log redaction for `OPENAI_BASE_URL` overrides across config, client, and diagnostics pathways.
- [x] Confirmed CLI sanitizer scrubs custom hosts and env values in artifacts.
- [x] Revalidated FancyRAG pipeline regression and diagnostics probe smoke after neo4j/pandas stub harness fix.

### Security Review
- PASS – Custom endpoint handling preserves HTTPS validation, masks hosts in telemetry/logs, and leverages existing sanitizer coverage.

### Performance Considerations
- No changes to request retry/backoff behavior beyond configurable base URL; telemetry remains bounded by existing guardrails.

### Files Modified During Review
- None (review-only).

### Gate Status
Gate: PASS → docs/qa/gates/2.6-openai-custom-endpoint.yml
Risk profile: n/a (not generated for this review)
NFR assessment: n/a (covered inline below)

### Recommended Status
✓ Ready for Done (monitor diagnostics probe smoke to detect override path drift)

### 2025-10-04 QA Follow-up
- Refreshed risk profile monitors only TECH-001 medium risk; see docs/qa/assessments/2.6-risk-20251004.md.
- Traceability now confirms 100% AC coverage including diagnostics probe smoke; matrix at docs/qa/assessments/2.6-trace-20251004.md.
- NFR assessment passes all core four with HTTPS enforcement; report recorded in docs/qa/assessments/2.6-nfr-20251004.md.
- Gate file docs/qa/gates/2.6-openai-custom-endpoint.yml updated with new risk_summary, trace, and nfr_validation blocks.

## PO Review

### Review Date: 2025-10-04

- Confirmed QA gate PASS with quality_score 95 and only TECH-001 (diagnostics drift monitor) outstanding.
- Validated AC1–AC4 via updated trace matrix and diagnostics probe smoke execution.
- Logged follow-up QA backlog item `QA-ENV-20251004` to align credential-loading workflow once OpenAI quota returns.

### Decision

Ready for merge; proceed once diagnostics smoke remains green and monitor QA backlog follow-up.
