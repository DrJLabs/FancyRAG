# Story 4.5: QA Report Module

## Status
Done — 2025-10-04

## Story
**As a** FancyRAG pipeline maintainer,
**I want** the ingestion QA reporting logic extracted into a dedicated module that renders JSON and Markdown artifacts,
**so that** the refactored pipeline keeps reusable, versioned QA outputs aligned with the guardrails.

## Acceptance Criteria
1. Implement `src/fancyrag/qa/report.py` to house the JSON and Markdown renderers currently in the evaluator, preserving sanitized payloads, version metadata, and directory handling so the module meets the refactor module guardrails. [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-1-kg_buildpy-monolith-decomposition] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: src/fancyrag/qa/evaluator.py]
2. Update `IngestionQaEvaluator` to delegate report generation to the new module while keeping the `QaResult` contract (status, summary, versioned paths, anomalies) and threshold enforcement untouched. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: src/fancyrag/qa/evaluator.py] [Source: docs/architecture/overview.md#Built-In Tool Playbook]
3. Ensure `fancyrag.kg.pipeline` and CLI wiring continue to write reports under the configured `qa_report_dir` with version `ingestion-qa-report/v1`, sanitized contents, and unchanged failure semantics when QA gating fails. [Source: src/fancyrag/kg/pipeline.py] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/source-tree.md#Upcoming Module Layout]
4. Add targeted tests for the new report module (JSON payload, Markdown rendering, scrubbed output) and refresh evaluator/pipeline tests to confirm integration paths per the testing strategy and coding standards. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations]
5. Update architecture shards (source tree, module-level design) and Epic 4 documentation to mark the QA report module delivered and keep import direction guidance current. [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Stories]

## Tasks / Subtasks
- [x] Extract the ingestion QA report rendering logic from `fancyrag.qa.evaluator` into `src/fancyrag/qa/report.py`, exposing helpers that accept sanitized payloads and target directories. (AC: 1) [Source: src/fancyrag/qa/evaluator.py] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
- [x] Refactor `IngestionQaEvaluator` to build payloads and invoke the report helpers while maintaining the `QaResult` shape and timing metrics. (AC: 1,2) [Source: src/fancyrag/qa/evaluator.py] [Source: docs/architecture/overview.md#Built-In Tool Playbook]
- [x] Adjust `fancyrag.kg.pipeline` (and any CLI glue) to consume the new report module without changing CLI flags, report paths, or rollback semantics. (AC: 2,3) [Source: src/fancyrag/kg/pipeline.py] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]
- [x] Add pytest coverage for report rendering (JSON + Markdown) and update evaluator/pipeline suites to verify gating still emits versioned artifacts and sanitized payloads. (AC: 4) [Source: docs/architecture/coding-standards.md#Testing Expectations] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy]
- [x] Refresh `docs/architecture/source-tree.md`, `docs/architecture/projects/fancyrag-kg-build-refactor.md`, and Epic 4 notes so documentation reflects the delivered module and passes the docs lint guard. (AC: 5) [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/bmad/focused-epics/kg-build-refactor/epic.md#Stories]

## Dev Notes
### Previous Story Insights
- Story 4.4 isolated QA evaluation into `fancyrag.qa.evaluator`; the new report module must stay within the `fancyrag.qa` package and keep the CLI → pipeline → QA import direction intact. [Source: docs/stories/4.4.qa-evaluator.md#Dev Notes] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#2-high-level-design]
- Evaluator currently writes reports using `ensure_directory` and `scrub_object`; replicating that behaviour through a dedicated module avoids drift when more QA outputs land. [Source: src/fancyrag/qa/evaluator.py]

### Data Models
- QA summaries aggregate Document and Chunk node metrics plus semantic counts emitted by the pipeline; the report helpers must continue to mirror these structures. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow]

### API Specifications
- The CLI exposes `--qa-report-dir` alongside QA threshold flags; the report module must respect these options, keep artifacts versioned as `ingestion-qa-report/v1`, and continue sanitizing payloads through `cli.sanitizer.scrub_object`. [Source: src/fancyrag/kg/pipeline.py] [Source: docs/architecture/overview.md#Built-In Tool Playbook] [Source: src/fancyrag/qa/evaluator.py]

### Component Specifications
- `src/fancyrag/qa/report.py` should provide single-responsibility helpers consumed by the evaluator, aligning with the module layout for the QA package. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]

### File Locations
- Implementation lives in `src/fancyrag/qa/report.py`, tests under `tests/unit/fancyrag/qa/`, and generated artifacts remain beneath the configured `qa_report_dir`. [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: src/fancyrag/qa/evaluator.py]

### Testing Requirements
- Follow the refactor’s testing strategy: add unit tests for report helpers and keep pipeline/evaluator suites plus integration smoke aligned with pytest layout. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations]

### Technical Constraints
- Maintain Python 3.12 compatibility with the pinned Neo4j, Qdrant, and OpenAI dependencies; continue using structured logging and retry guardrails. [Source: docs/architecture/tech-stack.md#Technology Stack] [Source: docs/architecture/coding-standards.md#Core Standards]

### Project Structure Notes
- Updating the report module from “pending” to “delivered” keeps the source tree blueprint synchronized with the live package layout. [Source: docs/architecture/source-tree.md#Upcoming Module Layout]

## Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag/qa/test_report.py`
- `PYTHONPATH=src pytest tests/unit/fancyrag/qa/test_evaluator.py`
- `PYTHONPATH=src pytest tests/unit/fancyrag/kg/test_pipeline.py`
- `PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs`

## Change Log

| Date       | Version | Description                               | Author |
|------------|---------|-------------------------------------------|--------|
| 2025-10-04 | 0.1     | Draft story capturing QA report extraction | Bob    |
| 2025-10-04 | 1.0     | Implementation ready for review             | Codex  |
| 2025-10-04 | 1.1     | QA fixes: restore evaluator helper and relative report paths | Codex |
| 2025-10-04 | 1.2     | Harden QA report paths, sanitisation, and timestamp handling | Codex |
| 2025-10-04 | 1.3     | Reset repo-root cache in utils tests and add external qa_report_dir coverage | Codex |
| 2025-10-04 | 1.4     | PO validation complete; status set to Done | Sarah |

## Dev Agent Record
### Agent Model Used
- GPT-5 Codex (2025-10-04)

### Debug Log References
- `PYTHONPATH=src pytest tests/unit/fancyrag/qa/test_report.py tests/unit/fancyrag/qa/test_evaluator.py`
- `PYTHONPATH=src pytest tests/unit/scripts/test_kg_build.py`
- `PYTHONPATH=src pytest tests/unit/fancyrag/utils/test_paths.py tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir`

### Completion Notes List
- Updated `write_ingestion_report` to emit repo-relative or absolute artefact paths, scrub absolute source paths, and prevent timestamp collisions (`src/fancyrag/qa/report.py`).
- Expanded QA unit coverage to assert sanitisation and collision handling while adjusting evaluator expectations for absolute paths (`tests/unit/fancyrag/qa/test_report.py`, `tests/unit/fancyrag/qa/test_evaluator.py`).
- Verified CLI pipeline integration continues to resolve QA artefacts after the path changes (`tests/unit/scripts/test_kg_build.py`).
- Cleared `resolve_repo_root` cache between tests and codified external `qa_report_dir` regression coverage (`tests/unit/fancyrag/utils/test_paths.py`, `tests/unit/scripts/test_kg_build.py`).

### File List
- src/fancyrag/qa/report.py
- tests/unit/fancyrag/qa/test_report.py
- tests/unit/fancyrag/qa/test_evaluator.py
- docs/stories/4.5.qa-report.md
- tests/unit/fancyrag/utils/test_paths.py
- tests/unit/scripts/test_kg_build.py

## QA Results

### Review Date: 2025-10-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ `write_ingestion_report` cleanly extracts report generation, keeps the evaluator decoupled, and retains JSON/Markdown parity for the happy path (`src/fancyrag/qa/report.py:20-52`, `tests/unit/fancyrag/qa/test_report.py:8-58`).
- ❌ Report metadata is returned relative to the configured `qa_report_dir`; when operators point the directory outside the repo, downstream tooling (e.g. `kg.run` log resolution) can no longer locate the artefacts. Reproduced via a targeted harness stubbing `neo4j` and calling the helper with `/tmp/qa-outside-repo`, which yielded `20251004T120000/quality_report.json` (non-resolvable from the log) (`src/fancyrag/qa/report.py:40-52`, `tests/unit/scripts/test_kg_build.py:360-405`).
- ❌ `_relative_to_repo` falls back to absolute paths for sources outside the repo; the Markdown writer echoes that value verbatim, leaking filesystem details despite scrubbing (`src/fancyrag/utils/paths.py:37-54`, `src/fancyrag/qa/report.py:109-121`).
- ⚠️ Timestamp-based folder naming overwrites artefacts when evaluations occur within the same second; repeated invocations of `write_ingestion_report` with a shared timestamp replaced prior outputs, erasing diagnostic evidence (`src/fancyrag/qa/report.py:40-47`).

### Requirements Traceability
- **AC1** – Module owns JSON/Markdown emitters; base behaviour covered by existing unit tests, but path contract and sanitisation regressions remain for out-of-tree directories (tests 4.5-UNIT-001/002/003 outstanding).
- **AC2** – Evaluator delegates correctly for standard runs, yet continues to return log paths that break when `qa_report_dir` leaves the repo (gap tied to test 4.5-INT-001).
- **AC3** – Pipeline integration persists artefacts under the configured directory for in-repo paths; execution against an external directory fails the resolvability requirement (test 4.5-INT-002 pending).
- **AC4** – New unit coverage exists, but scenarios 4.5-UNIT-002, 4.5-UNIT-003, and 4.5-UNIT-004 from the test design are not yet implemented.
- **AC5** – Architecture shards and epic documents updated to reference the delivered report module (manual doc review).

### Testing
- Manual reproduction of path-contract bug: `PYTHONPATH=src python3` harness with stubbed `neo4j` calling `write_ingestion_report` against `/tmp/qa-outside-repo` (see QA notes for script).
- Manual collision check: repeated `write_ingestion_report` invocation with identical timestamps under `/tmp/qa-collision` overwrote prior reports.
- No automated pytest suites were executed during this review because issues were identified via targeted harnesses.

### Risks & Recommendations
- Address TECH-001 by emitting repo-relative or absolute report paths that remain resolvable for external QA directories; add regression coverage (tests 4.5-UNIT-002, 4.5-INT-002).
- Mitigate DATA-001 by redacting or normalising absolute source paths before Markdown rendering; extend unit coverage (test 4.5-UNIT-003).
- Resolve OPS-001 by making timestamped folders collision-safe and asserting the behaviour with test 4.5-UNIT-004.

### Status Recommendation
- Changes Required — Gate = CONCERNS until path contract, sanitisation, and collision handling land with the outlined tests.

### Review Date: 2025-10-04 (Re-review)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ `write_ingestion_report` now emits repo-relative paths when available and absolute paths for external directories, preventing broken references in operator logs (`src/fancyrag/qa/report.py:21`, `tests/unit/fancyrag/qa/test_report.py:9`).
- ✅ `_scrub_relative_paths` normalises absolute `relative_path` entries to filenames so Markdown/JSON artefacts avoid leaking host paths (`src/fancyrag/qa/report.py:73-101`, `tests/unit/fancyrag/qa/test_report.py:79`).
- ✅ Timestamp collisions are resolved by the suffix loop, preserving prior artefacts during rapid reruns (`src/fancyrag/qa/report.py:29-43`, `tests/unit/fancyrag/qa/test_report.py:108`).
- ❌ `resolve_repo_root` is cached across calls; once the helper runs during report tests, `tests/unit/fancyrag/utils/test_paths.py` can no longer monkeypatch `shutil.which`/`subprocess.run`, causing deterministic failures unless the cache is cleared (`src/fancyrag/utils/paths.py:15-34`, `tests/unit/fancyrag/utils/test_paths.py:52-70`).
- ⚠️ CLI integration scenario 4.5-INT-002 remains manual—no automated coverage exercising `kg.run --qa-report-dir` against an out-of-tree directory was added during this story.

### Requirements Traceability
- **AC1** – PASS via refactored helpers and unit coverage 4.5-UNIT-001/002/003/004 (`tests/unit/fancyrag/qa/test_report.py`).
- **AC2** – PASS; evaluator delegates cleanly while retaining the `QaResult` contract (`src/fancyrag/qa/evaluator.py:263-303`, `tests/unit/fancyrag/qa/test_evaluator.py:22-86`).
- **AC3** – PARTIAL; helper behaviour for external directories verified manually, but automation for pipeline/CLI wiring (test 4.5-INT-002) is still outstanding.
- **AC4** – PARTIAL; unit suite updated, yet integration coverage 4.5-INT-002 is not implemented, leaving a P0 gap.
- **AC5** – PASS; architecture shards and epic documents reference the delivered module (`docs/architecture/source-tree.md:76`, `docs/architecture/projects/fancyrag-kg-build-refactor.md:90`).

### Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag/qa/test_report.py tests/unit/fancyrag/utils/test_paths.py` → `test_report` suite passes; `test_paths` fails twice because the cached `resolve_repo_root()` returns the real repo path after prior invocations, ignoring monkeypatching (see failure log in QA notes).
- Manual harness: `PYTHONPATH=src python3` script invoking `write_ingestion_report` against `/tmp/qa-outside-repo` confirmed absolute return paths without leaking host prefixes.

### Risks & Recommendations
- QA-TEST-001: Clear `resolve_repo_root.cache_clear()` inside `tests/unit/fancyrag/utils/test_paths.py` (or drop caching) so the utils suite remains deterministic after helper calls. Severity = medium.
- QA-COVERAGE-001: Add automated coverage for 4.5-INT-002 by running `kg.run` with an external `--qa-report-dir` to guard against regressions in pipeline wiring. Severity = low.

### Status Recommendation
- Changes Required — Gate stays CONCERNS until the path helper cache issue is fixed in the tests and CLI integration coverage lands per the test design.

### Review Date: 2025-10-04 (QA Closure)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ Autouse fixture clears `resolve_repo_root` cache around each test, allowing monkeypatched git/subprocess hooks to behave deterministically (`tests/unit/fancyrag/utils/test_paths.py:12-18`).
- ✅ New regression test exercises `kg.run` with an external `--qa-report-dir`, confirming QA artefact paths remain absolute, on-disk, and anchored beneath the configured directory (`tests/unit/scripts/test_kg_build.py:885-948`).
- ✅ Existing report helper tests continue to enforce sanitisation, collision handling, and evaluator contracts (`tests/unit/fancyrag/qa/test_report.py:8-137`, `src/fancyrag/qa/report.py:17-59`).

### Requirements Traceability
- **AC1** – PASS; helper retains sanitisation and versioned directory handling covered by 4.5-UNIT-001/003/004.
- **AC2** – PASS; evaluator delegates to the helper with unchanged `QaResult` contract (verified via updated unit suite).
- **AC3** – PASS; integration test 4.5-INT-002 now validates pipeline behaviour for out-of-repo QA directories.
- **AC4** – PASS; unit and integration scenarios from the test design are implemented and green.
- **AC5** – PASS; documentation updates remain intact (manual verification).

### Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag/utils/test_paths.py tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir`

### Risks & Recommendations
- No outstanding risks; prior QA-TEST-001 and QA-COVERAGE-001 mitigations are verified.

### Status Recommendation
- Ready for Done — recommend QA gate PASS.
