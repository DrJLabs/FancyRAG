# Story 3.3: Native Qdrant Retriever Integration

## Status
Done

## Story
**As a** FancyRAG operator responsible for retrieval accuracy,
**I want** the `ask_qdrant.py` CLI to delegate vector search and context joins to the official `QdrantNeo4jRetriever`,
**so that** we reuse the supported GraphRAG abstractions, reduce bespoke code, and keep retrieval telemetry consistent with the minimal-path workflow.

## Acceptance Criteria
1. Refactor `scripts/ask_qdrant.py` so the main retrieval path instantiates `neo4j_graphrag.retrievers.QdrantNeo4jRetriever`, wiring the existing Qdrant and Neo4j clients, collection name, and ID join fields without introducing new CLI flags. [Source: docs/bmad/focused-epics/ingestion-quality/epic.md#Stories] [Source: docs/architecture/overview.md#Minimal Path Workflow] [Source: docs/prd.md#fr5]
2. Preserve the CLI surface, structured logging payload, sanitized artifact (`artifacts/local_stack/ask_qdrant.json`), and success/error messaging exactly as documented today while routing matchmaking through the retriever. [Source: docs/architecture/coding-standards.md#Script Conventions] [Source: docs/architecture/coding-standards.md#Logging Guidance]
3. Continue using `SharedOpenAIClient` to generate the embedding query vector, ensuring retriever inputs/outputs integrate cleanly with existing question handling, redaction, and telemetry helpers. [Source: docs/stories/2.3.openai-shared-client.md#Acceptance Criteria] [Source: docs/architecture/overview.md#Minimal Path Workflow]
4. Update unit tests (`tests/unit/scripts/test_ask_qdrant.py`) to patch `QdrantNeo4jRetriever`, validating top-k success, no-match, and error paths while keeping coverage for artifact writing and sanitized output. [Source: docs/architecture/coding-standards.md#Testing Expectations] [Source: docs/bmad/focused-epics/ingestion-quality/epic.md#Success criteria]
5. Document the retriever migration in `docs/architecture/overview.md` (or adjacent runbook shard) so operators know the CLI now uses the native GraphRAG retriever and where to adjust collection/id settings. [Source: docs/architecture/overview.md#Minimal Path Workflow] [Source: docs/bmad/focused-epics/local-stack/epic.md#integration-points]

## Tasks / Subtasks
- [x] Replace `_query_qdrant` + manual Neo4j joins with a `QdrantNeo4jRetriever` instance, deriving configuration from existing environment variables and CLI parameters (AC1). [Source: docs/bmad/focused-epics/ingestion-quality/epic.md#Stories]
- [x] Ensure retriever responses populate the same `matches` schema, status strings, and structlog metadata so downstream tooling sees no change (AC2). [Source: docs/architecture/coding-standards.md#Logging Guidance]
- [x] Retain `SharedOpenAIClient` usage and confirm error handling/remediation messages continue to surface via `OpenAIClientError` (AC3). [Source: docs/stories/2.3.openai-shared-client.md#Dev Notes]
- [x] Refresh `tests/unit/scripts/test_ask_qdrant.py` to mock `QdrantNeo4jRetriever.search`, cover success/empty/error scenarios, and assert artefacts remain identical (AC4). [Source: docs/architecture/coding-standards.md#Testing Expectations]
- [x] Update architecture/runbook documentation to describe the new retriever dependency and configuration knobs (AC5). [Source: docs/architecture/overview.md#Minimal Path Workflow]

## Dev Notes
### Previous Story Insights
- Story 2.5 delivered the minimal-path retrieval scaffolding and emphasised relying on official GraphRAG APIs once they were stable; this refactor removes bespoke Qdrant + Neo4j plumbing in favour of that contract. [Source: docs/stories/2.5.minimal-path-scripts.md#Acceptance Criteria] [Source: docs/prd.md#fr5]
- Story 3.1 captured chunk metadata (relative path, checksums, git commit) that the retriever should continue to surface through the joined context payload—verify fields persist post-refactor. [Source: docs/stories/3.1.adaptive-chunking.md#Acceptance Criteria]

### Logging & Telemetry Expectations
- Maintain JSON log fields (`operation`, `status`, `duration_ms`, `matches`) and sanitized artefact output so QA telemetry added in Story 3.2 remains compatible. [Source: docs/architecture/coding-standards.md#Logging Guidance] [Source: docs/stories/3.2.ingestion-qa-telemetry.md#QA Telemetry Targets]

### Project Structure Notes
- Retrieval CLI lives under `scripts/` while shared clients/settings remain under `src/cli/`; avoid moving files to keep source tree stable. [Source: docs/architecture/source-tree.md#Source Tree Blueprint]
- `QdrantNeo4jRetriever` ships with the `neo4j-graphrag` dependency already pinned via poetry—no new packages required. [Source: docs/graphrag/OFFICIAL_LINKS.md]

### Testing Requirements
- Unit tests must stub retriever search results, assert CLI exit codes (success, skipped, error), and verify artefacts + stdout payloads remain unchanged. [Source: docs/architecture/coding-standards.md#Testing Expectations]
- Compose smoke (`tests/integration/local_stack/test_minimal_path_smoke.py`) should continue to pass without modifications; rerun after refactor to validate end-to-end retrieval. [Source: docs/architecture/overview.md#Local Stack Automation]

## Testing
- `PYTHONPATH=src pytest tests/unit/scripts/test_ask_qdrant.py`
- `PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py`

## Change Log
| Date       | Version | Description                                    | Author |
|------------|---------|------------------------------------------------|--------|
| 2025-10-02 | 1.0     | Implemented native retriever refactor, updated tests, and refreshed docs | James |
| 2025-10-02 | 0.1     | Draft capturing native retriever refactor scope | Codex |

## QA Results
- **Risk Profile:** docs/qa/assessments/3.3-risk-20251002.md (moderate overall; monitor join-key alignment, telemetry parity).
- **Test Design:** docs/qa/assessments/3.3-test-design-20251002.md (6 scenarios; P0 coverage on retriever wiring and doc update).
- **Traceability:** docs/qa/assessments/3.3-trace-20251002.md (4/5 AC fully covered; documentation update verified manually, CI guard follow-up tracked).
- **NFR Assessment:** docs/qa/assessments/3.3-nfr-20251002.md (All dimensions PASS; reliability cleared after minimal-path smoke succeeded with OpenAI credentials).
- **QA Review:** docs/qa/assessments/3.3-review-20251002.md.
- **QA Gate:** docs/qa/gates/3.3-native-qdrant-retriever.yml (PASS; add doc lint automation).
- **PO Validation:** docs/qa/assessments/3.3-po-validation-20251002.md (GO; doc lint follow-up noted).

## Dev Agent Record
### Agent Model Used
- Codex (GPT-5)

### Debug Log References
- `PYTHONPATH=src pytest tests/unit/scripts/test_ask_qdrant.py`
- `PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py`

### Completion Notes List
- Replaced bespoke Qdrant + Neo4j joins with `neo4j_graphrag.retrievers.QdrantNeo4jRetriever`, preserving sanitized CLI output and telemetry schema.
- Added retrieval record normalisation helper so chunk metadata, scores, and chunk IDs remain stable while supporting richer metadata from Story 3.1.
- Refactored unit tests to stub the retriever abstraction, asserting constructor wiring, match payload parity, and handled initialization failures; updated architecture overview with retriever guidance.

### File List
- scripts/ask_qdrant.py
- tests/unit/scripts/test_ask_qdrant.py
- docs/architecture/overview.md
- docs/qa/assessments/3.3-risk-20251002.md
- docs/qa/assessments/3.3-test-design-20251002.md
