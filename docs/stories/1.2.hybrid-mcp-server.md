# Story 1.2: Hybrid MCP Server

## Status
Ready for Done

## Story
**As a** backend engineer,
**I want** a FastMCP server that wraps `HybridCypherRetriever`,
**so that** ChatGPT can run hybrid search with minimal configuration.

## Acceptance Criteria
1. Server exposes `search` (hybrid) and `fetch` tools using a shared Neo4j driver.
2. Query embeddings use an environment-configured OpenAI-compatible service.
3. Retrieval query returns text, metadata, vector and full-text scores.

## Tasks / Subtasks
- [x] Implement FastMCP hybrid server entrypoint exposing `search` and `fetch` tools backed by a shared Neo4j driver (AC: 1) `[Ref: docs/architecture.md#application-architecture]`
  - [x] Instantiate the Neo4j driver and `HybridCypherRetriever` once at startup so both tools reuse the connection pool (AC: 1) `[Ref: docs/architecture.md#application-architecture]`
  - [x] Define `search` to execute the hybrid Cypher template and return `text`, metadata, `score_vector`, and `score_fulltext` fields (AC: 1,3) `[Ref: docs/architecture.md#api--integration-contracts]`
  - [x] Define `fetch` to retrieve nodes by id with labels and metadata for downstream consumers (AC: 1) `[Ref: docs/architecture.md#api--integration-contracts]`
  - [x] Wire FastMCP `stateless_http` transport on port 8080 and emit structured JSON logs on startup and tool execution (AC: 1) `[Ref: docs/architecture.md#observability]`
- [x] Load environment-driven configuration for Neo4j, index names, query template, embeddings, and OAuth credentials with fail-fast validation (AC: 2) `[Ref: docs/architecture.md#configuration--environment]`
  - [x] Reuse `.env.local` via `python-dotenv` and surface descriptive errors when required variables are missing or malformed (AC: 2) `[Ref: docs/architecture.md#configuration--environment]`
  - [x] Guard OAuth and secret inputs (`BASE_URL`, `GOOGLE_OAUTH_CLIENT_ID`, `GOOGLE_OAUTH_CLIENT_SECRET`, embedding key) and avoid logging sensitive values (AC: 2) `[Ref: docs/architecture.md#security-architecture]`
  - [x] Document newly required MCP variables in `.env.example` and README operations guidance (AC: 2) `[Ref: docs/architecture.md#operational-runbook-summary]`
- [x] Integrate the OpenAI-compatible embedding client used by `HybridCypherRetriever`, honoring environment-configured base URL and API key (AC: 2) `[Ref: docs/architecture.md#application-architecture]`
  - [x] Implement retries/timeouts for embedding requests and log latency for observability (AC: 2) `[Ref: docs/architecture.md#observability]`
  - [x] Confirm defaults align with Epic 1 dependency guidance so local development works with the sample embedding service (AC: 2) `[Ref: docs/epics/epic-1-hybrid-retrieval-foundation.md#dependencies--inputs]`
- [x] Configure Google OAuth provider for FastMCP and ensure protected routes expose discovery metadata (AC: 1) `[Ref: docs/architecture.md#application-architecture]`
  - [x] Return 401/403 for unauthenticated requests and note troubleshooting steps in README (AC: 1) `[Ref: docs/architecture.md#security-architecture]`
  - [x] Verify `.well-known/oauth-protected-resource` and `/auth/callback` endpoints operate with documented base URL (AC: 1) `[Ref: docs/architecture.md#application-architecture]`
- [x] Add automated tests covering configuration, embeddings, and tool responses (AC: 1-3) `[Ref: docs/architecture.md#testing-strategy]`
  - [x] Write pytest units validating tool registration, response schema, and error handling (AC: 1-3) `[Ref: docs/architecture.md#testing-strategy]`
  - [x] Add integration smoke using Testcontainers Neo4j or local fixture to assert hybrid scores populate both vector and full-text values (AC: 1-3) `[Ref: docs/architecture.md#testing-strategy]`

## Dev Notes

### Previous Story Insights
- Story 1.1 introduced idempotent index automation, documented `INDEX_NAME` and `FULLTEXT_INDEX_NAME` in `.env.example`, and updated README guidance for rerunning index scripts—reuse those names and documentation without renaming to keep Makefile targets consistent. `[Source: docs/stories/1.1.scripted-index-automation.md#dev-notes]`

### Data Models
- Hybrid retrieval continues to operate on `Chunk` nodes containing `text` and `embedding` fields, with vector index `text_embeddings` and full-text index `chunk_text_fulltext` managed in Neo4j 5.18. `[Source: docs/architecture.md#domain--data-architecture]`

### API Specifications
- FastMCP must expose `POST /mcp/search` and `POST /mcp/fetch` tools; the hybrid query returns `text`, metadata, `score_vector`, and `score_fulltext` columns for consumers. `[Source: docs/architecture.md#api--integration-contracts]`
- The server instantiates a shared Neo4j driver plus `HybridCypherRetriever`, consuming environment variables for connectivity, index names, embedding service, and OAuth credentials. `[Source: docs/architecture.md#application-architecture]`

### Component Specifications
- Implement `servers/mcp_hybrid_google.py` as the FastMCP entrypoint using `stateless_http` on port 8080 with Google OAuth protection. `[Source: docs/architecture.md#application-architecture]`
- Follow the approved Python 3.12 / FastMCP / `neo4j-graphrag` stack and dependency versions. `[Source: docs/architecture/tech-stack.md]`

### File Locations
- Place the server module under `servers/` and any supporting utilities within `src/fancryrag/` according to the source tree blueprint; document new configuration in README and `.env.example`. `[Source: docs/architecture/source-tree.md]`
- Add tests under `tests/servers/` mirroring the module structure with `pytest`. `[Source: docs/architecture/source-tree.md]`

### Testing Requirements
- Use `pytest` with dependency injection/mocking for unit coverage and plan integration tests that run hybrid queries against Neo4j (Testcontainers/local). `[Source: docs/architecture.md#testing-strategy]`
- Ensure CI jobs execute lint (`ruff`), unit, and integration smoke stages when the server is introduced. `[Source: docs/architecture.md#testing-strategy]`

### Technical Constraints
- Configuration must be environment-driven; validate required variables at startup and avoid logging secrets. `[Source: docs/architecture.md#security-architecture]`
- Emit structured JSON logs and capture latency metrics for embedding calls and FastMCP endpoints to support observability. `[Source: docs/architecture.md#observability]`
- Maintain search latency within the ≤1.5s target and support horizontal scaling by keeping the server stateless. `[Source: docs/architecture.md#non-functional-architecture]`

### Project Structure Notes
- Align new files with the documented repo layout (server in `servers/`, supporting modules in `src/fancryrag/`, tests in `tests/`); update documentation under `docs/` if additional operational guidance is required. `[Source: docs/architecture/source-tree.md]`

#### Testing
- Unit: Target tool registration, configuration validation, and error handling using `pytest` fixtures and mocks. `[Source: docs/architecture.md#testing-strategy]`
- Integration: Use Neo4j Testcontainers or compose to seed sample data and confirm hybrid response includes both score types. `[Source: docs/architecture.md#testing-strategy]`
- Continuous: Add smoke job to CI once the server exists to execute `make index`, `make fulltext-index`, and a sample `search` call. `[Source: docs/architecture.md#testing-strategy]`

## Change Log
| Date       | Version | Description                          | Author |
|------------|---------|--------------------------------------|--------|
| 2025-10-09 | 0.1     | Initial draft of Story 1.2 (SM)      | Bob    |
| 2025-10-09 | 1.0     | Implemented hybrid MCP server (Dev)  | James  |
| 2025-10-09 | 1.1     | Added FastMCP and embedding regression tests post-QA | James  |
| 2025-10-09 | 1.2     | Added stateless HTTP auth coverage and latency budget smoke | James  |

## Dev Agent Record

### Agent Model Used

- Codex GPT-5 (developer mode)

### Debug Log References

- `uv run ruff check`
- `uv run pytest`

### Completion Notes List

- Added structured configuration loader with validation and hybrid query templating (`src/fancryrag/config.py`, `queries/hybrid_retrieval.cypher`).
- Implemented retrying OpenAI embedding client, JSON logging, and FastMCP server entrypoint with Google OAuth (`src/fancryrag/embeddings.py`, `src/fancryrag/logging_setup.py`, `servers/mcp_hybrid_google.py`).
- Documented new MCP environment variables and provided unit coverage for configuration and tool responses (`README.md`, `.env.example`, `tests/test_config.py`, `tests/servers/test_runtime.py`).
- Added FastMCP tool registration regression test and embedding retry unit coverage, plus cleaned unused imports for lint parity (`tests/servers/test_runtime.py`, `tests/test_embeddings.py`, `src/fancryrag/config.py`, `src/fancryrag/logging_setup.py`).
- Added stateless HTTP authentication regression test and latency smoke to enforce ≤1.5s search target (`tests/servers/test_runtime.py`, `src/fancryrag/mcp/runtime.py`).

### File List

- pyproject.toml
- uv.lock
- .env.example
- README.md
- queries/hybrid_retrieval.cypher
- servers/mcp_hybrid_google.py
- src/fancryrag/__init__.py
- src/fancryrag/config.py
- src/fancryrag/embeddings.py
- src/fancryrag/logging_setup.py
- src/fancryrag/mcp/runtime.py
- tests/test_config.py
- tests/servers/test_runtime.py
- tests/test_embeddings.py

## QA Results

### Review Date: 2025-10-09
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Structured logging, configuration validation, and retry helpers align with architecture guidance; no QA refactors required.
- Startup guards verify Neo4j connectivity, and search/fetch helpers handle missing records with controlled logging.

### Test Coverage
- Reviewed `tests/test_config.py` and `tests/servers/test_runtime.py`; they cover config fail-fast behavior, hybrid scoring, and fetch semantics.
- Identified gaps: FastMCP tool registration and embedding retry behavior lack automated coverage.

### Issues & Recommendations
1. Add a FastMCP server invocation test that exercises `search`/`fetch` through the auth wrapper to prove shared driver reuse.
2. Cover `RetryingOpenAIEmbeddings` with stubbed client tests to confirm configured base URL, timeout, and retry telemetry.
3. Establish a lightweight performance smoke test to enforce the ≤1.5s search latency budget before release.

### Evidence
- Trace matrix: docs/qa/assessments/epic-1.2-trace-20251009.md
- NFR assessment: docs/qa/assessments/epic-1.2-nfr-20251009.md
- Gate: docs/qa/gates/1.2-hybrid-mcp-server.yml

### Recommended Status
- Gate decision: CONCERNS — address coverage gaps before promoting to Ready for Done.

### Review Date: 2025-10-09 (Re-review)
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Verified new regression tests cover FastMCP tool registration and embedding retries with clear assertions on scores, metadata, and configuration (`tests/servers/test_runtime.py:143`, `tests/test_embeddings.py:31`).
- No additional code changes required; logging and configuration modules remain compliant with architecture guidelines.

### Test Coverage
- AC1 now fully covered via async FastMCP invocation exercising both `search` and `fetch` against the shared driver stub.
- AC2 validated through stubbed OpenAI client tests confirming base URL, API key, timeout, retries, and error propagation.
- AC3 remained intact with existing hybrid scoring assertions; all tests pass under `uv run pytest` (2025-10-09).

### Issues & Recommendations
1. Add a stateless HTTP contract test (or equivalent harness) that proves unauthorized requests receive 401/403 responses before production exposure.
2. Introduce an automated performance smoke or benchmark enforcing the documented ≤1.5s hybrid search latency.
3. Extend observability validation to ensure secret redaction and latency telemetry remain intact during refactors.

### Evidence
- Regression suite: `uv run pytest`
- Lint confirmation: `uv run ruff check`
- Trace & NFR updates: docs/qa/assessments/epic-1.2-trace-20251009.md, docs/qa/assessments/epic-1.2-nfr-20251009.md
- Gate file: docs/qa/gates/1.2-hybrid-mcp-server.yml

### Recommended Status
- Gate decision: CONCERNS — outstanding security/performance validation required before Ready for Done.

### Review Date: 2025-10-09 (QA Final)
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- Confirmed optional auth injection remains isolated to testing seams while production defaults to Google OAuth.
- Regression suite continues to pass under `uv run pytest`; lint remains clean via `uv run ruff check`.

### Test Coverage
- `tests/servers/test_runtime.py::test_stateless_http_enforces_authentication` verifies 401 without bearer token and successful initialization with valid credentials.
- `tests/servers/test_runtime.py::test_search_latency_within_budget` enforces the ≤1.5s hybrid search SLA.

### Issues & Recommendations
1. Promote the auth and latency smokes into CI pipelines for continuous assurance.
2. Extend future stories to cover token expiry and higher-load latency scenarios using Testcontainers Neo4j.

### Evidence
- Regression suite: `uv run pytest`
- Lint confirmation: `uv run ruff check`
- Gate: docs/qa/gates/1.2-hybrid-mcp-server.yml

### Recommended Status
- Gate decision: PASS — promote to Ready for Done after PO validation.

## PO Validation

- Approved on 2025-10-09 by Sarah (Product Owner). Story meets acceptance criteria, QA gate PASS, and documentation reflects new auth/performance safeguards.
