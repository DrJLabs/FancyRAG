# Story 4.4: QA Evaluator Module

## Status
Done — 2025-10-04

## Story
**As a** FancyRAG pipeline maintainer,
**I want** the ingestion QA evaluation logic extracted into a dedicated module with explicit threshold and reporting interfaces,
**so that** quality gates stay modular, testable, and aligned with the refactor guardrails while preserving existing CLI behaviour.

## Acceptance Criteria
1. Implement `src/fancyrag/qa/evaluator.py` housing the `IngestionQaEvaluator` thresholds, totals math, and reporting helpers currently embedded in `src/fancyrag/kg/pipeline.py`, exposing the same evaluation API for pipeline consumers. [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-1-kg_buildpy-monolith-decomposition] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] [Source: src/fancyrag/kg/pipeline.py]
2. Ensure the evaluator module generates versioned JSON/Markdown QA reports, enforces the documented threshold overrides (missing embeddings, orphan chunks, checksum mismatches, semantic failures), and returns structured pass/fail results without behaviour drift. [Source: docs/architecture/overview.md#Built-In Tool Playbook] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: src/fancyrag/kg/pipeline.py]
3. Refactor `fancyrag.kg.pipeline` (and any CLI wiring) to consume the new evaluator module while preserving the CLI → pipeline → QA import direction, environment flag propagation, and rollback semantics. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#2-high-level-design] [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/overview.md#High-Level Components]
4. Add focused unit tests under `tests/unit/fancyrag/qa/` plus refresh pipeline/CLI tests to cover evaluator integration (threshold overrides, semantic summaries, rollback paths) following the testing strategy and coding standards. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations]
5. Update architecture documentation shards (source tree and refactor addendum) to mark the evaluator module delivered and describe its contract within the package. [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]

## Tasks / Subtasks
- [x] Catalogue the existing QA evaluation, threshold dataclasses, and report writers inside `src/fancyrag/kg/pipeline.py` to define the extraction scope. (AC: 1, 2) [Source: src/fancyrag/kg/pipeline.py]
- [x] Implement `src/fancyrag/qa/evaluator.py` with the relocated evaluator, typed threshold inputs, and report helpers while maintaining public method signatures. (AC: 1, 2) [Source: docs/prd/projects/fancyrag-kg-build-refactor/prd.md#epic-1-kg_buildpy-monolith-decomposition] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]
- [x] Refactor `fancyrag.kg.pipeline` and CLI glue to import the new module, preserving argument handling, rollback safeguards, and semantic QA wiring. (AC: 3) [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#2-high-level-design] [Source: docs/architecture/overview.md#Built-In Tool Playbook]
- [x] Add unit tests under `tests/unit/fancyrag/qa/` plus update existing pipeline/CLI suites to exercise evaluator integration, including threshold overrides and semantic summaries. (AC: 4) [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations]
- [x] Refresh `docs/architecture/source-tree.md` and `docs/architecture/projects/fancyrag-kg-build-refactor.md` to document the evaluator module and its import boundary. (AC: 5) [Source: docs/architecture/source-tree.md#Upcoming Module Layout] [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design]

## Dev Notes
### Previous Story Insights
- Story 4.3 isolated the caching splitter; the QA extraction must retain pipeline hooks for chunk metadata and scoped cache summaries that feed QA metrics. [Source: docs/stories/4.3.caching-fixed-size-splitter.md#Dev Notes]

### Data Models
- QA evaluation continues to operate over Neo4j Document and Chunk nodes produced by `SimpleKGPipeline`, gathering counts and anomaly metrics prior to gating. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] [Source: docs/architecture/overview.md#High-Level Components]

### API Specifications
- Maintain CLI flags controlling QA thresholds (`--qa-max-missing-embeddings`, `--qa-max-orphan-chunks`, `--qa-max-checksum-mismatches`, semantic thresholds) and the versioned report outputs described for ingestion runs. [Source: docs/architecture/overview.md#Built-In Tool Playbook]

### Component Specifications
- Preserve the documented import direction (CLI → pipeline → QA/report/db modules) and keep evaluator helpers confined to `src/fancyrag/qa/`. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#2-high-level-design]

### File Locations
- Place the evaluator module at `src/fancyrag/qa/evaluator.py`, export any shared QA dataclasses there, and mirror coverage in `tests/unit/fancyrag/qa/`. [Source: docs/architecture/source-tree.md#Upcoming Module Layout]

### Testing Requirements
- Follow the refactor testing plan: unit coverage for the evaluator metrics plus integration/smoke runs validating pipeline gating parity after extraction. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#5-Testing Strategy] [Source: docs/architecture/coding-standards.md#Testing Expectations]

### Technical Constraints
- Continue targeting Python 3.12 with the pinned Neo4j, Qdrant, and OpenAI dependencies; uphold logging, retry, and secret-handling guardrails. [Source: docs/architecture/tech-stack.md#Technology Stack] [Source: docs/architecture/coding-standards.md#Critical Rules]

### Project Structure Notes
- No standalone unified project structure shard exists; rely on the source tree blueprint when validating placement of the evaluator module and associated tests. [Source: docs/architecture/source-tree.md#Source Tree Blueprint]

## Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag/qa/test_evaluator.py tests/unit/fancyrag/kg/test_pipeline.py`
- `LOCAL_STACK_SKIP_DOCKER_CHECK=1 PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs`

## Change Log

| Date       | Version | Description                                  | Author |
|------------|---------|----------------------------------------------|--------|
| 2025-10-04 | 0.1     | Draft story for QA evaluator extraction       | Bob    |
| 2025-10-04 | 0.2     | PO approval – ready for development; see docs/qa/assessments/4.4-po-validation-20251004.md. | Sarah |

## Dev Agent Record
### Agent Model Used
- Pending

### Debug Log References
- Pending

### Completion Notes List
- Pending

### File List
- Pending

## QA Results
- Gate: PASS → docs/qa/gates/4.4-qa-evaluator.yml

### Review Date: 2025-10-04

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
- ✅ `src/fancyrag/qa/evaluator.py` encapsulates the prior pipeline QA maths, thresholds, and report writers without altering the JSON/Markdown payload schema; `QaResult` now returns explicit metadata for downstream callers (`src/fancyrag/qa/evaluator.py`).
- ✅ Pipeline orchestration swaps in the evaluator module and shared dataclasses while keeping rollback, semantic summary wiring, and CLI import direction intact (`src/fancyrag/kg/pipeline.py`).
- ✅ Shared path helpers moved to `src/fancyrag/utils/paths.py`, keeping existing exports via `fancyrag.utils` for callers including the evaluator and pipeline (`src/fancyrag/utils/__init__.py`).
- ✅ Architecture shards flag the evaluator module and utilities as delivered so future stories pick up the new layout (`docs/architecture/source-tree.md`, `docs/architecture/projects/fancyrag-kg-build-refactor.md`).

### Requirements Traceability
- **AC1** – Evaluator module created with data classes and threshold logic; confirmed via direct diff of extracted code in `src/fancyrag/qa/evaluator.py` and coverage in `tests/unit/fancyrag/qa/test_evaluator.py::test_evaluator_pass_generates_reports`.
- **AC2** – JSON/Markdown reports remain versioned (`ingestion-qa-report/v1`) and enforce overrides; validated through evaluator unit tests and manual inspection of report generation (`src/fancyrag/qa/evaluator.py`).
- **AC3** – Pipeline imports the evaluator, constructs `QaSourceRecord` payloads, and preserves rollback semantics (`src/fancyrag/kg/pipeline.py` lines 1423-1568) with unit coverage in `tests/unit/fancyrag/kg/test_pipeline.py`.
- **AC4** – Added QA-focused unit tests and refreshed pipeline suite; both command sets below executed successfully.
- **AC5** – Architecture documentation updated in the referenced shards to reflect the module delivery and contracts.

### Testing
- `PYTHONPATH=src pytest tests/unit/fancyrag/qa/test_evaluator.py`
- `PYTHONPATH=src pytest tests/unit/fancyrag/kg/test_pipeline.py`
- `PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py`

### Risks & Recommendations
- No open risks; end-to-end smoke executed successfully on 2025-10-04.

### Status Recommendation
- Ready for merge — PO validation complete on 2025-10-04 with smoke coverage in place.
