# Test Design: Story 1.3

Date: 2025-09-25
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 10
- Unit tests: 4 (40%)
- Integration tests: 6 (60%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 4, P1: 6, P2: 0, P3: 0

Strategy emphasises failure-first coverage of dependency verification, secret redaction, and deterministic reporting. Scenarios map directly to risks TECH-301, SEC-301, OPS-301, TECH-302 from the 2025-09-25 risk profile. Implemented tests reside in `tests/unit/cli/test_diagnostics.py` and `tests/integration/cli/test_environment_diagnostics.py` and satisfy every scenario enumerated below, including missing-lockfile behaviour.

## Test Scenarios by Acceptance Criteria

### AC1: Verification command loads required packages and masks secrets
| ID              | Level       | Priority | Test Description                                                                                   | Justification                                          | Mitigates |
|-----------------|-------------|----------|-----------------------------------------------------------------------------------------------------|--------------------------------------------------------|-----------|
| 1.3-UNI-001     | Unit        | P0       | Mock imports of `neo4j_graphrag`, `neo4j`, `qdrant_client`, `openai`, `structlog`, `pytest`; assert command reports success. | Validates baseline module coverage without side effects. | TECH-301 |
| 1.3-UNI-002     | Unit        | P0       | Force `ModuleNotFoundError` for each module and assert diagnostics exits non-zero with remediation guidance. | Ensures missing dependencies are surfaced clearly.     | TECH-301 |
| 1.3-UNI-003     | Unit        | P0       | Simulate environment containing `OPENAI_API_KEY` and confirm log/report output redacts sensitive values. | Prevents leakage of secrets during diagnostics.        | SEC-301 |

### AC2: Command emits machine-readable report with provenance
| ID              | Level       | Priority | Test Description                                                                                   | Justification                                          | Mitigates |
|-----------------|-------------|----------|-----------------------------------------------------------------------------------------------------|--------------------------------------------------------|-----------|
| 1.3-UNI-004     | Unit        | P1       | Validate report builder outputs keys `{python_version, packages, lock_sha256, git_sha, timestamp}` and values meet schema expectations. | Guards against schema drift and missing provenance.    | TECH-302 |
| 1.3-INT-005     | Integration | P1       | Run diagnostics in temp repo capturing `requirements.lock` and assert SHA-256 strings match expected length & casing. | Confirms hash computation end-to-end.                  | TECH-302 |
| 1.3-INT-010     | Integration | P1       | Execute diagnostics with `requirements.lock` removed; assert warning emitted and report records `exists: False` with `sha256: null`. | Validates graceful degradation and provenance when lockfile missing. | TECH-302 |

### AC3: Documentation explains execution flow and privacy stance
| ID              | Level       | Priority | Test Description                                                                                   | Justification                                          | Mitigates |
|-----------------|-------------|----------|-----------------------------------------------------------------------------------------------------|--------------------------------------------------------|-----------|
| 1.3-INT-006     | Integration | P1       | Doc lint verifying `docs/architecture/overview.md` references diagnostics step post-bootstrap and states that secrets are not collected. | Keeps operator guidance aligned with implementation.   | OPS-301 |

### AC4: Automated tests cover success, failure, and report generation
| ID              | Level       | Priority | Test Description                                                                                   | Justification                                          | Mitigates |
|-----------------|-------------|----------|-----------------------------------------------------------------------------------------------------|--------------------------------------------------------|-----------|
| 1.3-INT-007     | Integration | P0       | Execute `python -m cli.diagnostics workspace --write-report` with mocked modules; assert exit code 0 and artifact creation. | Verifies happy-path CLI integration with filesystem.   | TECH-301, OPS-301 |
| 1.3-INT-008     | Integration | P1       | Execute command with rejected module to ensure CI catches failure and redacted messaging persists in stderr. | Validates regression coverage for failure path.        | TECH-301, SEC-301 |
| 1.3-INT-009     | Integration | P1       | Run diagnostics and confirm `artifacts/environment/` remains untracked (git status clean) thanks to `.gitignore` entry. | Prevents artifact noise and enforces OPS guardrail.    | OPS-301 |

## Risk Coverage
- TECH-301: 1.3-UNI-001, 1.3-UNI-002, 1.3-INT-007, 1.3-INT-008
- SEC-301: 1.3-UNI-003, 1.3-INT-008
- OPS-301: 1.3-INT-006, 1.3-INT-007, 1.3-INT-009
- TECH-302: 1.3-UNI-004, 1.3-INT-005, 1.3-INT-010

## Recommended Execution Order
1. 1.3-UNI-001
2. 1.3-UNI-002
3. 1.3-UNI-003
4. 1.3-UNI-004
5. 1.3-INT-005
6. 1.3-INT-010
7. 1.3-INT-007
8. 1.3-INT-008
9. 1.3-INT-009
10. 1.3-INT-006

## Execution Status
- âœ… Unit coverage implemented in `tests/unit/cli/test_diagnostics.py`.
- âœ… Integration coverage implemented in `tests/integration/cli/test_environment_diagnostics.py` (including missing-lockfile warning scenario).
- âœ… Documentation lint check embedded in integration suite.

## Gate Snippet
```yaml
test_design:
  scenarios_total: 10
  by_level:
    unit: 4
    integration: 6
    e2e: 0
  by_priority:
    p0: 4
    p1: 6
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Trace Hook
Test design matrix: docs/qa/assessments/1.3-test-design-20250925.md
P0 tests identified: 4

## ðŸ”¬ Research & Validation Log
- Mode: solo (2025-09-25)
- Findings: Diagnostic coverage prioritises dependency detection, secret redaction, deterministic reporting, and repository hygiene; integration tests exercise CLI subprocess end to end while ensuring artifacts stay untracked.
- Sources: docs/architecture/coding-standards.md#testing-expectations, docs/qa/assessments/1.3-risk-20250925.md, docs/stories/1.3.environment-validation-command.md#acceptance-criteria, docs/architecture/source-tree.md#source-tree-blueprint, tests/unit/cli/test_diagnostics.py, tests/integration/cli/test_environment_diagnostics.py
- Residual Risks: Monitor dependency renames and `.gitignore` changes to keep coverage relevant.
- Next Actions: Keep diagnostics invocation in CI smoke suite; surface schema drift or redaction regressions via nightly job.
