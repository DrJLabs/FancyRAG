# NFR Assessment: Story 4.6 (Neo4j Query Helpers Module)

Date: 2025-10-04
Reviewer: Quinn (Test Architect)

## Summary
- Overall NFR posture: PASS
- Key focus areas: security (query sanitisation), reliability (rollback semantics), maintainability (single source of Cypher truth)

## Evaluation Details

### Security
- `ensure_document_relationships` reuses the previous sanitised payload flow without introducing arbitrary string formatting; unit tests confirm structured parameters (4.6-UNIT-001).
- Shared helper centralises provenance updates, reducing risk of divergent sanitisation paths between pipeline and QA.
- No secrets or credentials are persisted; helpers accept driver instances injected by existing code paths.

### Reliability
- Rollback operations consolidated under `rollback_ingest`, with unit coverage verifying relationship/node/chunk clean-up (4.6-UNIT-001).
- CLI integration scenario `tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir` (4.6-INT-001) demonstrates end-to-end stability when delegating to the shared helpers.
- Global pytest fixture now clears `resolve_repo_root` cache (`tests/conftest.py`) preventing cross-test flakiness noted in Story 4.5 QA follow-up.

### Performance
- Query semantics unchanged; helpers execute the same single-round Cypher statements previously inlined so runtime remains identical.
- No additional driver sessions or transactions introduced; existing pipeline/evaluator behaviour preserved.

### Maintainability
- Shared helpers remove duplication across pipeline/evaluator, easing future modifications and reducing code drift.
- Dedicated unit suite under `tests/unit/fancyrag/db/` provides fast regression feedback for Cypher updates.
- Architecture documents updated to record the module delivery, guiding dependency direction for subsequent stories.

## Risks & Mitigations

| Risk ID | Description | Mitigation | Status |
| ------- | ----------- | ---------- | ------ |
| TECH-002 | Future helper edits may diverge from pipeline expectations | Maintain helper unit suite in CI; enforce code ownership on `fancyrag/db` package | Mitigated |
| OPS-002 | Rollback helpers may not cover newly introduced node labels | Extend unit coverage when new labels/chunk types are added | Mitigated |

## Recommendations
- Include `tests/unit/fancyrag/db/test_neo4j_queries.py` in default CI smoke sets.
- Document helper usage in developer onboarding materials to keep future contributions aligned with the module boundary.
