# Test Design: Story 1.2 Hybrid MCP Server

Date: 2025-10-09
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 8
- Unit tests: 4 (50%)
- Integration tests: 3 (37.5%)
- E2E tests: 1 (12.5%)
- Priority distribution: P0: 5, P1: 2, P2: 1, P3: 0

Focus: Validate FastMCP server correctness, OAuth enforcement, configuration robustness, and hybrid retrieval payload fidelity using risk-based priorities tied to SEC-001 and TECH-001. `[Source: docs/qa/assessments/1.2-risk-20251009.md]`

## Test Scenarios by Acceptance Criteria

### AC1 — Server exposes OAuth-protected `search` and `fetch` tools backed by shared Neo4j driver.

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.2-UNIT-001 | Unit | P0 | Validate FastMCP tool registration returns schemas for `search` and `fetch` with shared driver injection. | Ensures core functionality wired correctly without external dependencies. `[Source: docs/architecture.md#application-architecture]` | TECH-001 |
| 1.2-UNIT-002 | Unit | P1 | Fetch tool handles existing/missing node IDs without leaking driver sessions. | Guards edge cases for fetch path using isolated mocks. `[Source: docs/stories/1.2.hybrid-mcp-server.md#tasks--subtasks]` | TECH-001 |
| 1.2-INT-001 | Integration | P0 | Execute hybrid search against seeded Neo4j to confirm `search` returns text, metadata, `score_vector`, `score_fulltext`. | Exercises actual retriever + Cypher template, validating AC3 as well. `[Source: docs/architecture.md#api--integration-contracts]` | DATA-001 |
| 1.2-INT-002 | Integration | P0 | Simulate concurrent `search`/`fetch` requests via async harness to detect session leaks/timeouts. | Validates shared driver behavior under load. `[Source: docs/architecture.md#non-functional-architecture]` | TECH-001 |
| 1.2-E2E-001 | E2E | P0 | Hit FastMCP `/mcp/search` via stateless HTTP with valid bearer token after OAuth handshake stub. | Confirms end-to-end tool availability and response format in production-like path. `[Source: docs/architecture.md#application-architecture]` | SEC-001, DATA-001 |

### AC2 — Query embeddings use environment-configured OpenAI-compatible service.

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.2-UNIT-003 | Unit | P0 | Config loader fails fast when embedding env vars missing or malformed, producing descriptive error. | Prevents silent misconfiguration and aligns with `.env.example`. `[Source: docs/architecture.md#configuration--environment]` | OPS-001 |
| 1.2-INT-003 | Integration | P1 | Stub embedding service returning slow/failed responses to verify retry/backoff and timeout handling. | Ensures resilience against latency spikes. `[Source: docs/architecture.md#observability]` | PERF-001 |

### AC3 — Retrieval returns text, metadata, vector and full-text scores.

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.2-UNIT-004 | Unit | P2 | Response serializer enforces presence of `text`, metadata, `score_vector`, `score_fulltext`. | Lightweight schema guard preventing regression before integration tests. `[Source: docs/stories/1.2.hybrid-mcp-server.md#acceptance-criteria]` | DATA-001 |

## Risk Coverage

- **TECH-001**: Addressed by 1.2-UNIT-001, 1.2-UNIT-002, 1.2-INT-002.
- **SEC-001**: Covered by 1.2-E2E-001 plus unauthorized path assertions within same scenario.
- **PERF-001**: Mitigated by 1.2-INT-003 verifying retry/timeout metrics.
- **OPS-001**: Mitigated by 1.2-UNIT-003 fail-fast config validation.
- **DATA-001**: Covered by 1.2-INT-001, 1.2-E2E-001, and 1.2-UNIT-004 schema contract tests.

## Recommended Execution Order
1. Run all P0 unit tests (1.2-UNIT-001, 1.2-UNIT-003).
2. Execute P0 integration tests (1.2-INT-001, 1.2-INT-002) followed by the P0 E2E scenario (1.2-E2E-001).
3. Run remaining P1 scenarios (1.2-UNIT-002, 1.2-INT-003).
4. Complete P2 scenario (1.2-UNIT-004). No P3 coverage required.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 8
  by_level:
    unit: 4
    integration: 3
    e2e: 1
  by_priority:
    p0: 5
    p1: 2
    p2: 1
    p3: 0
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/qa/assessments/1.2-test-design-20251009.md
P0 tests identified: 5
