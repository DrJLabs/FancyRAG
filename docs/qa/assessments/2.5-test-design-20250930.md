# Test Design: Story 2.5

Date: 2025-09-30
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 12
- Unit tests: 6 (50%)
- Integration tests: 5 (42%)
- E2E tests: 1 (8%)
- Priority distribution: P0: 9, P1: 3, P2: 0, P3: 0

Scenario suite validates the production-ready ingestion scripts, prerequisite documentation, and automation called for in Story 2.5 while covering risks TECH-250, TECH-251, OPS-250, SEC-250, DATA-250 from docs/qa/assessments/2.5-risk-20250930.md.

## Test Scenarios by Acceptance Criteria

### AC1: Production-ready `create_vector_index.py`
| ID              | Level | Priority | Test Description                                                                                                    | Justification                                                                      | Mitigates |
|-----------------|-------|----------|----------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------|-----------|
| 2.5-UNI-001     | Unit  | P0       | Validate CLI/options default to `chunks_vec`, 1536 dims, cosine similarity, and honour `.env` overrides.            | Guards against misconfigured index parameters before runtime.                      | TECH-250 |
| 2.5-UNI-002     | Unit  | P0       | Exercise helper that inspects existing indexes; assert rejection of dimension mismatch and duplicate creation.     | Prevents silent divergence and ensures actionable error messaging.                 | TECH-250 |
| 2.5-INT-003     | Integration | P0 | Run script against Neo4j test container; verify index metadata via `CALL db.indexes()` and structured JSON logs.   | Confirms real driver usage, logging contract, and schema alignment.                | TECH-250 |
| 2.5-INT-004     | Integration | P1 | Execute script twice; assert idempotent behaviour and absence of duplicate index definitions.                       | Ensures reruns remain safe for operators and future automation.                    | DATA-250 |

### AC2: Full `kg_build.py` pipeline with retries and telemetry
| ID              | Level | Priority | Test Description                                                                                                    | Justification                                                                      | Mitigates |
|-----------------|-------|----------|----------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------|-----------|
| 2.5-UNI-005     | Unit  | P0       | Verify pipeline wiring uses `SharedOpenAIClient`, redaction middleware, and configurable batch sizing.              | Confirms critical integration points and secret hygiene.                           | TECH-251, SEC-250 |
| 2.5-UNI-006     | Unit  | P0       | Mock OpenAI rate-limit responses to ensure retry helper backs off and stops at `OPENAI_MAX_ATTEMPTS`.               | Prevents runaway retries and partial graph writes.                                 | TECH-251 |
| 2.5-INT-007     | Integration | P0 | Run pipeline on sample corpus; assert document/chunk counts, relationships, and returned metrics snapshot.          | Validates graph persistence contract for downstream export.                        | DATA-250 |
| 2.5-INT-008     | Integration | P1 | Inject transient OpenAI failures; assert retries, logging of throttling, and surfaced exit code on exhaustion.     | Ensures operational visibility and graceful failure handling.                      | TECH-251, OPS-250 |

### AC3: Documentation and runbooks updated
| ID              | Level | Priority | Test Description                                                                                                    | Justification                                                                      | Mitigates |
|-----------------|-------|----------|----------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------|-----------|
| 2.5-UNI-009     | Unit  | P1       | Markdown lint/verifier ensures ingestion runbook lists prerequisites (`check_local_stack.sh --up`), script order, and teardown. | Keeps operator flow aligned with automation sequence.                              | OPS-250 |
| 2.5-UNI-010     | Unit  | P1       | Validate `.env.example` includes variables consumed by scripts and documents override guidance for local vs CI.    | Prevents missing configuration when operators adopt scripts.                       | OPS-250 |

### AC4: Automation exercises full ingestion flow
| ID              | Level | Priority | Test Description                                                                                                    | Justification                                                                      | Mitigates |
|-----------------|-------|----------|----------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------|-----------|
| 2.5-INT-011     | Integration | P0 | Compose smoke test executes `create_vector_index.py` + `kg_build.py`, asserts structured logs redacted and emits artifacts. | Demonstrates end-to-end automation readiness tied to Story 2.4 smoke harness.      | TECH-250, SEC-250, OPS-250 |
| 2.5-E2E-012     | E2E   | P0       | Minimal path orchestration: stack check → scripts → fixture export; validates rerun safety and sets up data for Story 2.6. | Guarantees operator workflow works end-to-end and prepares assets for next story.  | DATA-250, OPS-250 |

## Risk Coverage
- TECH-250: 2.5-UNI-001, 2.5-UNI-002, 2.5-INT-003, 2.5-INT-011
- TECH-251: 2.5-UNI-005, 2.5-UNI-006, 2.5-INT-008
- OPS-250: 2.5-INT-008, 2.5-UNI-009, 2.5-UNI-010, 2.5-INT-011, 2.5-E2E-012
- SEC-250: 2.5-UNI-005, 2.5-INT-011
- DATA-250: 2.5-INT-004, 2.5-INT-007, 2.5-E2E-012

## Recommended Execution Order
1. 2.5-UNI-001
2. 2.5-UNI-002
3. 2.5-UNI-005
4. 2.5-UNI-006
5. 2.5-UNI-009
6. 2.5-UNI-010
7. 2.5-INT-003
8. 2.5-INT-004
9. 2.5-INT-007
10. 2.5-INT-008
11. 2.5-INT-011
12. 2.5-E2E-012

## Gate Snippet
```yaml
test_design:
  scenarios_total: 12
  by_level:
    unit: 6
    integration: 5
    e2e: 1
  by_priority:
    p0: 9
    p1: 3
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Trace Hook
Test design matrix: docs/qa/assessments/2.5-test-design-20250930.md
