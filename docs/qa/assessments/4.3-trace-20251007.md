# Requirements Traceability Matrix

## Story: 4.3 - Caching Splitter Module

Date: 2025-10-07
Reviewer: Quinn (Test Architect)

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 5 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Create `src/fancyrag/splitters/caching_fixed_size.py` with relocated splitter and helpers

**Coverage: FULL**

- **Unit Test**: `tests/unit/fancyrag/splitters/test_caching_fixed_size.py::test_run_refreshes_chunk_uids_on_reuse`
  - Given: A cached splitter scoped to a source with cached content.
  - When: Running the splitter in the same scope after warming the cache.
  - Then: Fresh chunk objects are generated with regenerated UIDs, proving parity with the prior inline implementation for single-string inputs.

- **Unit Test**: `tests/unit/scripts/test_kg_build.py::test_splitter_cache_scoped_per_source`
  - Given: Two ingestion scopes using the relocated splitter module.
  - When: Running the splitter for identical content in separate scopes.
  - Then: Cache entries remain isolated per scope, mirroring the legacy behaviour.

- **Unit Test**: `tests/unit/fancyrag/splitters/test_caching_fixed_size.py::test_caching_splitter_handles_sequence_input`
  - Given: Sequence input passed to the splitter as supported prior to the refactor.
  - When: Running the splitter after the sequence normalization fix.
  - Then: The splitter aggregates chunk output without triggering validation errors, restoring AC1 parity for multi-item ingestion.

#### AC2: Expose reusable configuration hooks while retaining scoped context manager

**Coverage: FULL**

- **Unit Test**: `tests/unit/fancyrag/splitters/test_caching_fixed_size.py::test_build_caching_splitter_supports_config_and_overrides`
  - Given: A `CachingSplitterConfig` instance and explicit kwargs overrides.
  - When: Building splitters via the factory and via overrides.
  - Then: Both paths yield identical chunk outputs and guard against mixed configuration, validating the configuration hooks.

- **Unit Test**: `tests/unit/fancyrag/splitters/test_caching_fixed_size.py::test_config_create_splitter_method`
  - Given: The typed configuration helper in the new module.
  - When: Creating a splitter via `CachingSplitterConfig.create_splitter()`.
  - Then: The resulting splitter executes successfully, demonstrating the reusable hook.

#### AC3: Update `fancyrag.kg.pipeline` to import the splitter module without behaviour changes

**Coverage: FULL**

- **Unit Test**: `tests/unit/fancyrag/kg/test_pipeline.py::test_run_pipeline_writes_log`
  - Given: Pipeline dependencies patched to capture splitter invocation.
  - When: Running the pipeline after the import refactor.
  - Then: The pipeline executes via `build_caching_splitter`, confirming the refactor preserved wiring and logging.

- **Unit Test**: `tests/unit/scripts/test_kg_build.py::test_run_empty_file`
  - Given: CLI orchestration wired through the pipeline with the relocated splitter.
  - When: Executing the CLI against an empty file.
  - Then: The run completes and exercises the caching splitter factory, proving the CLI â†’ pipeline flow remains intact.

#### AC4: Refresh or add unit tests targeting the new module path

**Coverage: FULL**

- **Unit Test Suite**: `tests/unit/fancyrag/splitters/test_caching_fixed_size.py`
  - Given: The extracted splitter module and helpers.
  - When: Running the comprehensive suite covering cache semantics, scope handling, sequence support, metadata copy, and configuration validation.
  - Then: All critical behaviours are validated directly against the new module path.

- **Unit Test**: `tests/unit/scripts/test_kg_build.py::test_splitter_cache_scoped_per_source`
  - Given: CLI usage of the relocated splitter.
  - When: Exercising scoped cache reuse through the CLI harness.
  - Then: Confirms regression tests guard cache semantics end-to-end.

#### AC5: Update architecture documentation to reflect delivered splitter module

**Coverage: FULL (documentation)**

- **Documentation Review**: `docs/architecture/source-tree.md#upcoming-module-layout`
  - Given: The architectural source tree shard.
  - When: Inspecting the module layout section.
  - Then: The delivered splitter module is recorded as part of the refactored structure.

- **Documentation Review**: `docs/architecture/projects/fancyrag-kg-build-refactor.md`
  - Given: The project architecture addendum.
  - When: Reviewing the module-level design section.
  - Then: The new splitter module entry describes the relocated implementation and configuration hooks.

### Critical Gaps

- None identified. All acceptance criteria now have full unit and documentation coverage.

### Test Design Recommendations

1. Extend integration smoke coverage to include a run with multiple source files after future pipeline updates to guard cache behaviour under concurrent ingestion scenarios.

### Risk Assessment

- Sequence normalization keeps regression risk low; ongoing monitoring recommended for upstream signature changes, but unit coverage now guards the scenario explicitly.

Trace matrix: qa.qaLocation/assessments/4.3-trace-20251007.md
