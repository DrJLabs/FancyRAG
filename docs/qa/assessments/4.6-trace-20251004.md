# Requirements Traceability Matrix

## Story: 4.6 â€“ Neo4j Query Helpers Module

Date: 2025-10-04
Reviewer: Quinn (Test Architect)

### Coverage Summary
- Total Requirements: 5
- Fully Covered (automated): 5 (100%)
- Fully Covered (manual evidence): 0 (0%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Implement `src/fancyrag/db/neo4j_queries.py` with reset, document relationship, rollback, and QA count helpers
**Coverage: FULL (unit)**

- Test: `tests/unit/fancyrag/db/test_neo4j_queries.py::test_reset_database_executes_delete`
  - Given a recording driver
  - When `reset_database` executes
  - Then the helper issues `MATCH (n) DETACH DELETE n` against the expected database
- Test: `tests/unit/fancyrag/db/test_neo4j_queries.py::test_ensure_document_relationships_builds_payload`
  - Given chunk metadata with provenance
  - When `ensure_document_relationships` runs
  - Then payload parameters include source path, checksum, and chunk provenance identical to previous inline query semantics
- Test: `tests/unit/fancyrag/db/test_neo4j_queries.py::test_rollback_ingest_executes_cleanup_queries`
  - Given QA source records with ingest run keys and chunk uids
  - When `rollback_ingest` executes
  - Then relationship, node, chunk, and document cleanup queries fire in sequence

#### AC2: Refactor `src/fancyrag/kg/pipeline.py` to invoke helpers while preserving ingest semantics
**Coverage: FULL (unit)**

- Test: `tests/unit/fancyrag/kg/test_pipeline.py::test_run_pipeline_writes_log`
  - Given pipeline options and stubbed helper aliases
  - When `run_pipeline` executes
  - Then the orchestrator still produces a success log while delegating reset/document calls through the imported helper interfaces

#### AC3: Update `src/fancyrag/qa/evaluator.py` to consume shared helpers for counts and semantic metrics
**Coverage: FULL (unit)**

- Test: `tests/unit/fancyrag/qa/test_evaluator.py::test_evaluator_pass_generates_reports`
  - Given stub driver responses
  - When evaluation runs
  - Then metrics and report paths rely on the shared helpers without regression
- Test: `tests/unit/fancyrag/qa/test_evaluator.py::test_collect_counts_handles_tuple_result`
  - Given varied response formats from the driver
  - When `collect_counts` executes via the evaluator imports
  - Then counts are extracted correctly, demonstrating compatibility with the shared helper wrappers

#### AC4: Add automated coverage for helpers and close Story 4.5 integration follow-up 4.5-INT-002
**Coverage: FULL (unit + integration)**

- Test Command: `PYTHONPATH=src pytest tests/unit/fancyrag/db/test_neo4j_queries.py tests/unit/fancyrag/kg/test_pipeline.py tests/unit/fancyrag/qa/test_evaluator.py`
  - Validates the new helper suite alongside pipeline/evaluator regressions
- Test: `tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir`
  - Given CLI execution with external `--qa-report-dir`
  - When the pipeline finishes
  - Then QA artefacts land beneath the configured directory, confirming integration scenario 4.5-INT-002 now passes with the shared helpers in place

#### AC5: Update architecture and epic documentation to mark the DB module delivered
**Coverage: FULL (manual doc review)**

- Artefacts: `docs/architecture/source-tree.md`, `docs/architecture/projects/fancyrag-kg-build-refactor.md`, `docs/bmad/focused-epics/kg-build-refactor/epic.md`
  - Given story completion
  - When documentation is reviewed
  - Then each shard records `db/neo4j_queries.py` as delivered with import direction guidance updated

### Critical Gaps
- None identified.

### Recommendations
- Keep helper unit suite in CI to guard against inadvertent query drift.
- Re-run the CLI integration scenario when future stories adjust QA or pipeline wiring.

### Traceability Hook
Trace matrix: docs/qa/assessments/4.6-trace-20251004.md
