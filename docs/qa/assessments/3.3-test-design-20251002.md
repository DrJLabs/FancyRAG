# Test Design: Story 3.3 – Native Qdrant Retriever Integration

Date: 2025-10-02
Designer: Quinn (QA)

## Test Strategy Overview
- Total test scenarios: 6
- Unit tests: 3 (50%)
- Integration tests: 2 (33%)
- E2E tests: 1 (17%)
- Priority distribution: P0: 2, P1: 3, P2: 1

## Test Scenarios by Acceptance Criteria

### AC1 – Retriever Wiring

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.3-UNIT-001 | unit | P0 | Validate that `QdrantNeo4jRetriever` is instantiated with expected params (collection, join keys, driver, client) derived from env/CLI. | Pure configuration logic; catches join-key regressions early. |
| 3.3-INT-001 | integration | P0 | Run CLI against local stack fixture to confirm retriever returns matched context with correct metadata fields. | Ensures end-to-end retriever wiring with real services. |

### AC2 – Log & Artifact Parity

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.3-UNIT-002 | unit | P1 | Snapshot test comparing sanitized log/artifact payload before/after refactor to ensure schema stability (`status`, `matches`, redactions). | Guards telemetry compatibility without network IO. |
| 3.3-INT-002 | integration | P1 | Compose smoke verifying CLI stdout + `artifacts/local_stack/ask_qdrant.json` structure unchanged (success + no-match flows). | Confirms parity with real dependencies. |

### AC3 – SharedOpenAIClient Usage

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.3-UNIT-003 | unit | P1 | Mock `SharedOpenAIClient` to ensure embeddings requested once per call and errors surface remediation message. | Confirms refactor didn’t bypass shared client guardrails. |

### AC4 – Updated Unit Tests

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.3-UNIT-004 | unit | P2 | Verify unit tests mock `QdrantNeo4jRetriever.search` and cover success, empty, exception paths without touching raw clients. | Maintains focused coverage with new abstraction. |

### AC5 – Documentation Update

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.3-E2E-001 | e2e | P0 | Docs lint or markdown check confirming architecture overview references retriever change and instructions compile. | Ensures operator guidance updated alongside code. |

## Risk Coverage Mapping
- TECH-101 mitigated by 3.3-UNIT-001, 3.3-INT-001.
- INTEG-102 mitigated by 3.3-UNIT-002, 3.3-INT-002, 3.3-UNIT-004.
- OBS-103 mitigated by 3.3-UNIT-002 and 3.3-INT-002.
- DOC-104 mitigated by 3.3-E2E-001 (doc check).

## Recommended Execution Order
1. Run P0 tests (3.3-UNIT-001, 3.3-INT-001, 3.3-E2E-001).
2. Execute P1 unit/integration scenarios (3.3-UNIT-002, 3.3-INT-002, 3.3-UNIT-003).
3. Finish with P2 maintenance coverage (3.3-UNIT-004).

```yaml
test_design:
  scenarios_total: 6
  by_level:
    unit: 3
    integration: 2
    e2e: 1
  by_priority:
    p0: 2
    p1: 3
    p2: 1
  coverage_gaps: []
```

Test design matrix: docs/qa/assessments/3.3-test-design-20251002.md
P0 tests identified: 2
