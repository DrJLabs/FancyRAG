# Requirements Traceability Matrix

## Story: 4.5 â€“ QA Report Module

Date: 2025-10-04
Reviewer: Quinn (Test Architect)

### Coverage Summary
- Total Requirements: 5
- Fully Covered (automated): 4 (80%)
- Fully Covered (manual evidence): 1 (20%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Implement `src/fancyrag/qa/report.py` with sanitized JSON/Markdown renderers and versioned directories
**Coverage: FULL (unit)**

- Test: `tests/unit/fancyrag/qa/test_report.py::test_write_ingestion_report_creates_timestamped_artifacts`
  - Given sanitized payload data for QA reports and an empty report directory
  - When `write_ingestion_report` persists JSON/Markdown artefacts
  - Then timestamped directories are created with both files written to disk
- Test: `tests/unit/fancyrag/qa/test_report.py::test_write_ingestion_report_sanitises_absolute_relative_paths`
  - Given payload entries containing absolute filesystem paths
  - When the helper writes the JSON and Markdown reports
  - Then absolute paths are scrubbed and filenames retained in both artefacts
- Test: `tests/unit/fancyrag/qa/test_report.py::test_write_ingestion_report_generates_unique_directories`
  - Given repeated invocations with identical timestamps
  - When `write_ingestion_report` runs twice
  - Then unique suffixes are appended and no artefacts are overwritten

#### AC2: `IngestionQaEvaluator` delegates to the new module while keeping `QaResult` contract and thresholds
**Coverage: FULL (unit)**

- Test: `tests/unit/fancyrag/qa/test_evaluator.py::test_evaluator_pass_generates_reports`
  - Given stubbed Neo4j driver metrics and QA sources
  - When `IngestionQaEvaluator.evaluate()` executes
  - Then it returns a passing `QaResult` with report paths emitted by `write_ingestion_report`
- Test: `tests/unit/fancyrag/qa/test_evaluator.py::test_evaluator_flags_threshold_breaches`
  - Given QA thresholds set to zero and excessive metrics
  - When evaluation runs
  - Then anomalies surface and the evaluator still returns the report artefact paths supplied by the helper

#### AC3: Pipeline/CLI continue writing reports under configured `qa_report_dir` with correct semantics
**Coverage: FULL (integration)**

- Test: `tests/unit/scripts/test_kg_build.py::test_run_directory_ingestion`
  - Given a temporary repository with mixed file types and an in-repo QA directory
  - When `kg.run` executes with include patterns
  - Then the QA section reports pass status with versioned artefact paths recorded in the run log
- Test: `tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir`
  - Given `--qa-report-dir` pointing outside the repository tree
  - When `kg.run` completes successfully
  - Then generated report paths are absolute, exist on disk, and remain anchored beneath the configured directory

#### AC4: Targeted tests added for the report module plus evaluator/pipeline integration
**Coverage: FULL (unit + integration)**

- Test: `tests/unit/fancyrag/qa/test_report.py::test_render_markdown_handles_anomalies_and_thresholds`
  - Given a failing QA payload
  - When Markdown output is generated
  - Then anomalies and threshold data are rendered as expected
- Test: `tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir`
  - Given CLI execution with external QA directory
  - When reports are generated
  - Then regression coverage guards the pipeline wiring for AC3 and AC4 scenarios
- Test Command: `PYTHONPATH=src pytest tests/unit/fancyrag/utils/test_paths.py tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir`
  - Given the updated suite
  - When executed
  - Then both the cache-reset fixture and regression test run green, proving the new coverage

#### AC5: Architecture shards and Epic documentation updated for delivered module
**Coverage: FULL (manual doc review)**

- Artefacts: `docs/architecture/source-tree.md`, `docs/architecture/projects/fancyrag-kg-build-refactor.md`
  - Given documentation references to QA module status
  - When reviewed post-implementation
  - Then the source tree and module design shards reflect `qa/report.py` as delivered

### Critical Gaps
- None identified.

### Recommendations
- Maintain the regression command in CI to ensure external QA directory coverage remains enforced.
- Include the new trace and NFR assessments in future story audits for quick reference.

### Traceability Hook
Trace matrix: docs/qa/assessments/4.5-trace-20251004.md
