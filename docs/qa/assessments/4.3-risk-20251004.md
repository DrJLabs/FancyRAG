# Risk Profile: Story 4.3 (Caching Splitter Module)

Date: 2025-10-04
Reviewer: Quinn (Test Architect)

## Executive Summary
- Total Risks Identified: 3
- Critical Risks: 0
- High Risks: 1
- Medium Risks: 1
- Low Risks: 1
- Overall Risk Posture: Low-to-Moderate; mitigations rely on regression tests and future managed-service verification

## Context
Story 4.3 relocates the `CachingFixedSizeSplitter` (and helpers) from `fancyrag.kg.pipeline` into `src/fancyrag/splitters/caching_fixed_size.py`, introducing a typed configuration factory that upstream callers can reuse. The refactor must keep cache scoping, UID regeneration, and chunk metadata generation identical so the pipeline and QA flows remain stable. Future managed-service work will consume this module, so regressions here would propagate beyond the local Docker stack.

## Risk Matrix

| Risk ID   | Category   | Description | Probability | Impact | Score | Priority |
|-----------|------------|-------------|-------------|--------|-------|----------|
| TECH-001  | Technical  | Splitter extraction regresses scoped caching semantics, causing duplicate or stale chunk reuse downstream | Medium (2) | High (3) | 6 | High |
| DATA-001  | Data       | Post-refactor chunk UID / checksum metadata diverges from cache blueprints, breaking QA attribution in Neo4j | Medium (2) | Medium (2) | 4 | Medium |
| OPS-001   | Operational| Managed-service stack adopts module without rerunning integration smoke, masking environment-specific regressions | Low (1) | Medium (2) | 2 | Low |

## Risk Details & Mitigations

### TECH-001 – Scoped caching regression (Score 6, High)
- **Affected components:** `src/fancyrag/splitters/caching_fixed_size.py`, `src/fancyrag/kg/pipeline.py`, tests under `tests/unit/fancyrag/*`
- **Drivers:** Re-introducing splitter via factory risks losing edge cases covered implicitly when the class lived in the pipeline (e.g., nested scopes, pydantic config passthrough).
- **Mitigation Strategy:**
  - Maintain direct unit coverage of cache warm/reuse (`tests/unit/fancyrag/splitters/test_caching_fixed_size.py`), adding regression cases for multi-scope reuse if new behaviours appear.
  - Keep pipeline tests asserting `splitter.get_cached` parity after ingestion loops.
  - Monitor upcoming integration smoke runs for chunk count deltas per source.
- **Residual Risk:** Low once integration smoke rerun confirms parity.

### DATA-001 – Chunk metadata drift (Score 4, Medium)
- **Affected components:** `_build_chunk_metadata`, QA logging, Neo4j ingestion writers.
- **Drivers:** Cache blueprint serialization now occurs in a separate module; mismatches could mean chunk metadata references stale UIDs, leading to QA false negatives or missing chunk graphs.
- **Mitigation Strategy:**
  - Ensure tests validate UID regeneration and metadata checksums (existing unit test verifies regenerate + pipeline test covers metadata path).
  - Add lightweight assertion in QA ingestion path verifying cached chunks emit unique UIDs prior to writing to Neo4j.
  - During managed-service rollout, compare QA reports before/after refactor.
- **Residual Risk:** Medium until additional QA assertions/metrics land.

### OPS-001 – Missed managed-service verification (Score 2, Low)
- **Affected components:** Release process, integration smoke workflow, documentation handoff.
- **Drivers:** Story completed while managed-service epic is paused; when work resumes the refactor might deploy without re-running the local-stack smoke.
- **Mitigation Strategy:**
  - Track reminder in QA gate & story QA results to rerun `tests/integration/local_stack/test_minimal_path_smoke.py` once managed-service epic restarts.
  - Coordinate with DevOps to include splitter module in upcoming managed-service checklists.
- **Residual Risk:** Low with explicit reminder and backlog entry.

## Recommendations Summary
- **Must Fix Before Merge:**
  - Preserve scoped caching semantics with targeted unit tests and ensure pipeline loop exercises cache reuse (addresses TECH-001).
- **Monitor Post-Merge:**
  - Validate QA metadata integrity and chunk UID uniqueness during next integration smoke (DATA-001).
  - Enforce managed-service smoke rerun as part of epic kickoff checklist (OPS-001).

## Risk Summary YAML (for gate file)
```yaml
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 1
    low: 1
  highest:
    id: TECH-001
    score: 6
    title: "Scoped caching semantics regress"
  recommendations:
    must_fix:
      - "Maintain unit + pipeline regression coverage around scoped cache reuse"
    monitor:
      - "Rerun integration smoke when managed-service stack work resumes"
      - "Add QA assertions to catch chunk metadata drift"
```

## Residual & Follow-up Actions
- Schedule the integration smoke rerun alongside managed-service epic restart.
- Capture backlog item for QA assertion covering unique chunk UIDs after cache reuse.
- Share risk profile with Product Owner/Dev to ensure mitigations enter the epic coordination board.

