# Test Design: Story 5.1 (Pipeline Orchestrator Decomposition)

Date: 2025-10-06
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 10
- Unit tests: 9 (90%)
- Integration tests: 1 (10%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 5, P1: 5, P2: 0, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Extract helper functions/classes for pipeline phases

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 5.1-UNIT-001  | Unit  | P0       | `tests/unit/fancyrag/kg/test_pipeline.py::test_run_pipeline_writes_log` | Confirms orchestrator delegates to helpers and produces sanitised logs, proving thin coordination layer. |
| 5.1-UNIT-002  | Unit  | P1       | `tests/unit/fancyrag/kg/test_phases.py::test_ingest_source_with_semantic_enrichment` | Exercises ingest helper with semantic path to ensure refactored phases cooperate. |
| 5.1-UNIT-003  | Unit  | P1       | `tests/unit/fancyrag/kg/test_phases.py::test_ingest_source_without_semantic` | Validates non-semantic ingestion continues to produce QA artefacts. |

### AC2: Helpers accept explicit parameters and return typed results

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 5.1-UNIT-004  | Unit  | P0       | `tests/unit/fancyrag/kg/test_phases.py::test_build_clients_invokes_factories` | Confirms helper wiring uses injected factories rather than globals. |
| 5.1-UNIT-005  | Unit  | P0       | `tests/unit/fancyrag/kg/test_phases.py::test_resolve_settings_honours_overrides` | Ensures typed configuration generation stays parameter-driven. |
| 5.1-UNIT-006  | Unit  | P0       | `tests/unit/fancyrag/kg/test_phases.py::test_helpers_do_not_touch_environment` | Enforces ban on implicit `os.environ` reads, verifying maintainability guard. |
| 5.1-UNIT-007  | Unit  | P1       | `tests/unit/fancyrag/kg/test_phases.py::test_perform_qa_success_no_fallback` | Validates QA helper returns structured metrics without relying on side effects. |
| 5.1-UNIT-008  | Unit  | P1       | `tests/unit/fancyrag/kg/test_phases.py::test_perform_qa_triggers_counts_fallback` | Covers fallback path ensuring explicit dependency injection for counts. |

### AC3: Update unit tests and integration smoke for parity

| ID            | Level       | Priority | Test | Justification |
| ------------- | ----------- | -------- | ---- | ------------- |
| 5.1-UNIT-009  | Unit        | P1       | `tests/unit/fancyrag/kg/test_pipeline.py::test_run_pipeline_reuses_cached_splitter_results` | Confirms cache behaviour preserved post-refactor. |
| 5.1-INT-001   | Integration | P0       | `PYTHONPATH=src LOCAL_STACK_SKIP_DOCKER_CHECK=1 OPENAI_API_KEY=test NEO4J_URI=bolt://localhost:7687 NEO4J_USERNAME=neo4j NEO4J_PASSWORD=local-neo4j pytest tests/integration/local_stack/test_minimal_path_smoke.py::test_minimal_path_smoke -q` | Executes full ingest/enrichment/QA workflow with artefacts stored under `artifacts/local_stack/`. |

### AC4: Document call graph updates

- `tests/unit/docs/architecture/test_helper_references.py::test_architecture_doc_lists_pipeline_helpers` ensures documentation lists every helper exported by the orchestrator.

## Risk Coverage

| Scenario ID   | Mitigates Risks     |
| ------------- | ------------------- |
| 5.1-UNIT-001  | TECH-101            |
| 5.1-UNIT-002  | TECH-101            |
| 5.1-UNIT-003  | TECH-101            |
| 5.1-UNIT-004  | DATA-041            |
| 5.1-UNIT-005  | DATA-041            |
| 5.1-UNIT-006  | TECH-101, DATA-041  |
| 5.1-UNIT-007  | DATA-041            |
| 5.1-UNIT-008  | DATA-041            |
| 5.1-UNIT-009  | TECH-101, PERF-028  |
| 5.1-INT-001   | TECH-101, DATA-041, PERF-028 |

## Recommended Execution Order

1. Run helper unit suites (5.1-UNIT-001, 5.1-UNIT-004, 5.1-UNIT-006) to validate typed payloads and rollback hooks before wiring orchestration.
2. Execute sequencing/enrichment units (5.1-UNIT-002, 5.1-UNIT-003, 5.1-UNIT-005) to confirm ordering, preset handling, and optional enrichment toggles.
3. Finish with integration smoke 5.1-INT-001 to compare artefacts, QA metrics, and runtime versus Story 4.8 baselines.

## Test Design Summary YAML
```yaml
test_design:
  scenarios_total: 10
  by_level:
    unit: 9
    integration: 1
    e2e: 0
  by_priority:
    p0: 5
    p1: 5
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Notes

- Maintain existing `PYTHONPATH=src` invocation to import FancyRAG packages and CLI shims consistently. [Source: docs/architecture/coding-standards.md#Testing Expectations]
- Integration smoke stores telemetry in `artifacts/local_stack/test_log.json`; compare against historical runs for regressions. [Source: docs/stories/4.8.tests-and-smoke.md#Dev Notes]
- Consider tagging helper suites with `@pytest.mark.helpers` for faster CI triage.
