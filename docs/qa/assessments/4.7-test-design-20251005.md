# Test Design: Story 4.7 (Schema and Environment Utilities)

Date: 2025-10-05
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 6
- Unit tests: 6 (100%)
- Integration tests: 1 (17%) — minimal-path smoke executed with `.env` credentials (2025-10-05)
- E2E tests: 0 (0%)
- Priority distribution: P0: 4, P1: 2, P2: 0, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Extract schema discovery/validation into `src/fancyrag/config/schema.py`

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 4.7-UNIT-001  | Unit  | P0       | `tests/unit/fancyrag/config/test_schema.py::*` | Validates default/custom schema resolution and error handling, guarding TECH-076 |

### AC2: Pipeline and CLI import the shared schema helpers

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 4.7-UNIT-002  | Unit  | P0       | `tests/unit/fancyrag/kg/test_pipeline.py::test_run_pipeline_writes_log` | Confirms pipeline composes packaged schema/environment helpers without behaviour drift |
| 4.7-UNIT-003  | Unit  | P1       | `tests/unit/scripts/test_kg_build.py::test_run_pipeline_success` | Exercises CLI → pipeline wiring to ensure schema import path remains intact |

### AC3: Centralise environment bootstrap via `fancyrag.utils.env`

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 4.7-UNIT-004  | Unit  | P0       | `tests/unit/fancyrag/test_env_utils.py::*` | Covers `.env` discovery overrides, failure modes, and custom sequences (OPS-052) |
| 4.7-UNIT-005  | Unit  | P0       | `tests/unit/scripts/test_export_to_qdrant.py::*`, `tests/unit/scripts/test_ask_qdrant.py::*` | Ensures script entry points enforce required env vars |
| 4.7-UNIT-006  | Unit  | P1       | `tests/unit/scripts/test_create_vector_index.py::test_main_success` | Verifies vector-index CLI still bootstraps environment correctly |

### AC4: Refresh automated coverage of pipeline/CLI integration

| ID            | Level       | Priority | Test | Justification |
| ------------- | ----------- | -------- | ---- | ------------- |
| 4.7-INT-001   | Integration | P0       | `tests/integration/local_stack/test_minimal_path_smoke.py` (LOCAL_STACK_SKIP_DOCKER_CHECK=1) | Confirms end-to-end bootstrap sequencing with `.env` credentials, covering OPS-052 |

### AC5: Update architecture/epic documentation shards

- Verified via documentation diff review (no automated test required). QA review confirms `docs/architecture/source-tree.md` and epic shard updates dated 2025-10-05.

## Risk Coverage

| Scenario ID   | Mitigates Risks |
| ------------- | ---------------- |
| 4.7-UNIT-001  | TECH-076 |
| 4.7-UNIT-002  | TECH-082, OPS-052 |
| 4.7-UNIT-003  | TECH-082 |
| 4.7-UNIT-004  | OPS-052 |
| 4.7-UNIT-005  | OPS-052 |
| 4.7-UNIT-006  | OPS-052 |
| 4.7-INT-001   | OPS-052, OPS-055 |

## Recommended Execution Order

1. Run env/config unit suites (4.7-UNIT-001, 4.7-UNIT-004) to validate new modules in isolation.
2. Execute pipeline/CLI units (4.7-UNIT-002, 4.7-UNIT-003) to verify orchestration wiring.
3. Run script entry points (4.7-UNIT-005, 4.7-UNIT-006) covering ancillary CLIs.
4. Run integration smoke 4.7-INT-001 routinely (`LOCAL_STACK_SKIP_DOCKER_CHECK=1`) to guard `.env` bootstrap.

## Test Design Summary YAML
```yaml
test_design:
  scenarios_total: 6
  by_level:
    unit: 6
    integration: 1
    e2e: 0
  by_priority:
    p0: 4
    p1: 2
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Notes
- All unit suites run with `PYTHONPATH=src:.` to surface packaged modules and script entry points simultaneously.
- Integration smoke executed on 2025-10-05 with `.env` credentials; retain in regression plan.
- No dedicated automation for AC5; documentation alignment verified during QA review.
