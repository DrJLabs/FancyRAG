# Test Design: Story 3.2 – Ingestion QA Telemetry & Quality Gate

Date: 2025-10-02
Designer: Quinn (QA)

## Test Strategy Overview
- Total test scenarios: 9
- Unit tests: 4 (44%)
- Integration tests: 4 (44%)
- E2E tests: 1 (12%)
- Priority distribution: P0: 3, P1: 4, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1 – Structured QA Report Generation

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.2-UNIT-001 | unit | P0 | Metric collector aggregates chunk counts, token histogram bins, orphan counts from in-memory fixtures. | Pure logic with deterministic inputs. |
| 3.2-UNIT-002 | unit | P1 | Report serializer emits JSON + Markdown with required keys (`summary`, `metrics`, `artifacts_path`). | No external IO required. |
| 3.2-INT-001 | integration | P0 | Run `kg_build.py --qa-report` against fixture corpus; assert artefacts written to `artifacts/ingestion/<ts>/` with timestamped directory. | Validates CLI + file IO path. |

### AC2 – Severity Threshold Gating

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.2-UNIT-003 | unit | P0 | Threshold evaluator raises `QAThresholdExceeded` when orphan rate or missing embeddings exceed configured values. | Business logic only. |
| 3.2-INT-002 | integration | P1 | Simulate ingestion with injected anomaly causing failure; ensure process exits non-zero and no Neo4j/Qdrant writes persist (requires transactional harness). | Cross-component behaviour. |
| 3.2-INT-003 | integration | P1 | Verify configurable thresholds via CLI/env override propagate to evaluator (e.g., `--max-missing-embeddings`). | CLI + settings bridging.

### AC3 – Sanitized Telemetry & Documentation

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.2-UNIT-004 | unit | P2 | Sanitizer redacts absolute paths, secrets, and prompt text within QA summaries. | Deterministic text processing. |
| 3.2-INT-004 | integration | P1 | Capture QA summary logs and artefacts during run; verify outputs exclude secrets and use relative paths only. | Requires running CLI with test data. |

### AC4 – CI Coverage & Artefact Wiring

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.2-E2E-001 | e2e | P0 | Execute local stack smoke (Neo4j + Qdrant) with QA enabled; confirm artefacts archived and GitHub Actions step fails when gate trips. | Full pipeline regression. |
| 3.2-INT-005 | integration | P2 | GitHub Actions workflow simulation verifying artefact uploader includes QA reports and gating result summary. | CI integration surface. |

## Risk Coverage Mapping
- TECH-001 mitigated by 3.2-INT-002 and 3.2-E2E-001 (transaction/rollback coverage).
- DATA-001 mitigated by 3.2-UNIT-001, 3.2-INT-001, and 3.2-INT-003 (metric parity).
- PERF-001 mitigated by monitoring steps embedded in 3.2-INT-001 and 3.2-E2E-001 (duration assertions, budget logging).
- OPS-001 mitigated by 3.2-INT-004 and 3.2-INT-005 (artefact contract testing).
- SEC-001 mitigated by 3.2-UNIT-004 and 3.2-INT-004 (sanitization verification).

## Recommended Execution Order
1. P0 unit tests (3.2-UNIT-001, 3.2-UNIT-003).
2. P0 integration test (3.2-INT-001) followed by P0 e2e (3.2-E2E-001).
3. Remaining P1 tests (3.2-UNIT-002, 3.2-INT-002, 3.2-INT-003, 3.2-INT-004).
4. P2 coverage (3.2-UNIT-004, 3.2-INT-005).

```yaml
test_design:
  scenarios_total: 9
  by_level:
    unit: 4
    integration: 4
    e2e: 1
  by_priority:
    p0: 3
    p1: 4
    p2: 2
  coverage_gaps: []
```

Test design matrix: docs/qa/assessments/3.2-test-design-20251002.md
P0 tests identified: 3
