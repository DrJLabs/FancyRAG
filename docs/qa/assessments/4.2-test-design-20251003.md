# Test Design: Story 4.2 (Pipeline Orchestrator Module)

Date: 2025-10-03
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 11
- Unit tests: 6 (54.5%)
- Integration tests: 4 (36.4%)
- E2E tests: 1 (9.1%)
- Priority distribution: P0: 5, P1: 5, P2: 1, P3: 0

Focus on fast unit coverage for orchestrator behaviours, followed by integration/E2E runs that validate CLI parity and reset handling against real services.

## Test Scenarios by Acceptance Criteria

### AC1 – Create `src/fancyrag/kg/pipeline.py` orchestrator

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-UNIT-001 | Unit | P1 | Validate orchestrator returns structured result (counts, run IDs, QA section) for single-source input | Pure orchestration logic using stubs; fastest signal for regression (mitigates TECH-001) |
| 4.2-UNIT-002 | Unit | P0 | Ensure semantic enrichment toggle triggers gating + telemetry propagation | High-risk path that must stay intact after extraction (TECH-001) |
| 4.2-INT-001 | Integration | P0 | Run orchestrator against local Neo4j/Qdrant fixtures to confirm baseline ingestion parity | Verifies SimpleKGPipeline wiring end to end without CLI (TECH-001) |

### AC2 – Centralise dependency validation and sanitisation

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-UNIT-003 | Unit | P1 | Raise clear error when GraphRAG modules missing, with mitigation hint | Ensures dependency guardrails survive extraction (TECH-001) |
| 4.2-UNIT-004 | Unit | P1 | Fail fast if required env vars absent, ensuring ensure_env coverage | Keeps environment validation centralized (TECH-001) |
| 4.2-INT-002 | Integration | P0 | Multi-source ingest verifying reset flag runs once and subsequent sources reuse state | Prevents destructive resets and guards data integrity (DATA-001) |
| 4.2-UNIT-006 | Unit | P1 | Detect disallowed reverse imports to avoid CLI ↔︎ pipeline cycles | Enforces documented import direction (TECH-002) |

### AC3 – Update CLI module to delegate to orchestrator

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-UNIT-005 | Unit | P1 | Verify `kg_build_main.run` invokes orchestrator with parsed args and logs structured payloads | Ensures thin CLI wrapper remains correct (TECH-001) |
| 4.2-INT-003 | Integration | P0 | `python scripts/kg_build.py` smoke (existing minimal path) asserting output parity and exit codes | Critical regression check for operator-facing CLI (TECH-001) |

### AC4 – Add/refresh automated coverage

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-E2E-001 | E2E | P0 | Compose-based minimal-path run producing grounded answer & QA artefacts | Validates full ingest loop including external services (TECH-001, DATA-001) |

### AC5 – Update documentation and architecture references

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 4.2-INT-004 | Integration | P2 | `scripts/check_docs.py --strict` ensuring source tree/refactor docs mention new module | Detects doc drift from module extraction (OPS-001) |

## Risk Coverage
- **TECH-001:** 4.2-UNIT-001, 4.2-UNIT-002, 4.2-UNIT-003, 4.2-UNIT-004, 4.2-UNIT-005, 4.2-INT-001, 4.2-INT-003, 4.2-E2E-001
- **TECH-002:** 4.2-UNIT-006
- **DATA-001:** 4.2-INT-002, 4.2-E2E-001
- **OPS-001:** 4.2-INT-004

Coverage gaps: None – every acceptance criterion has at least one automated test path.

## Recommended Execution Order
1. P0 unit tests (4.2-UNIT-002)
2. P0 integration tests (4.2-INT-001, 4.2-INT-002, 4.2-INT-003)
3. P0 E2E test (4.2-E2E-001)
4. Remaining P1 unit tests (4.2-UNIT-001, 4.2-UNIT-003, 4.2-UNIT-004, 4.2-UNIT-005, 4.2-UNIT-006)
5. P2 integration test (4.2-INT-004)

## Gate YAML Snippet
```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 6
    integration: 4
    e2e: 1
  by_priority:
    p0: 5
    p1: 5
    p2: 1
  coverage_gaps: []
```

## Trace Reference
- Test design matrix: docs/qa/assessments/4.2-test-design-20251003.md
- P0 tests identified: 5 (4.2-UNIT-002, 4.2-INT-001, 4.2-INT-002, 4.2-INT-003, 4.2-E2E-001)

## Quality Checklist
- [x] Every AC has test coverage
- [x] Test levels align with framework guidance
- [x] No duplicate coverage beyond risk-based defense-in-depth
- [x] Priorities reflect business and technical risk
- [x] Test IDs follow `{epic}.{story}-{LEVEL}-{SEQ}`
- [x] Scenarios are atomic and independently executable
