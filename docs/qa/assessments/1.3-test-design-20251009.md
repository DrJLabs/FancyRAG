# Test Design: Story 1.3 Containerized Deployment

Date: 2025-10-09
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 7
- Unit/static checks: 2 (29%)
- Integration tests: 3 (43%)
- End-to-end tests: 2 (29%)
- Priority distribution: P0: 4, P1: 2, P2: 1, P3: 0

Focus: Validate container build integrity, Compose orchestration, operational documentation, and hybrid smoke coverage aligned to risks BUILD-001, SEC-002, OPS-003, REL-005. `[Source: docs/qa/assessments/1.3-risk-20251009.md#risk-matrix]`

## Test Scenarios by Acceptance Criteria

### AC1 — Dockerfile builds Python image with FastMCP and project sources.

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.3-UNIT-001 | Static | P0 | Lint Dockerfile/`.dockerignore` to ensure `.env*` excluded, base image pinned, and `uv sync --frozen` invoked. | Prevents secret leakage and build drift at authoring time. `[Source: docs/stories/1.3.containerized-deployment.md#tasks--subtasks]` | SEC-002, BUILD-001 |
| 1.3-INT-001 | Integration | P0 | CI job builds image from repo root, verifies `uv` lock usage, exports final digest, and runs secret scan (`trivy --scanners secret`). | Confirms deterministic build pipeline and secret hygiene. `[Source: docs/qa/assessments/1.3-risk-20251009.md#build-001--image-drift--reproducibility]` | BUILD-001, SEC-002 |
| 1.3-INT-002 | Integration | P1 | Execute container entrypoint locally (without Compose) injecting env via `env_file` to confirm FastMCP boot succeeds and logs `server.starting`. | Validates minimal container startup and logging obligations. `[Source: docs/stories/1.3.containerized-deployment.md#tasks--subtasks]` | REL-005 |

### AC2 — `docker-compose.yml` includes `mcp` service on `rag-net` with port 8080.

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.3-STATIC-002 | Static | P1 | Schema lint for Compose manifest ensuring `services.mcp` exists, references image build context, declares `rag-net`, `depends_on: neo4j`, and exposes 8080. | Guarantees config drift caught before runtime. `[Source: docs/architecture.md#infrastructure-architecture]` | REL-005 |
| 1.3-INT-003 | Integration | P0 | `docker compose up -d neo4j mcp` with healthcheck gating; verify `docker compose ps` shows healthy states and network connectivity (`curl neo4j:7474`). | Ensures orchestrated stack wiring matches AC2. `[Source: docs/stories/1.3.containerized-deployment.md#tasks--subtasks]` | REL-005 |

### AC3 — `docker compose up -d neo4j mcp` succeeds and logs confirm readiness.

| ID | Level | Priority | Test | Justification | Mitigates |
|----|-------|----------|------|---------------|-----------|
| 1.3-E2E-001 | E2E | P0 | Comprehensive smoke: build image, `docker compose up -d neo4j mcp`, run `make ingest f=tests/fixtures/sample.txt`, poll `/mcp/health`, then call `/mcp/search` asserting non-empty payload with scores ≤ latency budget. | Proves full AC3 workflow and addresses OPS-003/PERF-004 risks. `[Source: docs/qa/assessments/1.3-risk-20251009.md#ops-003--smoke-test-seed-gap]` | OPS-003, PERF-004 |
| 1.3-E2E-002 | E2E | P2 | Documentation validation: follow README steps verbatim to build/tag image, run stack, and observe logs; update doc gaps as defects. | Keeps operational runbook accurate per DOC-006 risk. `[Source: docs/qa/assessments/1.3-risk-20251009.md#doc-006--operational-runbook-gaps]` | DOC-006 |

## Risk Coverage
- **BUILD-001**: 1.3-UNIT-001, 1.3-INT-001
- **SEC-002**: 1.3-UNIT-001, 1.3-INT-001
- **OPS-003**: 1.3-E2E-001
- **PERF-004**: 1.3-E2E-001 (latency assertion)
- **REL-005**: 1.3-INT-002, 1.3-INT-003
- **DOC-006**: 1.3-E2E-002

## Recommended Execution Order
1. Static checks (1.3-UNIT-001, 1.3-STATIC-002) to catch config issues early.
2. Integration builds (1.3-INT-001) followed by isolated container boot (1.3-INT-002).
3. Compose orchestration validation (1.3-INT-003).
4. End-to-end smoke (1.3-E2E-001) and documentation dry run (1.3-E2E-002).

## Automation Coverage
- 1.3-E2E-001 — `tests/integration/test_container_smoke.py` builds the MCP image, runs `docker compose up -d neo4j mcp`, seeds data, validates `/mcp/health`, and asserts `/mcp/search` returns results with a static token.

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 7
  by_level:
    static: 2
    integration: 3
    e2e: 2
  by_priority:
    p0: 4
    p1: 2
    p2: 1
    p3: 0
  coverage_gaps: []
```

## Trace References

Test design matrix: docs/qa/assessments/1.3-test-design-20251009.md
- P0 scenarios: 1.3-UNIT-001, 1.3-INT-001, 1.3-INT-003, 1.3-E2E-001
