# Requirements Traceability Matrix

## Story: 2.6 - OpenAI Custom API Endpoint Support

### Coverage Summary

- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Extend `OpenAISettings` to accept an optional `OPENAI_BASE_URL`, validate it, and document the knob.

**Coverage: FULL**

- **Unit Test**: `tests/unit/config/test_openai_settings.py::test_base_url_override_logs_and_applies`
  - Given: `OPENAI_BASE_URL` set to an HTTPS gateway.
  - When: `OpenAISettings.load` parses the environment.
  - Then: Settings persist the override and logs redact the host.
- **Unit Test**: `tests/unit/config/test_openai_settings.py::test_invalid_base_url_raises`
  - Given: Invalid or non-HTTPS URLs.
  - When: Settings loader validates the override.
  - Then: Loader raises `ValueError` and emits structured telemetry.

#### AC2: Ensure `SharedOpenAIClient` passes the configured base URL, preserves retries/telemetry, and masks hosts.

**Coverage: FULL**

- **Unit Test**: `tests/unit/cli/test_openai_client.py::test_shared_client_initializes_openai_with_base_url`
  - Given: Settings with override and mocked `OpenAI` factory.
  - When: Shared client constructs the SDK instance.
  - Then: Factory receives `base_url` and logs redact the host.
- **Unit Test**: `tests/unit/cli/test_sanitizer.py::test_sanitize_text_redacts_openai_base_url`
  - Given: Sanitizer seeded with override.
  - When: Logs contain the full host.
  - Then: Sanitized output replaces host segments with `***`.

#### AC3: Update all call sites (diagnostics probe, FancyRAG pipeline adapters, `scripts/ask_qdrant.py`) to rely on the enriched settings without behavioural regressions.

**Coverage: FULL**

- **Unit Test**: `tests/unit/scripts/test_ask_qdrant.py::test_embedding_cli_base_url`
  - Given: CLI invoked with override.
  - When: Shared client is constructed for embeddings.
  - Then: Captured base URL matches configured override.
- **Unit Test**: `tests/unit/fancyrag/kg/test_pipeline.py::test_shared_client_base_url`
  - Given: FancyRAG pipeline bootstrap with override.
  - When: Pipeline builds its shared client.
  - Then: Captured base URL matches configured override; test passes using neo4j stub harness after dependency patch.
- **Unit Test**: `tests/unit/cli/test_openai_probe.py::test_openai_probe_records_base_url_override`
  - Given: Diagnostics probe executed with HTTPS override and live calls skipped.
  - When: Probe writes sanitized report.
  - Then: Report records masked base URL and sanitized host, ensuring diagnostics coverage.

#### AC4: Add unit tests exercising valid/invalid base URLs and ensure telemetry artifacts reflect the new knob.

**Coverage: FULL**

- **Unit Test**: `tests/unit/config/test_openai_settings.py::test_base_url_override_logs_and_applies`
  - Given: Valid override.
  - When: Settings instantiate.
  - Then: Telemetry logs override event with masked host.
- **Unit Test**: `tests/unit/cli/test_openai_client.py::test_shared_client_initializes_openai_with_base_url`
  - Given: Valid override.
  - When: Shared client records metrics.
  - Then: Logs include `openai.client.base_url_override` entry.

### Critical Gaps

- None identified; AC3 regression coverage includes diagnostics probe smoke for override telemetry.

### Test Design Recommendations

1. Add integration smoke to `scripts/diagnostics_probe` exercising overrides with telemetry capture.
2. Add regression test ensuring HTTP overrides are rejected once security mitigation lands.

### Risk Assessment

- **High Risk:** None â€“ all ACs covered by automated tests.
- **Medium Risk:** Security override enforcement tracked separately (see risk profile).
- **Low Risk:** Remaining.

Trace matrix: docs/qa/assessments/2.6-trace-20251004.md
