# Test Design: Story 5.2 (Centralise Typed Settings)

Date: 2025-10-07  
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 8 (72.7%)
- Integration tests: 2 (18.2%)
- Documentation/automation tests: 1 (9.1%)
- Priority distribution: P0: 5, P1: 5, P2: 1, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Introduce `FancyRAGSettings` aggregate with nested service settings

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 5.2-UNIT-001  | Unit  | P0       | `tests/unit/config/test_typed_settings.py::test_load_defaults_and_nested_models` | Proves the aggregate loads default OpenAI/Neo4j/Qdrant settings with nested models intact. |
| 5.2-UNIT-002  | Unit  | P0       | `tests/unit/config/test_typed_settings.py::test_missing_required_env_raises_redacted_error` | Ensures validation rejects absent credentials while redacting secrets, aligning with SEC-204 mitigation. |
| 5.2-UNIT-003  | Unit  | P1       | `tests/unit/config/test_typed_settings.py::test_override_models_and_dimensions` | Confirms override semantics replace existing env tunables without regression. |

### AC2: Replace direct `ensure_env` / `os.environ[...]` usages with typed settings

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 5.2-UNIT-004  | Unit  | P0       | `tests/unit/scripts/test_create_vector_index.py::test_cli_initializes_fancyrag_settings_once` | Verifies CLI populates typed settings rather than calling `ensure_env`. |
| 5.2-UNIT-005  | Unit  | P0       | `tests/unit/scripts/test_export_to_qdrant.py::test_settings_passed_to_clients` | Ensures pipeline scripts consume the shared settings object when building clients. |
| 5.2-UNIT-006  | Unit  | P1       | `tests/unit/fancyrag/kg/test_pipeline.py::test_pipeline_receives_settings_dataclass` | Guards against helper phases regressing to environment reads, covering TECH-152. |

### AC3: Update onboarding documentation describing consolidated configuration

| ID            | Level    | Priority | Test | Justification |
| ------------- | -------- | -------- | ---- | ------------- |
| 5.2-DOC-001   | Doc Lint | P1       | `PYTHONPATH=src python -m scripts.check_docs --section configuration` | Confirms documentation references new settings surface and `.env` mapping per OPS-087 mitigation. |

### AC4: Add unit tests covering fallback, overrides, error paths

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 5.2-UNIT-007  | Unit  | P0       | `tests/unit/config/test_typed_settings.py::test_retry_backoff_flags_roundtrip` | Validates numeric/boolean tunables map correctly into typed settings. |
| 5.2-UNIT-008  | Unit  | P1       | `tests/unit/config/test_typed_settings.py::test_cached_singleton_prevents_multiple_loads` | Ensures settings cache prevents reinitialization across modules, avoiding inconsistent state. |

### AC5: Publish `.env` migration checklist and rollback guidance

| ID            | Level       | Priority | Test | Justification |
| ------------- | ----------- | -------- | ---- | ------------- |
| 5.2-INT-001   | Integration | P0       | `PYTHONPATH=src OPENAI_API_KEY=test NEO4J_URI=bolt://localhost:7687 NEO4J_USERNAME=neo4j NEO4J_PASSWORD=local-neo4j pytest tests/integration/local_stack/test_minimal_path_smoke.py::test_minimal_path_smoke -q` | Demonstrates existing automation honours new settings contract end-to-end; captures artefacts for migration validation. |
| 5.2-INT-002   | Integration | P1       | `PYTHONPATH=src python scripts/kg_build.py --help` (expect single settings init log) | Manual/automation check verifying CLI help path loads settings once and exits cleanly, documenting migration verification step. |
| 5.2-UNIT-009  | Unit        | P2       | `tests/unit/config/test_typed_settings.py::test_migration_map_lists_all_required_fields` | Exercises helper that emits migration map for documentation, reducing DATA-119 risk. |

## Risk Coverage

| Scenario ID   | Mitigates Risks |
| ------------- | ----------------|
| 5.2-UNIT-001  | TECH-152        |
| 5.2-UNIT-002  | SEC-204         |
| 5.2-UNIT-003  | TECH-152        |
| 5.2-UNIT-004  | TECH-152        |
| 5.2-UNIT-005  | TECH-152        |
| 5.2-UNIT-006  | TECH-152        |
| 5.2-DOC-001   | OPS-087, DATA-119|
| 5.2-UNIT-007  | TECH-152        |
| 5.2-UNIT-008  | TECH-152        |
| 5.2-INT-001   | TECH-152, DATA-119|
| 5.2-INT-002   | DATA-119, OPS-087|
| 5.2-UNIT-009  | DATA-119        |

## Recommended Execution Order

1. Run core settings unit suite (5.2-UNIT-001/002/007) to secure validation and guardrail coverage.
2. Execute script/pipeline units (5.2-UNIT-004/005/006/008/009) ensuring callers migrate to typed settings and caching behaves.
3. Perform documentation lint (5.2-DOC-001) to confirm migration guidance stays accurate.
4. Finish with integration smoke and CLI help checks (5.2-INT-001/002) to verify end-to-end parity and migration instructions.

## Test Design Summary YAML
```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 8
    integration: 2
    documentation: 1
  by_priority:
    p0: 5
    p1: 5
    p2: 1
    p3: 0
  coverage_gaps: []
```

## Notes

- Preserve `PYTHONPATH=src` and sanitized logging when invoking scripts to respect coding standards. [Source: docs/architecture/coding-standards.md#Testing Expectations]
- Integration smoke artefacts should be archived alongside migration checklist output to close DATA-119. [Source: docs/brownfield-architecture.md#2025-10-06-addendum--fancyrag-service-hardening]
- Update pytest markers or CI job names if new suites increase runtime; maintain <=15 minute smoke budget referenced in Epic 5 planning. [Source: docs/prd.md#story-52-centralise-typed-settings]
