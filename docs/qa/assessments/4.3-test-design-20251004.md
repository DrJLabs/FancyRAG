# Test Design: Story 4.3 (Caching Splitter Module)

Date: 2025-10-04
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 8
- Unit tests: 3 (37.5%)
- Integration tests: 4 (50.0%)
- End-to-End tests: 1 (12.5%)
- Priority distribution: P0: 3, P1: 4, P2: 1, P3: 0

Focus on validating scoped caching semantics and metadata integrity for local deployments, with lightweight documentation checks to protect refactor parity.

## Test Scenarios by Acceptance Criteria

### AC1 – Extract caching splitter module with identical semantics

| ID             | Level | Priority | Test | Justification |
|----------------|-------|----------|------|---------------|
| 4.3-UNIT-001   | Unit  | P0       | Verify repeated `run` calls reuse cached blueprints but mint fresh UIDs within the same scope. | Directly validates scoped caching behaviour moved from the pipeline (mitigates TECH-001). |
| 4.3-UNIT-002   | Unit  | P1       | Ensure `splitter.scoped` isolates cache entries per source token and clears scope stack on exit. | Confirms extracted context manager behaviour and guards against cross-scope bleed. |

### AC2 – Typed configuration hooks for size/overlap

| ID             | Level | Priority | Test | Justification |
|----------------|-------|----------|------|---------------|
| 4.3-UNIT-003   | Unit  | P1       | Validate `CachingSplitterConfig` + `build_caching_splitter` enforce exclusive config/kwargs usage and propagate defaults. | Ensures factory contract for callers and protects against mixed-argument regressions. |

### AC3 – Pipeline import and behaviour parity

| ID             | Level       | Priority | Test | Justification |
|----------------|-------------|----------|------|---------------|
| 4.3-INT-001    | Integration | P0       | Exercise `_execute_pipeline` with multiple source specs to confirm cached splitter reuse and ingestion loop parity. | Detects behavioural drift affecting ingestion runs (mitigates TECH-001). |
| 4.3-INT-002    | Integration | P0       | Inspect chunk metadata emitted post-run to ensure regenerated UIDs and checksum parity with cache blueprints. | Guards QA attribution integrity (mitigates DATA-001). |
| 4.3-INT-003    | Integration | P1       | Verify CLI orchestration (`tests/unit/scripts/test_kg_build.py` stubs) imports splitter module and passes it through pipeline factories. | Confirms import direction and CLI wiring remain intact. |

### AC4 – Test suite refresh

| ID             | Level       | Priority | Test | Justification |
|----------------|-------------|----------|------|---------------|
| 4.3-INT-004    | Integration | P2       | Run documentation/test tooling (`scripts/check_docs.py --strict`) or equivalent to ensure new module + tests documented. | Maintains doc/test parity expected by story tasks. |

### AC5 – Architecture documentation updates

| ID             | Level | Priority | Test | Justification |
|----------------|-------|----------|------|---------------|
| 4.3-E2E-001    | E2E   | P1       | Optionally run `tests/integration/local_stack/test_minimal_path_smoke.py` during significant local environment changes. | End-to-end smoke confirms doc updates + module extraction behave in the full local stack when desired. |

## Risk Coverage
- TECH-001 (Scoped caching regression): 4.3-UNIT-001, 4.3-INT-001
- DATA-001 (Chunk metadata drift): 4.3-INT-002
- OPS-001 (Managed-service verification gap): 4.3-E2E-001

No unmitigated high/medium risks remain after executing assigned scenarios; ensure backlog captures the integration smoke rerun for OPS-001 timing.

## Recommended Execution Order
1. 4.3-UNIT-001 (P0) – cache blueprint parity
2. 4.3-INT-001 (P0) – pipeline reuse behaviour
3. 4.3-INT-002 (P0) – metadata verification
4. 4.3-UNIT-003 (P1) – config factory contract
5. 4.3-UNIT-002 (P1) & 4.3-INT-003 (P1) – scope isolation + CLI wiring
6. 4.3-E2E-001 (P1) – local stack smoke when deeper regression assurance is needed
7. 4.3-INT-004 (P2) – documentation/test lint sweep

---
Test design matrix: docs/qa/assessments/4.3-test-design-20251004.md
P0 tests identified: 3
