# Story 1.1 Risk Assessment — Scripted Index Automation (2025-10-09)

## Context
- **Story ID**: 1.1
- **Epic**: Hybrid Retrieval Foundation
- **Status at Review**: Draft
- **Scope Summary**: Deliver an idempotent Neo4j full-text index provisioning script, expose it via a Makefile target, extend `.env.example`, update operator docs, and add automated tests/smoke coverage.
- **Sources Consulted**: `docs/stories/1.1.scripted-index-automation.md`, `docs/architecture.md` (application, domain/data, observability, deployment pipeline, testing strategy, security architecture sections).

## Overall Risk Posture
- **Risk Gate Recommendation**: PASS (high-risk items resolved via readiness guard and CI automation).
- **Story Risk Score**: 54 / 100 (Base 100 − Critical:0 − High:0×10 − Medium:2×5 − Low:2×2).
- **Key Drivers**: Remaining focus on documentation upkeep and long-run performance monitoring; technical/operational blockers cleared.

## Risk Matrix

| Risk ID | Category | Description | Probability | Impact | Score | Priority | Owner | Mitigation Summary |
|---------|----------|-------------|-------------|--------|-------|----------|-------|--------------------|
| TECH-001 | Technical | Idempotent rerun fails when `chunk_text_fulltext` already exists, breaking bootstrap automation. | Low (1) | Medium (2) | 2 | Low | Dev | Guard uses GraphRAG helper with readiness wait; unit tests + CI smoke exercise double-run path and logging. |
| DATA-001 | Data | Script provisions index with wrong label/property, causing hybrid retrieval misses or Cypher errors. | Medium (2) | High (3) | 6 | High | Dev | Centralize label/property constants; unit-test against expected Neo4j metadata; cross-check with architecture domain schema before release. |
| OPS-001 | Operational | `make fulltext-index` target fails in CI/Operators due to Docker readiness or absent compose service bindings. | Low (1) | Medium (2) | 2 | Low | Dev/Ops | Script waits for Neo4j connectivity and GitHub Actions smoke stands up compose then runs target twice. |
| SEC-001 | Security | Logging leaks `NEO4J_PASSWORD` or URI when reporting connection status. | Low (1) | Medium (2) | 2 | Low | Dev | Redact credentials, log only host/database; enforce JSON logging per observability guidance; include log scrub assertion in tests. |
| PERF-001 | Performance | Full-text index rebuild during ingestion spikes causes prolonged lock or slow queries. | Low (1) | Medium (2) | 2 | Low | Ops | Schedule rebuild after ingestion, expose warning in docs, ensure script checks for active writes before rebuild. |

### Additional Notes
- No business/regulatory risks found at this stage; primary exposure is technical/operational.
- Residual security risk depends on adherence to structured logging standard (`docs/architecture.md#observability`).

## Detailed Risk Register

### TECH-001 — Idempotency Failure
- **Signals**: Helper may raise if index exists, Docker command stops pipeline.
- **Mitigations**: Guard with `if index_exists`; readiness wait ensures driver connectivity; unit tests cover rerun; README documents rerun expectation.
- **Detection**: CI smoke invoking target twice, local pytest with patched GraphRAG client.
- **Residual Risk**: Low with automated smoke and wait guard in place.

### DATA-001 — Schema Drift
- **Signals**: Incorrect label/property prevents retrieval scoring parity with vector index.
- **Mitigations**: Define constants drawn from architecture schema; add contract test verifying label `Chunk` and property `text`; review by data steward.
- **Detection**: Integration smoke retrieving sample chunk after index creation; static analysis comparing environment vars to script defaults.
- **Residual Risk**: Medium pending integration validation.

### OPS-001 — Orchestration Fragility
- **Signals**: `docker compose exec neo4j ...` fails when service not healthy; CI lacks Neo4j container.
- **Mitigations**: Script waits for verified connectivity with configurable attempts/delay; README emphasises wait tuning; GitHub Actions smoke runs compose workflow before repeated target execution.
- **Detection**: CI smoke referencing `make fulltext-index`; local dry run with container downtime simulation.
- **Residual Risk**: Low; automation continuously validates readiness.

### SEC-001 — Credential Exposure
- **Signals**: Logging connection string or env dumps.
- **Mitigations**: Use structured log with redaction; add lint rule or pytest asserting absence of sensitive keys in log output.
- **Detection**: Unit test capturing log records.
- **Residual Risk**: Low after log guard established.

### PERF-001 — Rebuild Latency
- **Signals**: Long index build times during ingestion windows.
- **Mitigations**: Document scheduling guidance; optionally add `--skip-if-exists` flag; monitor Neo4j index status.
- **Detection**: Operational dashboards on index creation duration.
- **Residual Risk**: Low for current dataset size; reassess if corpus grows.

## Risk-Based Testing Strategy

### Priority 1 — Address High Risks
1. **Idempotent Rerun Unit Test**: Pytest double-run fixture ensuring `create_fulltext_index` handles existing index (TECH-001).
2. **Schema Contract Test**: Validate label/property alignment and confirm GraphRAG metadata after script execution (DATA-001).

### Priority 2 — Contain Medium Risk
3. **Makefile Smoke**: CI step executing `make fulltext-index` after `docker compose up neo4j` to catch orchestration issues (OPS-001).

### Priority 3 — Mitigate Low Risks
4. **Log Redaction Test**: Capture log handler output to confirm credentials never appear (SEC-001).
5. **Operational Playbook Check**: Manual verification that docs instruct off-peak execution and rerun cadence (PERF-001).

## Monitoring & Follow-Up
- Add dashboard watch on Neo4j index build duration and failure events.
- Configure alert on repeated index creation failures within 1 hour (ties to TECH-001).
- Review risk profile if architecture or ingestion load changes significantly.

---
Risk profile: docs/qa/assessments/1.1-risk-20251009.md
