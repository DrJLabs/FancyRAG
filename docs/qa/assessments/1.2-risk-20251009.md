# Story 1.2 Risk Assessment — Hybrid MCP Server (2025-10-09)

## Context
- **Story ID**: 1.2
- **Epic**: Hybrid Retrieval Foundation
- **Status at Review**: Draft (pre-implementation)
- **Scope Summary**: Build a FastMCP server that instantiates a shared Neo4j driver and `HybridCypherRetriever`, exposes OAuth-protected `search` and `fetch` tools, consumes environment-driven configuration (Neo4j, embedding service, OAuth), and surfaces hybrid query responses with vector and full-text scores. `[Source: docs/stories/1.2.hybrid-mcp-server.md#story]`
- **Sources Consulted**: `docs/stories/1.2.hybrid-mcp-server.md`, `docs/architecture.md` (application architecture, security, observability, testing strategy, non-functional), `docs/architecture/tech-stack.md`, `docs/architecture/source-tree.md`, PRD Epic 1 acceptance criteria.

## Overall Risk Posture
- **Risk Gate Recommendation**: PASS — security and performance regressions are now guarded by automated tests; remaining exposure is observational.
- **Story Risk Score**: 75 / 100 (Base 100 − Low:5×2 − Mitigation credit 15 = 75).
- **Key Drivers**: Observability polish and extended latency monitoring are the only notable residual risks after auth and performance smokes landed.

## Risk Matrix

| Risk ID | Category | Description | Probability | Impact | Score | Priority | Owner | Mitigation Summary |
|---------|----------|-------------|-------------|--------|-------|----------|-------|--------------------|
| TECH-001 | Technical | Shared Neo4j driver or retriever misconfigured, leaking sessions and causing query failures under load. | Low (1) | High (3) | 3 | Low | Dev | Newly added FastMCP tool test exercises shared state; keep monitoring connection pool metrics for regressions. `[Source: tests/servers/test_runtime.py::test_build_server_registers_tools_with_shared_state]` |
| SEC-001 | Security | Google OAuth provider misconfiguration leaves MCP endpoints callable without tokens or logs secrets. | Low (1) | High (3) | 3 | Low | Dev/Infra | Stateless HTTP regression enforces 401 without bearer token and validates happy path; maintain logging scrutiny and scope checks. `[Source: tests/servers/test_runtime.py::test_stateless_http_enforces_authentication]` |
| PERF-001 | Performance | Embedding API latency/outage degrades hybrid search latency beyond ≤1.5 s target. | Low (1) | Medium (2) | 2 | Low | Dev/Ops | Latency smoke keeps hybrid search under the 1.5 s SLA; integrate into CI for continued assurance. `[Source: tests/servers/test_runtime.py::test_search_latency_within_budget]` |
| OPS-001 | Operational | Missing or incorrect environment variables prevent server startup or cause runtime crashes. | Low (1) | Medium (2) | 2 | Low | Dev/Ops | Pydantic config loader plus regression tests cover env validation; still recommend CI smoke for `/mcp/health`. `[Source: tests/test_config.py]` |
| DATA-001 | Data | Hybrid Cypher template returns incomplete payload (missing scores/metadata) breaking ChatGPT connector expectations. | Low (1) | High (3) | 3 | Low | Dev | Create contract tests validating response schema, align with story ACs, and document metadata fields. `[Source: docs/architecture.md#api--integration-contracts]` |

### Additional Notes
- Business risk is tied to ChatGPT connector availability; current mitigations rely on OAuth + monitoring reusing existing deployment posture.
- Residual security exposure hinges on correct OAuth secret management in `.env.local` and production secret stores.

## Detailed Risk Register

### TECH-001 — Connection Pool Misconfiguration
- **Signals**: MCP tool timeouts, Neo4j connection exhaustion, elevated driver error logs.
- **Mitigations**: Initialize driver once with proper close hooks, add async-safe retriever wrapper, create load-focused unit/integration tests (now partially implemented), track Bolt connection metrics. `[Source: docs/architecture.md#application-architecture]`
- **Detection**: Integration tests with parallel tool invocation; observability metrics for active sessions; CI can simulate multiple sequential searches.
- **Residual Risk**: Low given new regression coverage; retain periodic load checks.

### SEC-001 — OAuth Enforcement Gap
- **Signals**: `search` or `fetch` succeeds without bearer token; logs expose secrets or OAuth config.
- **Mitigations**: Stateless HTTP regression covers unauthorized vs authorized flows; startup validation ensures env alignment; logging remains redaction-safe. `[Source: tests/servers/test_runtime.py::test_stateless_http_enforces_authentication]`
- **Detection**: Regression suite (`uv run pytest`), curl smoke per README, static analysis for logging.
- **Residual Risk**: Low — extend to token expiry/scope mismatch in future stories.

### PERF-001 — Embedding Service Latency
- **Signals**: Response times exceed 1.5 s, increased timeout errors, retries flood service.
- **Mitigations**: Retry with capped backoff, capture latency metrics, enforce latency smoke (<1.5 s) in regression suite. `[Source: tests/servers/test_runtime.py::test_search_latency_within_budget]`
- **Detection**: Regression suite (`uv run pytest`), planned integration benchmarks, observability alerts.
- **Residual Risk**: Low; broaden to integration benchmarks as dataset grows.

### OPS-001 — Configuration Drift
- **Signals**: Startup crashes citing missing env vars, mismatched index names, or invalid OAuth base URL.
- **Mitigations**: Use typed config loader with validation, unit tests for required envs, align `.env.example` updates with docs, add CI smoke calling `/mcp/health`. `[Source: docs/architecture.md#configuration--environment]`
- **Detection**: Regression tests covering config parsing (now in place), CI smoke, manual checklist.
- **Residual Risk**: Low thanks to fail-fast config tests.

### DATA-001 — Response Schema Regression
- **Signals**: Missing `score_vector`/`score_fulltext`, metadata fields inconsistent with story ACs.
- **Mitigations**: Define response dataclass/schema validated in unit/integration tests, document expected payload fields in README/Story notes. `[Source: docs/architecture.md#api--integration-contracts]`
- **Detection**: Contract tests asserting schema, integration test verifying sample data, monitoring of connector errors.
- **Residual Risk**: Low once schema tests land.

## Risk-Based Testing Strategy

### Priority 1 — High Risks (TECH-001, SEC-001)
1. **Unit/Integration**: Concurrent tool invocation test verifying shared driver reuse without leaks.
2. **Security Integration**: Unauthorized vs authorized FastMCP calls with expected 401/200 outcomes and redaction checks.

### Priority 2 — Medium Risks (PERF-001, OPS-001)
3. **Latency Simulation**: Integration test using stub embedding service to verify retry/backoff behavior and latency metrics emission.
4. **Configuration Validation**: Unit tests ensuring missing env vars raise actionable errors; CI smoke hitting `/mcp/health`.

### Priority 3 — Low Risk (DATA-001)
5. **Contract Test**: Validate hybrid search payload includes text, metadata, both score types; ensure fetch returns labels/metadata.

## Monitoring & Follow-Up
- Instrument FastMCP with structured JSON logs and latency metrics; alert if median latency > 1.5 s. `[Source: docs/architecture.md#observability]`
- Track OAuth handshake failures and embed API timeout rates post-deployment.
- Revisit risk profile after containerization (Story 1.3) or embedding provider changes.

---
Risk profile: docs/qa/assessments/1.2-risk-20251009.md
