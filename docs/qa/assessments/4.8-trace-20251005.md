# Requirements Traceability Matrix

## Story: 4.8 - Tests and Smoke Coverage

### Coverage Summary
- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Ensure module-level unit tests cover published interfaces across CLI, pipeline, QA/report utilities, schema/config helpers, splitters, Neo4j queries, and env utilities.
**Coverage: FULL**
- `tests/unit/fancyrag/cli/test_kg_build_main.py::test_run_delegates_to_pipeline`
  - Given CLI arguments pointing to sample inputs and QA/log destinations
  - When the CLI entrypoint delegates to `run_pipeline`
  - Then a `PipelineOptions` object is constructed with semantic + QA toggles wired, proving the CLI shim maintains contract coverage.
- `tests/unit/fancyrag/kg/test_pipeline.py::test_run_pipeline_writes_log`
  - Given stubbed OpenAI settings, graph driver, and caching splitter
  - When `run_pipeline` executes against a sample text source
  - Then it returns a success payload and emits structured log records, demonstrating pipeline orchestration wiring remains intact.
- `tests/unit/fancyrag/db/test_neo4j_queries.py::test_ensure_document_relationships_builds_payload`
  - Given chunk metadata and a document path
  - When `ensure_document_relationships` runs against the recording driver
  - Then it issues the expected Cypher payload, validating Neo4j query helpers.
- `tests/unit/fancyrag/splitters/test_caching_fixed_size.py::test_run_refreshes_chunk_uids_on_reuse`
  - Given cached splitter scopes with repeated text inputs
  - When the splitter reruns within and across scopes
  - Then it regenerates chunk identifiers correctly, preserving splitter contract coverage.
- `tests/unit/fancyrag/qa/test_report.py::test_write_ingestion_report_creates_timestamped_artifacts`
  - Given sanitized ingestion QA payloads
  - When `write_ingestion_report` executes
  - Then timestamped Markdown/JSON artifacts are produced without leaking absolute paths, covering QA/report utilities.

#### AC2: Extend the integration smoke to validate packaged CLI parity with legacy `kg_build.py` workflow.
**Coverage: FULL**
- `tests/integration/local_stack/test_minimal_path_smoke.py::test_minimal_path_smoke`
  - Given Docker stack assets, environment bootstrap, and minimal-path scripts
  - When the packaged CLI runs end-to-end (vector index, kg build, qdrant export, ask, check_docs)
  - Then each command succeeds with parity assertions, confirming refactored package maintains legacy behavior.

#### AC3: Add regression coverage for schema override and environment bootstrap paths.
**Coverage: FULL**
- `tests/unit/fancyrag/config/test_init.py::test_default_schema_is_exported`
  - Given the refactored `fancyrag.config` package
  - When tests introspect exported symbols
  - Then `DEFAULT_SCHEMA` and companion helpers are present, verifying schema override contract.
- `tests/unit/fancyrag/config/test_schema.py::test_resolve_schema_path_with_home_expansion`
  - Given schema paths specified with user home expansion
  - When `resolve_schema_path` resolves the location
  - Then it expands correctly, protecting override scenarios across environments.
- `tests/unit/fancyrag/test_env_utils.py::test_ensure_env_loads_dotenv_when_env_missing`
  - Given `.env` overrides and missing process variables
  - When `ensure_env` runs
  - Then it loads values from the configured path, safeguarding bootstrap order.

#### AC4: Document test execution evidence (unit + integration) in story record and QA artifacts.
**Coverage: FULL**
- `docs/stories/4.8.tests-and-smoke.md` (QA Results, 2025-10-05 PM entry)
  - Given fresh unit (`PYTHONPATH=src pytest tests/unit/fancyrag --maxfail=1`) and integration (`LOCAL_STACK_SKIP_DOCKER_CHECK=1 OPENAI_API_KEY=test-key PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py -rs`) runs
  - When QA appended the outcomes, trace references, and gate link in the story record
  - Then reviewers can audit test evidence without rerunning suites, satisfying documentation requirements.

### Critical Gaps
- None â€” all acceptance criteria now map to executed tests or documented evidence.

### Test Design Recommendations
1. Add quick smoke validation that asserts generated QA artifacts include restored schema metadata after integration runs.
2. Capture a canned log excerpt or artifact path in QA Results to streamline future regressions.

### Risk Assessment
- **High Risk**: None
- **Medium Risk**: None
- **Low Risk**: Story requirements covered by unit + integration suites and documented evidence

Trace matrix: docs/qa/assessments/4.8-trace-20251005.md
