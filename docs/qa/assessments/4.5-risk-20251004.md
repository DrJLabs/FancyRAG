# Risk Profile: Story 4.5 (QA Report Module)

Date: 2025-10-04
Reviewer: Quinn (Test Architect)

## Executive Summary
- Total Risks Identified: 3
- Critical Risks: 0
- High Risks: 1
- Medium Risks: 1
- Low Risks: 1
- Overall Risk Posture: Low-to-Moderate; mitigations hinge on tightening path handling and rerunning local smoke coverage.

## Context
Story 4.5 extracts ingestion QA report generation from `fancyrag.qa.evaluator` into the new `src/fancyrag/qa/report.py` helper module, keeping the evaluator and pipeline focused on metrics and gating. The module now owns JSON and Markdown rendering, relies on `relative_to_repo` to expose file paths, and is invoked by `IngestionQaEvaluator.evaluate` whenever the KG build pipeline emits QA artefacts.

## Risk Matrix

| Risk ID  | Category   | Description | Probability | Impact | Score | Priority |
|----------|------------|-------------|-------------|--------|-------|----------|
| TECH-001 | Technical  | Returning report paths relative to `qa_report_dir` breaks downstream consumers when operators point reports outside the repository tree | Medium (2) | High (3) | 6 | High |
| DATA-001 | Data       | Markdown/JSON writers surface absolute source paths when ingestion runs against directories outside the repo, leaking filesystem details into artefacts | Medium (2) | Medium (2) | 4 | Medium |
| OPS-001  | Operational| Timestamp-only folder naming overwrites QA artefacts for runs executed within the same second | Low (1) | Medium (2) | 2 | Low |

## Risk Details & Mitigations

### TECH-001 – Report path resolution drift (Score 6, High)
- **Affected components:** `src/fancyrag/qa/report.py:25-49`, `fancyrag.utils.paths.relative_to_repo`, `src/fancyrag/kg/pipeline.py:1548-1579`, `tests/unit/scripts/test_kg_build.py:360-405`.
- **Drivers:** `write_ingestion_report` now returns strings relative to the configured `qa_report_dir`. When operators pass an absolute directory outside the repo (common for mounted volumes), the CLI log stores `20251004T123000/quality_report.json`. Downstream tooling resolves paths relative to the repo root (`kg_pipeline._resolve_repo_root()`), so the artefact becomes unresolvable even though files exist, breaking diagnostics and archival flows.
- **Mitigation Strategy:**
  - Update `write_ingestion_report` to emit repo-relative paths when possible else absolute paths, and add a regression test that runs `kg.run` with `--qa-report-dir` pointing to `tmp_path` to ensure logs remain dereferenceable.
  - Consider serialising both the stored relative path and the absolute URI when the base directory lives outside the repo.
- **Residual Risk:** Medium until the path contract covers out-of-tree report directories; current behaviour blocks operators relying on shared mounts.

### DATA-001 – Source path leakage (Score 4, Medium)
- **Affected components:** `src/fancyrag/qa/report.py:52-109`, `_relative_to_repo` usage in `src/fancyrag/kg/pipeline.py:1388-1406`, QA artefact consumers.
- **Drivers:** When ingestion sources sit outside the repo tree, `_relative_to_repo` falls back to returning absolute paths. `scrub_object` treats keys like `relative_path` as non-sensitive, so both JSON and Markdown now embed full filesystem locations (e.g., `/mnt/customer-data/doc.txt`). This exposure travels with QA artefacts and contradicts the sanitisation goal of Story 4.5.
- **Mitigation Strategy:**
  - Extend sanitisation to redact absolute paths before rendering (e.g., normalise to filenames or replace mount prefixes with `***`).
  - Add unit coverage in `tests/unit/fancyrag/qa/test_report.py` that feeds absolute paths and asserts the Markdown omits host-specific prefixes.
  - Document the expectation in Story 4.x docs so operators know when absolutes are accepted versus redacted.
- **Residual Risk:** Medium; leakage persists until sanitisation defends against out-of-tree source directories.

### OPS-001 – Report timestamp collisions (Score 2, Low)
- **Affected components:** `src/fancyrag/qa/report.py:33-47`, evaluator integration loops.
- **Drivers:** Report folders are named using `timestamp.strftime("%Y%m%dT%H%M%S")`; sequential QA evaluations within the same second (e.g., reruns during integration smoke) collide and overwrite artefacts, erasing evidence of failing runs.
- **Mitigation Strategy:**
  - Incorporate monotonic suffixes (microseconds or a UUID) when a folder already exists before writing.
  - Track collisions via a regression test that invokes `write_ingestion_report` twice with the same timestamp and asserts unique output folders.
- **Residual Risk:** Low once collision avoidance lands; current exposure mainly affects fast local reruns or automated retries.

## Recommendations Summary
- **Must Fix Before Merge:**
  - Restore report path compatibility for out-of-tree QA directories (TECH-001).
- **Monitor Post-Merge:**
  - Harden sanitisation against absolute path leakage and validate via targeted unit tests (DATA-001).
  - Add collision handling for timestamped folders in a follow-up to reduce rerun fragility (OPS-001).

## Risk Summary YAML (for gate file)
```yaml
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 1
    low: 1
  highest:
    id: TECH-001
    score: 6
    title: "Report path contract breaks when qa_report_dir leaves repo"
  recommendations:
    must_fix:
      - "Emit repo-relative or absolute report paths that remain resolvable outside the repo"
    monitor:
      - "Redact absolute source paths and add timestamp collision guards"
```

## Residual & Follow-up Actions
- Capture backlog issue to adjust report path serialisation and add CLI coverage for external QA directories.
- Queue sanitisation enhancement to mask absolute source paths in QA artefacts.
- Plan a follow-up to append collision-resistant suffixes when stamping report folders.
