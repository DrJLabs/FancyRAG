# Story 1.3 Risk Assessment — Containerized Deployment (2025-10-09)

## Context
- **Story ID**: 1.3
- **Epic**: Hybrid Retrieval Foundation
- **Status at Review**: Draft (pre-implementation)
- **Scope Summary**: Package the FastMCP server into a Docker image, wire it into `docker-compose.yml` alongside Neo4j on the `rag-net` network, document operational workflows, and add automation that proves the containerized stack starts, passes health checks, and serves hybrid search results. `[Source: docs/stories/1.3.containerized-deployment.md#story]`
- **Sources Consulted**: `docs/stories/1.3.containerized-deployment.md`, `docs/epics/epic-1-hybrid-retrieval-foundation.md`, `docs/architecture.md` (infrastructure, deployment pipeline, observability), `.env.example`, `Makefile`.

## Overall Risk Posture
- **Risk Gate Recommendation**: PASS WITH CONCERNS — containerization is well defined, but registry hygiene and secret handling need disciplined automation.
- **Story Risk Score**: 70 / 100 (Base 100 − Low:5×4 − Mitigation credit 10 = 70).
- **Key Drivers**: Image supply chain hygiene (build reproducibility, tag management) and configuration leakage represent the largest exposures.

## Risk Matrix

| Risk ID | Category | Description | Probability | Impact | Score | Priority | Owner | Mitigation Summary |
|---------|----------|-------------|-------------|--------|-------|----------|-------|--------------------|
| BUILD-001 | Build | Docker image lacks reproducibility (missing pinned base/tag) leading to drift between environments. | Medium (2) | High (3) | 6 | Medium | Dev/Ops | Story tasks call for canonical `docker build`/tag guidance and frozen `uv` lock use; integrate digest pinning in docs/CI to ensure determinism. `[Source: docs/stories/1.3.containerized-deployment.md#tasks--subtasks]` |
| SEC-002 | Security | Secrets accidentally baked into the container or Compose leaks `.env.local` contents into image layers. | Low (1) | High (3) | 3 | Medium | Dev/Ops | Use Compose `env_file` injection, ensure Dockerfile ignores `.env.local`, and add CI scan blocking secret presence; document redaction checks. `[Source: docs/stories/1.3.containerized-deployment.md#tasks--subtasks]` |
| OPS-003 | Operational | Healthcheck/smoke automation misses ingest seeding, causing false negatives or silent failures in `/mcp/search`. | Medium (2) | Medium (2) | 4 | Medium | Dev/QA | Smoke scenario must ingest sample data prior to search and assert response schema; automated via `tests/integration/test_container_smoke.py`. `[Source: docs/stories/1.3.containerized-deployment.md#tasks--subtasks]` |
| PERF-004 | Performance | Containerized MCP stalls due to insufficient resources or lack of retry tuning, breaking the ≤1.5 s latency goal. | Low (1) | Medium (2) | 2 | Low | Dev | Retain Story 1.2 latency tests, monitor container resource requests, and document tuning knobs. `[Source: docs/qa/assessments/1.2-test-design-20251009.md#test-scenarios-by-acceptance-criteria]` |
| REL-005 | Reliability | Compose orchestration does not wait for Neo4j readiness, leading to failed MCP startup and manual intervention. | Medium (2) | Medium (2) | 4 | Medium | Dev/Ops | Add `depends_on` + healthcheck sequencing and include readiness retry logic in smoke tests; surface actionable logs. `[Source: docs/stories/1.3.containerized-deployment.md#tasks--subtasks]` |
| DOC-006 | Documentation | Operators miss critical steps (build tags, health verification), causing inconsistent deployments or unverified releases. | Medium (2) | Low (1) | 2 | Low | PO/Dev | README documents `docker compose build mcp`, `make up/make logs`, health checks, and optional static token workflow; link to runbook updates. `[Source: docs/stories/1.3.containerized-deployment.md#tasks--subtasks]` |

### Additional Notes
- Security risk remains elevated while CI secret scanning is manual; consider adding automated `trufflehog`/`gitleaks` job before production rollout.
- Consider capturing image digests in release notes per architecture deployment guidance to close the loop on BUILD-001.

## Detailed Risk Register

### BUILD-001 — Image Drift & Reproducibility
- **Signals**: Different environments run images with divergent dependencies; unexpected regressions despite matching tags.
- **Mitigations**: Use `uv.lock` during build, define canonical tagging (e.g., `ghcr.io/<org>/fancryrag-mcp:<git-sha>`), record digest in docs/tests.
- **Detection**: CI pipeline verifying docker build uses lockfile and outputs digest; smoke tests compare reported version metadata.
- **Residual Risk**: Medium until digest capture automated.

### SEC-002 — Secret Leakage in Image
- **Signals**: Secrets visible in `docker history` or environment variables bundled into image at build-time.
- **Mitigations**: `.dockerignore` `.env*`, rely on Compose `env_file`, run secret scanning on built image (e.g., `trivy --scanners secret`).
- **Detection**: CI scanning, manual review of image layers, runtime logs ensuring secrets not printed.
- **Residual Risk**: Low with automation.

### OPS-003 — Smoke Test Seed Gap
- **Signals**: Smoke passes without validating search results; MCP returns empty array despite service being unhealthy.
- **Mitigations**: Seed sample data via `make ingest`/fixture before `/mcp/search`; automated pytest `tests/integration/test_container_smoke.py` asserts non-empty payloads after seeding.
- **Detection**: Integration smoke in CI; local run instructions verifying ingest prior to search.
- **Residual Risk**: Medium until smoke test implemented.

### PERF-004 — Container Latency Regression
- **Signals**: `/mcp/search` latency exceeds 1.5 s when running in container vs local process.
- **Mitigations**: Reuse Story 1.2 latency tests within container context; document CPU/memory tuning; monitor logs for retry bursts.
- **Detection**: Extend performance smoke to log latency metrics and fail on threshold.
- **Residual Risk**: Low.

### REL-005 — Startup Orchestration Failure
- **Signals**: MCP exits because Neo4j bolt unreachable; repeated manual restarts required.
- **Mitigations**: `depends_on` with healthcheck, MCP retry logic, explicit logging of connection retries.
- **Detection**: Compose healthcheck results, smoke test verifying sequential readiness.
- **Residual Risk**: Medium.

- **Signals**: Operators skip tagging or health verification; inconsistent staging deployments.
- **Mitigations**: README updates with explicit commands (`docker compose build mcp`, `make up`, `make logs`, healthcheck curl) and optional static token guidance for automation.
- **Detection**: PO review of docs; QA checklists referencing runbook.
- **Residual Risk**: Low once docs updated.

## Risk-Based Testing Strategy

1. **Image Integrity & Secrets (BUILD-001, SEC-002)**
   - Add CI guard that builds the image, runs `trivy`/`grype` and secret scanners, and verifies digest recorded. Failure blocks merge.
2. **Operational Readiness (OPS-003, REL-005)**
   - End-to-end smoke spins up Compose, ingests sample data, polls health endpoints, and validates search response schema with non-empty results.
3. **Performance Regression (PERF-004)**
   - Measure `/mcp/search` latency inside containerized stack; alert if median > 1.5 s.

## Monitoring & Follow-Up
- Extend CI to publish container digest + metadata to release notes per deployment pipeline guidance. `[Source: docs/architecture.md#deployment-pipeline]`
- Schedule recurring secret scans on published images.
- Verify documentation updates before PO sign-off.

---
Risk profile: docs/qa/assessments/1.3-risk-20251009.md
