# Test Design: Story 2.3

Date: 2025-09-28
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 12
- Unit tests: 9 (75%)
- Integration tests: 3 (25%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 9, P1: 3, P2: 0, P3: 0

Matrix validates the shared OpenAI client abstraction, readiness probe integration, configuration toggles, and telemetry/secret handling. Risks addressed: TECH-230, DATA-230, PERF-230, OPS-230, SEC-230 from docs/qa/assessments/2.3-risk-20250928.md.

## Test Scenarios by Acceptance Criteria

### AC1: Shared client centralises chat/embedding helpers with guardrails and fallbacks.
| ID              | Level | Priority | Test Description                                                                                     | Justification                                                    | Mitigates |
|-----------------|-------|----------|-------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|-----------|
| 2.3-UNI-001     | Unit  | P0       | Instantiate shared client without overrides; assert baseline chat model == `gpt-4.1-mini` and embedding dims 1536. | Confirms defaults align with PRD/architecture expectations.     | TECH-230 |
| 2.3-UNI-002     | Unit  | P0       | Request unsupported chat model; expect structured error with actor + supplied value logged via redaction helper. | Prevents drift from allowlist and surfaces remediation guidance. | TECH-230, SEC-230 |
| 2.3-UNI-003     | Unit  | P0       | Enable fallback flag; verify helper selects `gpt-4o-mini`, records override telemetry, and returns response payload. | Validates documented fallback behaviour without duplication.     | TECH-230, OPS-230 |
| 2.3-UNI-004     | Unit  | P0       | Call embedding helper with 1536-length vector; expect pass/no logs.                                   | Happy path coverage for embeddings.                              | DATA-230 |
| 2.3-UNI-005     | Unit  | P0       | Inject 1400-length vector; expect `ValueError` referencing override guidance and structured log event. | Detects dimension mismatches early.                              | DATA-230 |
| 2.3-UNI-006     | Unit  | P1       | Configure override dimension=3072 via settings; ensure helper honours override and records audit event. | Confirms intentional override flow and telemetry interplay.      | DATA-230, OPS-230 |

### AC2: Readiness probe consumes shared client with unchanged CLI, artifacts, and metrics.
| ID              | Level | Priority | Test Description                                                                                     | Justification                                                    | Mitigates |
|-----------------|-------|----------|-------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|-----------|
| 2.3-INT-007     | Integration | P0 | Run readiness probe with stubbed OpenAI responses; diff metrics/artifacts versus fixture baselines.   | Guarantees schema/label stability for dashboards.                | OPS-230 |
| 2.3-INT-008     | Integration | P0 | Ensure CLI flags/output remain identical (exit codes, report paths) after wrapper integration.       | Prevents regressions for automation scripts.                     | OPS-230 |
| 2.3-UNI-009     | Unit  | P1       | Verify migration guide generator emits checklist entries for ingest/retrieval pipelines adopting wrapper. | Supports adoption path per AC2.                                 | OPS-230 |

### AC3: Configurable retries/backoff, fallback toggles, and override documentation.
| ID              | Level | Priority | Test Description                                                                                     | Justification                                                    | Mitigates |
|-----------------|-------|----------|-------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|-----------|
| 2.3-UNI-010     | Unit  | P0       | Simulate `Retry-After` header; ensure exponential backoff honours ceiling, respects header value, and logs delay. | Validates retry strategy during throttling.                      | PERF-230 |
| 2.3-UNI-011     | Unit  | P0       | Configure retry overrides via settings; assert configuration surfaces in telemetry and docs snippet. | Confirms operators can tune behaviour safely.                    | PERF-230, OPS-230 |
| 2.3-UNI-012     | Unit  | P0       | Render documentation helper generating cost/latency table for baseline vs fallback; ensure values match architecture guidance. | Keeps operator guidance aligned with documentation SLOs.        | PERF-230 |

### AC4: Tests stub chat/embedding calls verifying fallbacks, overrides, metrics, and redacted logs across entrypoints.
| ID              | Level | Priority | Test Description                                                                                     | Justification                                                    | Mitigates |
|-----------------|-------|----------|-------------------------------------------------------------------------------------------------------|------------------------------------------------------------------|-----------|
| 2.3-INT-013     | Integration | P0 | Invoke shared client directly and via readiness probe with fake responses; assert metrics counters, histograms, and labels stay encoded + redacted. | Confirms parity between helper usage contexts.                   | TECH-230, OPS-230, SEC-230 |
| 2.3-UNI-014     | Unit  | P0       | Feed payload containing `api_key`, `authorization`, and prompt strings into logging path; confirm redaction masks before log sink. | Protects against secret leakage after centralisation.            | SEC-230 |
| 2.3-INT-015     | Integration | P1 | Run minimal path script harness (feature flagged) with shared client stub; ensure fallback path increments telemetry and returns grounded answer stub. | Ensures downstream pipelines tolerate wrapper adoption.          | DATA-230, OPS-230 |

## Risk Coverage
- TECH-230: 2.3-UNI-001, 2.3-UNI-002, 2.3-UNI-003, 2.3-INT-013
- DATA-230: 2.3-UNI-004, 2.3-UNI-005, 2.3-UNI-006, 2.3-INT-015
- PERF-230: 2.3-UNI-010, 2.3-UNI-011, 2.3-UNI-012
- OPS-230: 2.3-UNI-003, 2.3-INT-007, 2.3-INT-008, 2.3-UNI-009, 2.3-UNI-011, 2.3-INT-013, 2.3-INT-015
- SEC-230: 2.3-UNI-002, 2.3-UNI-014, 2.3-INT-013

## Recommended Execution Order
1. 2.3-UNI-001
2. 2.3-UNI-002
3. 2.3-UNI-004
4. 2.3-UNI-005
5. 2.3-UNI-010
6. 2.3-UNI-014
7. 2.3-UNI-003
8. 2.3-UNI-006
9. 2.3-UNI-011
10. 2.3-UNI-012
11. 2.3-INT-007
12. 2.3-INT-008
13. 2.3-INT-013
14. 2.3-INT-015
15. 2.3-UNI-009

## Gate Snippet
```yaml
test_design:
  scenarios_total: 12
  by_level:
    unit: 9
    integration: 3
    e2e: 0
  by_priority:
    p0: 9
    p1: 3
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Trace Hook
Test design matrix: docs/qa/assessments/2.3-test-design-20250928.md
P0 tests identified: 9

## ðŸ”¬ Research & Validation Log
- Mode: solo (2025-09-28)
- Findings: Scenario set mirrors acceptance criteria and risk mitigations, keeps metrics/artefacts frozen, and enforces guardrails for model allowlist, embedding dimensions, and secret masking.
- Sources: docs/stories/2.3.openai-shared-client.md, docs/qa/assessments/2.3-risk-20250928.md, docs/architecture/overview.md#openai-readiness-probe, docs/architecture/coding-standards.md#testing-expectations
- Residual Risks: Async client strategy remains undecided; flag follow-up once architecture guidance lands.
- Next Actions: Dev agent to implement P0 tests before merge, coordinate with observability to validate metrics fixtures, update docs with cost/latency tables alongside configuration guidance.
