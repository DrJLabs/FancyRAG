# Requirements Traceability Matrix

## Story: 5.2 - Centralise Typed Settings

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 5 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Introduce `FancyRAGSettings` aggregate with nested service settings
**Coverage: FULL**
- Unit Test: `tests/unit/config/test_fancyrag_settings.py::test_load_returns_cached_instance`
  - Given: Baseline environment values for OpenAI, Neo4j, and Qdrant.
  - When: `FancyRAGSettings.load()` is called twice.
  - Then: The second call returns the cached instance, proving the aggregate enforces single-source configuration.
- Unit Test: `tests/unit/config/test_fancyrag_settings.py::test_load_refresh_updates_values`
  - Given: A modified `NEO4J_URI` after initial load.
  - When: `FancyRAGSettings.load(refresh=True)` executes.
  - Then: The refreshed settings capture the new URI and update the cache, validating typed reload paths.
- Unit Test: `tests/unit/config/test_fancyrag_settings.py::test_missing_required_variable_raises`
  - Given: `OPENAI_API_KEY` removed from the environment.
  - When: `FancyRAGSettings.load()` runs.
  - Then: Loading fails with a `ValueError`, confirming fast failure for missing credentials.

#### AC2: Replace direct `ensure_env` / `os.environ[...]` usages with typed settings
**Coverage: FULL**
- Unit Test: `tests/unit/scripts/test_create_vector_index.py::test_run_invokes_get_settings_once`
  - Given: `get_settings` patched with a counter and `ensure_env` forced to fail if invoked.
  - When: `create_vector_index.run` executes.
  - Then: `get_settings` is called exactly once and `ensure_env` is untouched, confirming the CLI relies solely on typed settings.
- Unit Test: `tests/unit/scripts/test_export_to_qdrant.py::TestMain::test_main_calls_get_settings_once`
  - Given: Stubbed `get_settings` and Qdrant/Neo4j clients.
  - When: `export_to_qdrant.main()` runs.
  - Then: Only a single typed settings lookup occurs and export succeeds, proving cached settings feed the workflow.
- Unit Test: `tests/unit/scripts/test_ask_qdrant.py::test_main_calls_get_settings_once`
  - Given: `ensure_env` patched to raise if called.
  - When: `ask_qdrant.main()` embeds a query and retrieves matches.
  - Then: The CLI accesses typed settings exactly once, demonstrating legacy helpers are bypassed in the happy path.

#### AC3: Update onboarding documentation to describe the consolidated configuration surface
**Coverage: FULL**
- Doc Lint: `scripts/check_docs.py` now enforces the migration checklist tokens via the `typed-settings-migration-checklist` rule, and `tests/unit/scripts/test_check_docs.py::test_main_passes_when_all_tokens_present` exercises the happy path.
- Doc Lint Negative: `tests/unit/scripts/test_check_docs.py::test_main_fails_when_migration_table_missing` proves the lint fails when the checklist content drifts, closing AC3 automation.

#### AC4: Add unit tests covering settings fallback, overrides, and error paths
**Coverage: FULL**
- Unit Test: `tests/unit/config/test_fancyrag_settings.py::test_missing_required_variable_raises`
  - Given: `OPENAI_API_KEY` removed.
  - When: `FancyRAGSettings.load()` executes.
  - Then: The call raises a `ValueError`, covering missing required paths.
- Unit Test: `tests/unit/config/test_fancyrag_settings.py::test_invalid_qdrant_url_rejected`
  - Given: `QDRANT_URL` set to an unsupported scheme.
  - When: `FancyRAGSettings.load()` runs.
  - Then: Validation fails with an actionable error, covering Qdrant validators.
- Unit Test: `tests/unit/config/test_fancyrag_settings.py::test_export_environment_round_trip`
  - Given: Loaded settings.
  - When: `export_environment()` runs.
  - Then: The serialized mapping preserves secrets and overrides, satisfying export expectations.

#### AC5: Publish an `.env` migration checklist with legacy mapping and rollback guidance
**Coverage: FULL**
- Unit Test: `tests/unit/config/test_env_template.py::test_env_template_contains_required_keys`
  - Still guards `.env.example` placeholders against drift.
- Doc Lint: `scripts/check_docs.py` `typed-settings-migration-checklist` rule ensures the migration table mirrors the typed settings contract; `tests/unit/scripts/test_check_docs.py::test_main_fails_when_migration_table_missing` verifies the lint catches omissions.

### Critical Gaps

- None — all acceptance criteria have automated coverage with typed settings validation, CLI caching checks, and documentation lint in place.

### Test Design Recommendations

- Maintain the dedicated `test_fancyrag_settings.py` suite alongside CLI regression tests to catch future changes to caching or env mappings.
- Keep the documentation lint rule updated as new settings fields or checklist steps are introduced.

### Risk Assessment

- **Residual Risk:** Low — typed settings validation and docs lint now fail fast when configuration or checklist drift occurs.

Trace matrix: docs/qa/assessments/5.2-trace-20251007.md
