# Test Design: Story 3.5 – Semantic Enrichment Pipeline & Retrieval Surfacing

Date: 2025-10-02
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 9
- Unit tests: 4 (44%)
- Integration tests: 4 (44%)
- E2E tests: 1 (12%)
- Priority distribution: P0: 6, P1: 3, P2: 0

## Test Scenarios by Acceptance Criteria

### AC1 – Extractor Integration & Metadata Persistence

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.5-UNIT-001 | unit | P0 | Validate CLI flag/settings wire `LLMEntityRelationExtractor` correctly and fall back to legacy path when disabled. | Pure configuration logic; catches regressions before hitting services (TECH-201, OPS-203). |
| 3.5-UNIT-002 | unit | P0 | Ensure entity/relationship serialization carries relative path, git commit, checksum metadata into graph payloads. | Protects mandatory metadata propagation without external IO (DATA-202). |
| 3.5-INT-001 | integration | P0 | Run `kg_build` with semantic mode enabled against fixture corpus verifying nodes created and rollback leaves clean graph on forced extractor failure. | Validates end-to-end enrichment & rollback semantics (TECH-201). |

### AC2 – Semantic QA Gating & Thresholds

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.5-UNIT-003 | unit | P0 | Exercise QA evaluator to confirm semantic metrics (entity counts, orphan ratio, extractor errors) appear in reports and respect configurable thresholds. | Guards gating logic without container cost (OPS-203). |
| 3.5-INT-002 | integration | P0 | Trigger synthetic anomaly (e.g., orphaned entities) in ingestion run to assert gating failure includes actionable remediation and prevents writes. | Validates failure path interacting with real artefacts (OPS-203, DATA-202). |

### AC3 – Retrieval Surfacing & Documentation

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.5-UNIT-004 | unit | P1 | Check `ask_qdrant` sanitization emits optional semantic section without altering legacy match schema. | Ensures backward compatibility at low cost (DATA-202, OPS-205). |
| 3.5-INT-003 | integration | P1 | Compose CLI test confirming sanitized artefact + stdout remain schema-compatible while surfacing semantic context toggled on/off. | Validates consumer-facing payloads with live services (DATA-202). |
| 3.5-E2E-001 | e2e | P1 | Run documentation lint guard to confirm architecture shards reference semantic workflow updates. | Keeps operator playbook aligned with new feature (OPS-205). |

### AC4 – Automated Coverage & Performance Guardrails

| ID | Level | Priority | Test | Justification |
| --- | --- | --- | --- | --- |
| 3.5-INT-004 | integration | P0 | Execute minimal-path compose smoke with semantic mode enabled, capturing runtime/token telemetry and verifying QA artefacts, retrieval output, and docs lint all pass. | Proves holistic pipeline remains green within runtime budget (TECH-201, PERF-204, OPS-203). |

## Risk Coverage Mapping
- TECH-201 mitigated by 3.5-UNIT-001, 3.5-INT-001, 3.5-INT-004.
- DATA-202 mitigated by 3.5-UNIT-002, 3.5-INT-002, 3.5-UNIT-004, 3.5-INT-003.
- OPS-203 mitigated by 3.5-UNIT-003, 3.5-INT-002, 3.5-INT-004.
- PERF-204 mitigated by 3.5-INT-004 (runtime/token telemetry capture).
- OPS-205 mitigated by 3.5-UNIT-004, 3.5-E2E-001.

## Recommended Execution Order
1. Execute P0 unit tests (3.5-UNIT-001, 3.5-UNIT-002, 3.5-UNIT-003) for rapid feedback.
2. Run P0 integration suite (3.5-INT-001, 3.5-INT-002, 3.5-INT-004).
3. Complete P1 integration/E2E scenarios (3.5-INT-003, 3.5-E2E-001) and finish with P1 unit regression (3.5-UNIT-004).

```yaml
test_design:
  scenarios_total: 9
  by_level:
    unit: 4
    integration: 4
    e2e: 1
  by_priority:
    p0: 6
    p1: 3
    p2: 0
  coverage_gaps: []
```

Test design matrix: docs/qa/assessments/3.5-test-design-20251002.md
P0 tests identified: 6
