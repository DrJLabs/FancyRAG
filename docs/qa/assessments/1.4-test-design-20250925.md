# Test Design: Story 1.4

Date: 2025-09-25
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 6
- Unit tests: 3 (50%)
- Integration tests: 3 (50%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 2, P1: 4, P2: 0, P3: 0

Strategy targets guard-rail correctness (blocking versus override), logging provenance, and documentation alignment. Scenarios map to risks TECH-401, TECH-402, OPS-401 from the risk profile. Implemented coverage resides in `tests/unit/cli/test_stories.py` and `tests/integration/cli/test_story_override_cli.py`.

## Test Scenarios by Acceptance Criteria

### AC1: Guard requires explicit override confirmation when prior story not `Done`
| ID            | Level | Priority | Test Description | Justification | Mitigates |
|---------------|-------|----------|------------------|--------------|-----------|
| 1.4-UNI-001   | Unit  | P0       | Call `guard_next_story` with prior status `Ready for Review` and `override=False`; expect `StoryValidationError`. | Blocks inadvertent bypass in pure logic path. | TECH-401 |
| 1.4-INT-001   | Integration | P0 | Invoke CLI without `--override-incomplete`; expect exit code 1 and guard message. | Proves CLI wraps guard in repo-like environment. | TECH-401 |

### AC2: Override captures risk acknowledgement and logs metadata
| ID            | Level | Priority | Test Description | Justification | Mitigates |
|---------------|-------|----------|------------------|--------------|-----------|
| 1.4-UNI-002   | Unit  | P1       | Call `guard_next_story` with override enabled and existing story file; assert risk note injected and log entry created. | Validates note + log generation without CLI. | TECH-402, OPS-401 |
| 1.4-INT-002   | Integration | P1 | Run CLI with override flags; inspect `docs/bmad/story-overrides.md` and new story for injected note. | Ensures CLI path writes artifacts for auditing. | TECH-402, OPS-401 |

### AC3: Documentation instructs how to perform overrides safely
| ID            | Level | Priority | Test Description | Justification | Mitigates |
|---------------|-------|----------|------------------|--------------|-----------|
| 1.4-INT-003   | Integration | P1 | Markdown lint/manual review verifying epic guidance/AGENTS updates reference the CLI command and log stewardship. | Confirms operator documentation reflects new workflow. | OPS-401 |

### AC4: Automated tests cover blocking, approved override, and rejection paths
| ID            | Level | Priority | Test Description | Justification | Mitigates |
|---------------|-------|----------|------------------|--------------|-----------|
| 1.4-UNI-003   | Unit  | P1       | Verify guard creates story shell and note when `new_story` missing. | Ensures repeated overrides behave predictably. | TECH-402 |
| 1.4-INT-004   | Integration | P1 | Re-run CLI override after initial generation to confirm idempotent note/log behaviour (covered implicitly in test suite). | Detects structural corruption on re-entry. | TECH-402 |

## Risk Coverage
- TECH-401: 1.4-UNI-001, 1.4-INT-001
- TECH-402: 1.4-UNI-002, 1.4-UNI-003, 1.4-INT-002, 1.4-INT-004
- OPS-401: 1.4-INT-002, 1.4-INT-003

## Recommended Execution Order
1. 1.4-UNI-001
2. 1.4-UNI-002
3. 1.4-UNI-003
4. 1.4-INT-001
5. 1.4-INT-002
6. 1.4-INT-003
7. 1.4-INT-004 (when multi-override scenario executed)

## Execution Status
- ‚úÖ Unit coverage implemented in `tests/unit/cli/test_stories.py` (UNI-001, UNI-002, UNI-003).
- ‚úÖ Integration coverage implemented in `tests/integration/cli/test_story_override_cli.py` (INT-001, INT-002).
- ‚ö†Ô∏è Documentation lint/manual check performed during review (INT-003). No automated lint yet.
- ‚ö†Ô∏è Repeat override scenario relies on manual validation; consider future extension test (INT-004).

## Gate Snippet
```yaml
test_design:
  scenarios_total: 6
  by_level:
    unit: 3
    integration: 3
    e2e: 0
  by_priority:
    p0: 2
    p1: 4
    p2: 0
    p3: 0
  coverage_gaps:
    - No automated doc lint yet; rely on reviewer sign-off (AC3).
```

## Trace Hook
Test design matrix: docs/qa/assessments/1.4-test-design-20250925.md
P0 tests identified: 2

## üî¨ Research & Validation Log
- Mode: solo (2025-09-25)
- Findings: Guard coverage sufficient across unit/integration layers; documentation updates cross-link command usage; residual doc lint reliance noted for follow-up.
- Sources: src/cli/stories.py, tests/unit/cli/test_stories.py, tests/integration/cli/test_story_override_cli.py, .bmad-core/tasks/create-next-story.md, docs/bmad/focused-epics/environment-workspace/epic.md.
- Residual Risks: Consider markdown lint automation; monitor override log growth.
- Next Actions: Incorporate CLI guard invocation into BMAD automation pipeline.
