# Test Design: Story 2.1

Date: 2025-09-25
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 11
- Unit tests: 8 (73%)
- Integration tests: 3 (27%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 8, P1: 3, P2: 0, P3: 0

Strategy validates the GPT-4.1 mini baseline configuration, embedding-dimension guardrails, and telemetry instrumentation that feeds Prometheus/Grafana while preserving secrecy. Risks addressed: TECH-210, DATA-210, OPS-210, SEC-210 from the 2025-09-25 risk profile.

## Test Scenarios by Acceptance Criteria

### AC1: Centralised OpenAI chat configuration with enforced defaults and safe fallbacks.
| ID              | Level | Priority | Test Description                                                                                 | Justification                                                       | Mitigates |
|-----------------|-------|----------|-------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|-----------|
| 2.1-UNI-001     | Unit  | P0       | Instantiate `OpenAISettings` without overrides; assert baseline model == `gpt-4.1-mini`.        | Guarantees default aligns with PRD and doc guidance.               | TECH-210 |
| 2.1-UNI-002     | Unit  | P0       | Pass unsupported model override; expect `ValidationError` with actor + supplied value logged.   | Blocks unsafe model usage and surfaces actionable diagnostics.     | TECH-210 |
| 2.1-INT-003     | Integration | P1 | Simulate CLI override to `gpt-4o-mini`; ensure structured log records override flag + actor id. | Confirms fallback path documented and observable.                  | TECH-210, OPS-210 |

### AC2: Embedding helper enforces 1536-dimension vectors with override support.
| ID              | Level | Priority | Test Description                                                                                 | Justification                                                       | Mitigates |
|-----------------|-------|----------|-------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|-----------|
| 2.1-UNI-004     | Unit  | P0       | Call `ensure_embedding_dimensions()` with 1536-length array; expect pass and no logging noise.   | Validates happy path for standard embedding size.                  | DATA-210 |
| 2.1-UNI-005     | Unit  | P0       | Provide 1400-length embedding; assert `ValueError` message suggests remediation + override hint. | Detects dimension drift before ingestion.                          | DATA-210 |
| 2.1-UNI-006     | Unit  | P1       | Configure override dimension=3072; verify helper honours override and records structured event. | Ensures intentional overrides function without false positives.    | DATA-210 |
| 2.1-UNI-010     | Unit  | P0       | Attempt override to 4096 dimensions; expect helper to reject with remediation guidance and structured audit log. | Prevents misuse of override flag from bypassing guardrails. | DATA-210 |

### AC3: Telemetry exports latency/token metrics with Prometheus/Grafana compatibility and alerts.
| ID              | Level | Priority | Test Description                                                                                 | Justification                                                       | Mitigates |
|-----------------|-------|----------|-------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|-----------|
| 2.1-INT-007     | Integration | P0 | Stub chat + embedding calls; confirm metrics exporter emits latency/token counters + cost histograms with labels {model, operation} and p95 bucket coverage. | Provides observable telemetry for alerting and SLOs.               | OPS-210 |
| 2.1-INT-008     | Integration | P1 | Validate metrics registry exposes scrape endpoint with alert threshold annotations documented and matches Grafana playbook thresholds. | Ensures Grafana alert thresholds are testable and documented.      | OPS-210 |
| 2.1-UNI-011     | Unit  | P0       | Parse `docs/alerts/openai-telemetry.yml`; assert baseline/fallback thresholds, review freshness, and Grafana panel UIDs. | Keeps alert playbook aligned with CI expectations and documented envelopes. | OPS-210 |

### AC4: Automated tests confirm logging behaviour and secret masking.
| ID              | Level | Priority | Test Description                                                                                 | Justification                                                       | Mitigates |
|-----------------|-------|----------|-------------------------------------------------------------------------------------------------|---------------------------------------------------------------------|-----------|
| 2.1-UNI-009     | Unit  | P0       | Feed fake payload containing `api_key`, `authorization`, and `bearer` tokens into telemetry formatter; assert output redacts secrets. | Prevents leakage of sensitive data in metrics/logs.                | SEC-210 |

## Risk Coverage
- TECH-210: 2.1-UNI-001, 2.1-UNI-002, 2.1-INT-003
- DATA-210: 2.1-UNI-004, 2.1-UNI-005, 2.1-UNI-006, 2.1-UNI-010
- OPS-210: 2.1-INT-003, 2.1-INT-007, 2.1-INT-008
- SEC-210: 2.1-UNI-009

## Recommended Execution Order
1. 2.1-UNI-001
2. 2.1-UNI-002
3. 2.1-UNI-004
4. 2.1-UNI-005
5. 2.1-UNI-010
6. 2.1-UNI-006
7. 2.1-UNI-011
8. 2.1-UNI-009
9. 2.1-INT-003
10. 2.1-INT-007
11. 2.1-INT-008

## Gate Snippet
```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 8
    integration: 3
    e2e: 0
  by_priority:
    p0: 8
    p1: 3
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Trace Hook
Test design matrix: docs/qa/assessments/2.1-test-design-20250925.md
P0 tests identified: 6

## ðŸ”¬ Research & Validation Log
- Mode: solo (2025-09-25)
- Findings: Matrix emphasises configuration enforcement, embedding validation, telemetry observability, and secret masking in line with updated story acceptance criteria and risk profile.
- Sources: docs/stories/2.1.openai-model-guardrails.md, docs/qa/assessments/2.1-risk-20250925.md, docs/architecture/coding-standards.md#testing-expectations
- Residual Risks: Requires follow-on traceability + NFR assessments once implementation details solidify.
- Next Actions: Dev agent to implement P0 tests before merging, integrate Prometheus exporter stubs, and document alert thresholds in architecture shard.
