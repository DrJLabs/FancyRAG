# Risk Profile: Story 4.2 (Pipeline Orchestrator Module)

Date: 2025-10-03
Reviewer: Quinn (Test Architect)

## Executive Summary
- Total Risks Identified: 4
- Critical Risks: 0
- High Risks: 1
- Medium Risks: 1
- Low Risks: 2
- Overall Risk Posture: Manageable with targeted regression safeguards

## Context
Story 4.2 extracts the ingestion orchestration logic from `fancyrag.cli.kg_build_main` into a new `src/fancyrag/kg/pipeline.py` module. The work must preserve CLI behaviour, ensure dependency validation remains centralized, and keep QA gating plus telemetry intact. Prior story 4.1 already moved CLI wiring, so this story focuses on the pipeline core and introduces new module boundaries that other refactor stories will build upon.

## Risk Matrix

| Risk ID   | Category | Description | Probability | Impact | Score | Priority |
|-----------|----------|-------------|-------------|--------|-------|----------|
| TECH-001  | Technical | Pipeline extraction misses existing semantic/QA toggles, regressing ingestion parity | Medium (2) | High (3) | 6 | High |
| TECH-002  | Technical | New `fancyrag.kg` package introduces circular imports or misplaced helpers | Medium (2) | Medium (2) | 4 | Medium |
| DATA-001  | Data | Reset/rollback handling in the orchestrator deletes graph content unexpectedly | Low (1) | High (3) | 3 | Low |
| OPS-001   | Operational | Documentation & test updates lag behind the new module layout, confusing operators | Medium (2) | Low (1) | 2 | Low |

## Risk Details & Mitigations

### TECH-001 – Pipeline parity regression (Score 6, High)
- **Affected components:** `src/fancyrag/cli/kg_build_main.py`, `src/fancyrag/kg/pipeline.py`, QA gating utilities
- **Drivers:** Large surface area of orchestration logic (semantic enrichment, telemetry, chunk caching) currently housed in CLI module.
- **Mitigation Strategy (preventive):**
  - Extract logic incrementally with characterization tests before/after refactor.
  - Maintain dedicated unit tests around semantic toggles, ingest run keys, and structured logging.
  - Run `tests/integration/local_stack/test_minimal_path_smoke.py` plus parity snapshot for CLI outputs.
- **Testing Requirements:**
  - Add new unit tests validating orchestrator response payloads for semantic-enabled and baseline runs.
  - Extend smoke test assertions for QA summary artefacts.
- **Residual Risk:** Medium – complexity remains but drops once remaining modules migrate.

### TECH-002 – Import boundary regressions (Score 4, Medium)
- **Affected components:** new `src/fancyrag/kg` package, future QA/DB modules.
- **Drivers:** Risk of back-imports from CLI or QA helpers causing circular dependencies.
- **Mitigation Strategy (preventive + detective):**
  - Document allowed import direction (CLI → pipeline → QA/DB) and enforce via `pytest --import-mode=importlib` or custom lints.
  - Create targeted unit tests for orchestrator factory functions to ensure dependency injection remains explicit.
- **Testing Requirements:**
  - Static analysis or simple smoke test ensuring CLI layer never imports pipeline internals lazily.
  - Add failing test fixture if circular import detected (import pipeline from QA tests).
- **Residual Risk:** Low once modules consolidated.

### DATA-001 – Unintended graph resets (Score 3, Low)
- **Affected components:** reset flag handling, Neo4j write operations.
- **Drivers:** Extracted orchestrator might mishandle `--reset-database` leading to destructive operations.
- **Mitigation Strategy (preventive + corrective):**
  - Preserve guard that only the first source triggers reset; add regression tests using in-memory Neo4j stub.
  - Log dry-run summary prior to destructive operations; confirm QA gate stops the pipeline on failure.
- **Testing Requirements:**
  - Unit tests simulating multiple source specs verifying reset executes only once.
  - Integration smoke verifying dataset remains intact on partial failures.
- **Residual Risk:** Low; manual validation before release recommended.

### OPS-001 – Documentation/test drift (Score 2, Low)
- **Affected components:** `docs/architecture/source-tree.md`, refactor addendum, onboarding guides, test suites.
- **Drivers:** Rapid refactor sequencing might skip doc/test updates in this story.
- **Mitigation Strategy (detective):**
  - Treat doc updates as acceptance criteria item; include checklist in PR template.
  - Ensure reviewer verifies new module appears in source tree doc.
- **Testing Requirements:**
  - Run documentation lint (`scripts/check_docs.py --strict`) after updates.
- **Residual Risk:** Low provided doc tasks remain blocking.

## Recommendations Summary
- **Must Fix Before Merge:**
  - Preserve semantic enrichment and QA gating behaviours via targeted unit + smoke tests (addresses TECH-001).
  - Explicitly document dependency boundaries and add test coverage preventing circular imports (TECH-002).
- **Monitor Post-Merge:**
  - Validate reset behaviour against staging datasets (DATA-001).
  - Confirm docs/tests stay synchronized through reviewer checklists (OPS-001).

## Risk Summary YAML (for gate file)
```yaml
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 1
    low: 2
  highest:
    id: TECH-001
    score: 6
    title: "Pipeline extraction misses semantic/QA toggles"
  recommendations:
    must_fix:
      - "Characterize semantic + QA paths with tests before extraction"
      - "Document and enforce CLI → pipeline import direction"
    monitor:
      - "Spot-check reset flag behaviour against staging data"
      - "Verify architecture docs updated for new module"
```

## Residual & Follow-up Actions
- Confirm future modules (splitters, QA, db) integrate with the orchestrator via explicit interfaces to avoid rework.
- Track lint/CI additions enforcing import boundaries in Epic 4 backlog.
- Coordinate with Dev + Reviewer personas to ensure mitigations translate into concrete development tasks.

