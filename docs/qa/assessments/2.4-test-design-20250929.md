# Test Design: Story 2.4

Date: 2025-09-29
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 11
- Unit tests: 4 (36%)
- Integration tests: 6 (55%)
- E2E tests: 1 (9%)
- Priority distribution: P0: 8, P1: 3, P2: 0, P3: 0

Scenario set validates the docker-compose stack, operator documentation, and automated smoke checks while covering risks TECH-240, TECH-241, OPS-240, OPS-241, SEC-240 from docs/qa/assessments/2.4-risk-20250929.md.

## Test Scenarios by Acceptance Criteria

### AC1: Compose file provisions Neo4j + Qdrant with correct configuration.
| ID              | Level | Priority | Test Description                                                                                      | Justification                                                   | Mitigates |
|-----------------|-------|----------|--------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|-----------|
| 2.4-UNI-001     | Unit  | P0       | Render `docker compose config` and assert Neo4j 5.26 image, APOC plugin mount, ports 7474/7687, and env vars wired from `.env`. | Validates static configuration before runtime.                  | TECH-240 |
| 2.4-UNI-002     | Unit  | P0       | Validate Qdrant service definition includes persistent volume, port 6333, and `.env` URL/API key mapping. | Ensures storage + credentials align with spec.                 | TECH-241 |
| 2.4-INT-003     | Integration | P0 | Bring stack up locally; issue Bolt + HTTP health checks via `neo4j-admin` and `curl` to verify readiness. | Confirms services accept connections using documented ports.    | TECH-240, OPS-240 |
| 2.4-INT-004     | Integration | P0 | Inspect Neo4j container filesystem to confirm APOC jars present and available.                         | Ensures APOC features required by scripts exist.                | TECH-240 |

### AC2: Services include health checks, restart policies, and align with minimal path expectations.
| ID              | Level | Priority | Test Description                                                                                      | Justification                                                   | Mitigates |
|-----------------|-------|----------|--------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|-----------|
| 2.4-UNI-005     | Unit  | P0       | Parse compose definitions ensuring healthcheck commands exist for both services with reasonable intervals/retries. | Prevents flaky smoke runs.                                      | OPS-240 |
| 2.4-INT-006     | Integration | P0 | Simulate container failure by stopping Neo4j; verify restart policy brings service back and healthcheck reports failure during downtime. | Validates resilience expectations.                              | OPS-240 |
| 2.4-INT-007     | Integration | P1 | Run minimal-path scripts sequentially against running stack to assert compatibility with `SharedOpenAIClient` telemetry. | Confirms compose stack supports downstream workflows.           | TECH-240, OPS-240 |

### AC3: Documentation updated with runbooks and override guidance.
| ID              | Level | Priority | Test Description                                                                                      | Justification                                                   | Mitigates |
|-----------------|-------|----------|--------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|-----------|
| 2.4-UNI-008     | Unit  | P0       | Lint documentation section (`docs/architecture/overview.md`) ensuring step order matches bootstrap â†’ `.env` â†’ compose â†’ scripts â†’ teardown. | Guards against doc drift.                                       | OPS-241 |
| 2.4-UNI-009     | Unit  | P1       | Verify `.env.example` contains all variables referenced by compose file with accurate default descriptions. | Keeps operator setup deterministic.                             | OPS-241 |
| 2.4-INT-010     | Integration | P1 | Conduct doc-driven dry run: follow runbook commands end-to-end on fresh clone and confirm no missing steps. | Human validation of documentation accuracy.                     | OPS-241 |

### AC4: Automation and smoke workflows enforce compose integrity.
| ID              | Level | Priority | Test Description                                                                                      | Justification                                                   | Mitigates |
|-----------------|-------|----------|--------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------|-----------|
| 2.4-INT-011     | Integration | P0 | CI job executing `docker compose config` and `pytest tests/integration/local_stack/test_minimal_path_smoke.py`, failing on non-zero exit. | Provides automated guard for configuration + smoke path.        | OPS-240, TECH-241 |
| 2.4-E2E-012     | E2E   | P1       | Run minimal-path smoke in ephemeral CI runner, ensuring volumes cleaned with `docker compose down --volumes` and verifying log redaction. | Ensures reproducibility and secret hygiene in shared environments. | TECH-241, SEC-240 |

## Risk Coverage
- TECH-240: 2.4-UNI-001, 2.4-INT-003, 2.4-INT-004, 2.4-INT-007, 2.4-INT-011
- TECH-241: 2.4-UNI-002, 2.4-INT-007, 2.4-INT-011, 2.4-E2E-012
- OPS-240: 2.4-UNI-005, 2.4-INT-003, 2.4-INT-006, 2.4-INT-007, 2.4-INT-011
- OPS-241: 2.4-UNI-008, 2.4-UNI-009, 2.4-INT-010
- SEC-240: 2.4-E2E-012

## Recommended Execution Order
1. 2.4-UNI-001
2. 2.4-UNI-002
3. 2.4-UNI-005
4. 2.4-UNI-008
5. 2.4-UNI-009
6. 2.4-INT-003
7. 2.4-INT-004
8. 2.4-INT-006
9. 2.4-INT-007
10. 2.4-INT-010
11. 2.4-INT-011
12. 2.4-E2E-012

## Gate Snippet
```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 4
    integration: 6
    e2e: 1
  by_priority:
    p0: 8
    p1: 3
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Trace Hook
Test design matrix: docs/qa/assessments/2.4-test-design-20250929.md

## ðŸ”¬ Research & Validation Log
- Mode: solo (2025-09-29)
- Findings: Compose lint + smoke automation must land with Story 2.5 script availability; documentation verification prevents operator drift. Secret hygiene checks leverage sanitisation from Story 2.3.
- Sources: docs/stories/2.4.docker-compose-neo4j-qdrant.md, docs/qa/assessments/2.4-risk-20250929.md, docs/architecture/overview.md#minimal-path-workflow, docs/architecture/coding-standards.md#testing-expectations
- Residual Risks: CI runners may have constrained Docker resources; plan fallback for serialized smoke tests.
- Next Actions: Developer to implement P0 tests before merge, update `.env.example`, and wire CI smoke job; QA to revisit after Story 2.5 delivers ingestion scripts.
