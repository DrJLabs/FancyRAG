# Risk Profile: Story 2.5

Date: 2025-09-30
Reviewer: Quinn (Test Architect)

## Executive Summary
- Total Risks Identified: 5
- Critical Risks: 0
- High Risks: 1
- Risk Score: 76/100

Automation replaces stubbed ingestion scripts with production-ready code that touches Neo4j, OpenAI, and documentation flows. Key uncertainties involve index mismatch, retry behaviour, and operational guardrails when the local stack is not healthy. Sources: docs/stories/2.5.minimal-path-scripts.md, docs/architecture/overview.md#minimal-path-workflow, docs/bmad/focused-epics/local-stack/epic.md#story-manager-handoff, docs/architecture/coding-standards.md#critical-rules.

## Risk Distribution
### By Category
- Technical: 2 risks (High: 1, Medium: 1)
- Operational: 1 risk (Medium: 1)
- Security: 1 risk (Low: 1)
- Data: 1 risk (Low: 1)

### By Component
- `scripts/create_vector_index.py`: 2 risks
- `scripts/kg_build.py`: 2 risks
- Documentation & runbooks: 1 risk

## Risk Matrix

| Risk ID   | Description                                                                                  | Probability | Impact | Score | Priority |
|-----------|----------------------------------------------------------------------------------------------|-------------|--------|-------|----------|
| TECH-250  | Vector index script creates incorrect dimension/name, breaking downstream queries.           | Medium (2)  | High (3) | 6 | High |
| TECH-251  | KG pipeline retries fail to back off, exhausting OpenAI quota and leaving partial graph.     | Medium (2)  | Medium (2) | 4 | Medium |
| OPS-250   | Scripts assume Compose stack is up; missing health checks cause confusing operator failures. | Medium (2)  | Medium (2) | 4 | Medium |
| SEC-250   | Structured logs inadvertently emit secrets or raw prompts despite sanitisation helpers.      | Low (1)     | High (3) | 3 | Low |
| DATA-250  | Pipeline duplicates documents/chunks on rerun due to missing idempotency checks.             | Low (1)     | High (3) | 3 | Low |

## Detailed Risk Register

| Risk ID  | Category   | Description | Probability | Impact | Score | Mitigation | Residual Risk |
|----------|------------|-------------|-------------|--------|-------|------------|----------------|
| TECH-250 | Technical  | Incorrect index specs (dimensions/name/similarity) prevent retrieval + downstream export. | Medium (2) | High (3) | 6 | Enforce defaults via CLI + `.env`, add validation prior to creation, ensure smoke tests verify index metadata. | Monitor when Neo4j upgrades vector capabilities; add digest tests post-Story 2.6. |
| TECH-251 | Technical  | Retry/backoff bugs in `SimpleKGPipeline` orchestration trigger throttling or partial writes. | Medium (2) | Medium (2) | 4 | Use shared retry helpers with jitter, unit tests mocking OpenAI to assert stop at `OPENAI_MAX_ATTEMPTS`, capture metrics in logs. | Long-running ingestion may still hit hard limits; consider exponential backoff tuning. |
| OPS-250  | Operational | Operators may run scripts without stack up, leading to opaque driver errors. | Medium (2) | Medium (2) | 4 | Document prerequisite check (`check_local_stack.sh --up`), add CLI preflight + actionable error messages, extend smoke tests. | CI runners with limited Docker support require alternate validation path. |
| SEC-250  | Security   | JSON logs could carry secrets/prompts if sanitisation not applied consistently. | Low (1) | High (3) | 3 | Reuse log sanitiser from Story 2.3, add unit tests ensuring redaction, document logging expectations. | Residual risk of third-party library logs; monitor log output in integration fixtures. |
| DATA-250 | Data       | Ingestion reruns create duplicate nodes/relationships when idempotency not enforced. | Low (1) | High (3) | 3 | Ensure pipeline upserts via deterministic node keys, add integration test verifying rerun results and clean rollback guidance in docs. | Larger content sets may still require manual dedupe; plan for future Qdrant export reconciliation. |

## Risk-Based Testing Strategy
- Validate Neo4j index metadata via unit tests around helper functions plus integration assertion in minimal-path smoke (TECH-250).
- Mock OpenAI client to simulate rate limits and confirm retry ceilings/log metrics (TECH-251).
- Extend smoke test to fail fast if `check_local_stack.sh --up` not run; verify CLI preflight messages (OPS-250).
- Add unit test snapshot ensuring sensitive keys redacted from log records; inspect captured fixtures during integration runs (SEC-250).
- Execute rerun scenario integration test confirming no duplicate nodes/relationships; include cleanup guidance (DATA-250).

## Risk Acceptance Criteria
- Must fix before Ready for Review: TECH-250 high risk, TECH-251 medium risk (due to OpenAI costs), OPS-250 medium risk (operator experience).
- Can deploy with mitigation: SEC-250 and DATA-250 provided redaction tests + rerun guidance exist.

## Monitoring Requirements
- Review log fixtures after each smoke run for redaction compliance.
- Track OpenAI usage metrics during ingestion to adjust retry/backoff settings.
- Audit Neo4j schema via `CALL db.indexes()` as part of release checklist to ensure vector index remains aligned.

## Gate Snippet
```yaml
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 2
    low: 2
  highest: TECH-250
  recommendations:
    must_fix:
      - Enforce vector index validation with automated tests.
      - Harden retry/backoff handling for OpenAI ingestion calls.
      - Add preflight + smoke coverage for stack availability.
    monitor:
      - Inspect log fixtures for redaction regressions.
      - Review rerun idempotency once content volume increases.
```

## Hook Line
Risk profile: docs/qa/assessments/2.5-risk-20250930.md
