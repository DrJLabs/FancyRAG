# Risk Profile: Story 2.3

Date: 2025-09-28
Reviewer: Quinn (Test Architect)

## Executive Summary
- Total Risks Identified: 5
- Critical Risks: 0
- High Risks: 2
- Risk Score: 68/100

Story 2.3 introduces a shared OpenAI client that must centralise guardrails, retries, telemetry, and embedding validation for every CLI workflow. The highest risks concern enforcing the model/embedding contracts without drift and ensuring the readiness probe continues to emit the existing metrics/artefacts. Sources: docs/stories/2.3.openai-shared-client.md, docs/architecture/overview.md#openai-readiness-probe, docs/architecture/coding-standards.md, docs/prd.md#epic-2---models--vectors.

## Risk Distribution
### By Category
- Technical: 1 risk (High: 1)
- Data: 1 risk (High: 1)
- Performance: 1 risk (Medium: 1)
- Operational: 1 risk (Medium: 1)
- Security: 1 risk (Low: 1)

### By Component
- `src/cli/openai_client.py`: 2 risks
- `src/cli/diagnostics.py` readiness probe: 1 risk
- `OpenAISettings`/configuration layer: 1 risk
- Telemetry/logging pipeline: 1 risk

## Risk Matrix

| Risk ID  | Description                                                                                                     | Probability | Impact | Score | Priority |
|----------|-----------------------------------------------------------------------------------------------------------------|-------------|--------|-------|----------|
| TECH-230 | Shared client omits allowlist enforcement or diverges from SDK semantics, allowing unsupported models in prod   | Medium (2)  | High (3) | 6     | High |
| DATA-230 | Embedding helper fails to enforce 1536 dimensions or override handling, corrupting vector payloads and Qdrant joins | Medium (2) | High (3) | 6 | High |
| PERF-230 | Retry/backoff defaults introduce long-tail latency or storm the API under 429/500 bursts, breaching SLOs         | Medium (2)  | Medium (2) | 4 | Medium |
| OPS-230  | Readiness probe integration changes metrics schema/artifacts, breaking dashboards and automation expectations     | Medium (2)  | Medium (2) | 4 | Medium |
| SEC-230  | Centralised logging leaks prompts or API tokens when fallback/override metadata is emitted                      | Low (1)     | High (3) | 3 | Low |

## Detailed Risk Register

| Risk ID  | Category    | Description | Probability | Impact | Score | Mitigation | Residual Risk |
|----------|-------------|-------------|-------------|--------|-------|------------|----------------|
| TECH-230 | Technical   | Wrapper bypasses `OpenAISettings` validation or drifts from SDK behaviour, letting unsupported chat models slip into pipelines and causing runtime errors/cost spikes. | Medium (2) | High (3) | 6 | Keep allowlist in shared client, add contract/unit tests for unsupported models, ensure readiness probe and future pipelines import the wrapper exclusively, document upgrade steps when OpenAI model families change. | Future SDK changes may add new response fields the wrapper must expose quickly. |
| DATA-230 | Data        | Embedding helper fails to call `ensure_embedding_dimensions()` or mishandles overrides, leading to invalid vector lengths and broken Neo4j↔Qdrant joins. | Medium (2) | High (3) | 6 | Route all embedding operations through helper, add assertions for override paths, build integration test covering ingest→export→search loop, monitor export logs for mismatch warnings. | New pipelines might bypass wrapper; require lint/CI guard once wrapper lands. |
| PERF-230 | Performance | Retry/backoff defaults (max attempts, jitter) either hammer OpenAI under throttling or add excessive latency before surfacing errors, delaying operators. | Medium (2) | Medium (2) | 4 | Configure exponential backoff with ceiling aligned to coding standards, expose settings with sane defaults, add tests simulating `Retry-After` headers, document operational guidance for tuning in docs. | Future workload spikes could still saturate throughput; monitor metrics. |
| OPS-230  | Operational | Readiness probe migration alters metrics names/labels or artifact schema, breaking dashboards, alerting, or CI baselines dependent on deterministic output. | Medium (2) | Medium (2) | 4 | Snapshot current metrics/artifacts before refactor, add regression tests verifying unchanged schemas, update docs with migration notes, coordinate with observability owners before merge. | New telemetry fields may require dashboard updates; plan joint review during rollout. |
| SEC-230  | Security    | Centralised logging emits raw prompt fragments or secrets when recording overrides/fallbacks, violating masking policies. | Low (1) | High (3) | 3 | Reuse existing redaction utilities, add unit tests feeding sensitive tokens, ensure structured logs flag overrides without serialising raw payloads, include log review in code review checklist. | OpenAI SDK may add nested payload fields requiring future masks; schedule periodic audits. |

## Risk-Based Testing Strategy
- **Priority 1:** Contract tests validating chat allowlist + embedding dimension enforcement (TECH-230, DATA-230).
- **Priority 1:** Rate-limit simulation tests asserting retry/backoff behaviour and timeout caps (PERF-230).
- **Priority 1:** Regression tests for readiness probe metrics/artifacts, comparing against fixtures (OPS-230).
- **Priority 2:** Log redaction tests covering override/fallback events with synthetic secrets (SEC-230).

## Risk Acceptance Criteria
- Must fix before release: TECH-230, DATA-230, PERF-230, OPS-230.
- Deploy with mitigation: SEC-230 (monitor with sanitisation tests + log scrubbing).
- Accepted risks: None.

## Monitoring Requirements
- Prometheus dashboards must continue tracking latency, retry counts, fallback usage, and error rates with unchanged label sets.
- Alert on embedding dimension mismatch occurrences and treat repeated incidents as regression of DATA-230 mitigations.
- Add log-based alerts for unmasked secrets detected by sanitisation filters.

## Gate Snippet
```yaml
risk_summary:
  totals:
    critical: 0
    high: 2
    medium: 2
    low: 1
  highest: DATA-230
  recommendations:
    must_fix:
      - Enforce OpenAI model allowlist + contract tests before merge (TECH-230).
      - Keep embedding helper wired into all paths and test override/mismatch flows (DATA-230).
      - Simulate rate-limit responses to verify retry ceilings and alerting (PERF-230 & OPS-230).
    monitor:
      - Schedule quarterly log-scrub audits for the shared client (SEC-230).
```

## Hook Line
Risk profile: docs/qa/assessments/2.3-risk-20250928.md
