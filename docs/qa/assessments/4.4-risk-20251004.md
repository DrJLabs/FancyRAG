# Risk Profile: Story 4.4 (QA Evaluator Module)

Date: 2025-10-04
Reviewer: Quinn (Test Architect)

## Executive Summary
- Total Risks Identified: 3
- Critical Risks: 0
- High Risks: 1
- Medium Risks: 1
- Low Risks: 1
- Overall Risk Posture: Low-to-Moderate; mitigations rely on automated regression suites plus manual smoke validation to flag evaluator drift.

## Context
Story 4.4 extracts the ingestion QA evaluator logic from `src/fancyrag/kg/pipeline.py` into `src/fancyrag/qa/evaluator.py`, introduces shared QA dataclasses, and updates utilities and docs accordingly. The evaluator must preserve gating thresholds, Neo4j query semantics, and reporting contracts while the pipeline continues to orchestrate rollback and semantic metrics without behaviour changes.

## Risk Matrix

| Risk ID   | Category   | Description | Probability | Impact | Score | Priority |
|-----------|------------|-------------|-------------|--------|-------|----------|
| TECH-001  | Technical  | Evaluator extraction diverges from pipeline QA logic, causing false pass/fail outcomes or lost rollback triggers | Medium (2) | High (3) | 6 | High |
| DATA-001  | Data       | Report generation or path helpers regress, breaking downstream consumers that rely on JSON/Markdown artefacts | Medium (2) | Medium (2) | 4 | Medium |
| OPS-001   | Operational| Environments without `.env` files fail to inject required API keys after the new auto-loading behaviour | Low (1) | Medium (2) | 2 | Low |

## Risk Details & Mitigations

### TECH-001 – QA gating drift (Score 6, High)
- **Affected components:** `src/fancyrag/qa/evaluator.py`, `src/fancyrag/kg/pipeline.py`, unit suites under `tests/unit/fancyrag/qa/` and `tests/unit/fancyrag/kg/`.
- **Drivers:** Moving logic out of the pipeline risks subtle behaviour differences (e.g., threshold comparisons, anomaly text, semantic summaries) that could alter gating outcomes or skip rollback.
- **Mitigation Strategy:**
  - Maintain unit coverage for evaluator success/failure paths (`tests/unit/fancyrag/qa/test_evaluator.py`).
  - Keep pipeline tests stubbing evaluator to assert rollback wiring and QA section contents (`tests/unit/fancyrag/kg/test_pipeline.py`).
  - Continue running the local-stack smoke (`tests/integration/local_stack/test_minimal_path_smoke.py`) to validate end-to-end gating behaviour.
- **Residual Risk:** Low once smoke remains green after refactors; monitor future evaluator enhancements for threshold creep.

### DATA-001 – Report contract regression (Score 4, Medium)
- **Affected components:** `src/fancyrag/qa/evaluator.py`, `src/fancyrag/utils/paths.py`, documentation consumers.
- **Drivers:** Report paths now rely on shared utilities; path or payload changes could break tooling that ingests `quality_report.json` / `.md`.
- **Mitigation Strategy:**
  - Ensure evaluator tests assert report artefact creation and payload structure.
  - Preserve documentation references to report version `ingestion-qa-report/v1`; add contract checks if future stories introduce `qa/report.py`.
  - Encourage downstream tooling owners to pin to versioned schema before future evaluator expansions.
- **Residual Risk:** Medium pending formal schema validation; acceptable with current regression coverage.

### OPS-001 – Environment key propagation (Score 2, Low)
- **Affected components:** `.env` loading (`fancyrag.utils.env`), integration smoke, local developer workflows.
- **Drivers:** Smoke test now auto-loads `.env`; environments that intentionally avoid `.env` files might need explicit export and could fail silently if key absent.
- **Mitigation Strategy:**
  - Document fallback: set `OPENAI_API_KEY` explicitly if `.env` is not present.
  - Keep skip messaging in smoke test for missing keys via `ensure_env` to guide operators.
- **Residual Risk:** Low; auto-loading improves default behaviour, with clear skips as guardrails.

## Recommendations Summary
- **Must Fix Before Merge:**
  - Preserve evaluator parity through unit/integration coverage and smoke execution (mitigates TECH-001).
- **Monitor Post-Merge:**
  - Track downstream tooling for report contract changes (DATA-001).
  - Communicate `.env` loading assumptions to operators (OPS-001).

## Risk Summary YAML (for gate file)
```yaml
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 1
    low: 1
  highest:
    id: TECH-001
    score: 6
    title: "QA gating drift"
  recommendations:
    must_fix:
      - "Maintain evaluator and pipeline regression coverage plus smoke validation"
    monitor:
      - "Coordinate with report consumers before future schema changes"
```

## Residual & Follow-up Actions
- Keep evaluator test suite in sync as future stories introduce report helpers.
- Coordinate with dev/product when altering report schema or thresholds.
- Retain integration smoke in personal release checklist to catch evaluator regressions quickly.
