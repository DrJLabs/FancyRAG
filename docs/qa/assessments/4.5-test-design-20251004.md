# Test Design: Story 4.5 (QA Report Module)

Date: 2025-10-04
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 6
- Unit tests: 4 (66.7%)
- Integration tests: 2 (33.3%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 5, P1: 1, P2: 0, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Implement `src/fancyrag/qa/report.py` to house JSON/Markdown renderers preserving sanitisation, metadata, and directory handling

#### Scenarios

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 4.5-UNIT-001  | Unit  | P0       | Exercise `write_ingestion_report` with repo-local `qa_report_dir` and assert JSON/Markdown payloads remain sanitised, timestamped, and stored in unique folders | Pure helper logic; isolates timestamp collisions (OPS-001) without pipeline dependencies |
| 4.5-UNIT-002  | Unit  | P0       | Invoke `write_ingestion_report` with an out-of-tree `qa_report_dir` and assert returned paths are still resolvable (absolute or repo-relative) | Validates new moduleâ€™s path contract that downstream tooling depends upon (TECH-001) |
| 4.5-UNIT-003  | Unit  | P1       | Feed `render_markdown` a payload containing absolute source paths and sensitive-looking keys, verifying output redacts mount prefixes while retaining table structure | Focuses on Markdown rendering and sanitisation fallback (DATA-001) |
| 4.5-UNIT-004  | Unit  | P0       | Call `write_ingestion_report` twice with identical second-level timestamps and confirm collision-safe suffixing or retries preserve both artefacts | Reinforces regression fix for timestamp collisions noted in risk profile (OPS-001) |

### AC2: Update `IngestionQaEvaluator` to delegate report generation while keeping `QaResult` contract untouched

#### Scenarios

| ID            | Level       | Priority | Test | Justification |
| ------------- | ----------- | -------- | ---- | ------------- |
| 4.5-INT-001   | Integration | P0       | Run `IngestionQaEvaluator.evaluate` with stubbed Neo4j driver to confirm it calls the new module, returns repo-resolvable report paths, and preserves gating decisions | Validates evaluator-module boundary and contract longevity (TECH-001, DATA-001) |

### AC3: Ensure `fancyrag.kg.pipeline` and CLI wiring persist reports under configured `qa_report_dir` with unchanged failure semantics

#### Scenarios

| ID            | Level       | Priority | Test | Justification |
| ------------- | ----------- | -------- | ---- | ------------- |
| 4.5-INT-002   | Integration | P0       | Execute `kg.run` end-to-end with `--qa-report-dir` pointing to a temporary directory outside the repo, then resolve QA report paths from the emitted log | Covers CLI + pipeline glue plus ensures artefacts survive out-of-tree storage (TECH-001, OPS-001) |

### AC4: Add targeted tests for the new report module and refresh evaluator/pipeline tests per testing strategy

- Covered implicitly by scenarios 4.5-UNIT-001 through 4.5-INT-002; no additional standalone scenario required once suite is implemented.

## Risk Coverage

| Scenario ID   | Mitigates Risks |
| ------------- | ---------------- |
| 4.5-UNIT-001  | OPS-001 |
| 4.5-UNIT-002  | TECH-001 |
| 4.5-UNIT-003  | DATA-001 |
| 4.5-UNIT-004  | OPS-001 |
| 4.5-INT-001   | TECH-001, DATA-001 |
| 4.5-INT-002   | TECH-001, OPS-001 |

## Recommended Execution Order

1. Run P0 unit helpers (4.5-UNIT-001, 4.5-UNIT-002, 4.5-UNIT-004) to fail fast on sanitisation, path resolution, and collision handling.
2. Execute integration coverage (4.5-INT-001, 4.5-INT-002) to validate evaluator and CLI wiring.
3. Run the remaining P1 unit coverage (4.5-UNIT-003) to ensure Markdown redaction.

## Test Design Summary YAML
```yaml
test_design:
  scenarios_total: 6
  by_level:
    unit: 4
    integration: 2
    e2e: 0
  by_priority:
    p0: 5
    p1: 1
    p2: 0
    p3: 0
  coverage_gaps:
    - "AC5 documentation updates validated via existing docs lint; no automated test coverage required"
```

## Notes
- Coordinate with Dev to stage fixtures enabling CLI integration tests without external services.
- Ensure sanitisation assertions leverage sample payloads that include intentionally sensitive-looking keys to guard against regressions.
- Collision guard scenario (4.5-UNIT-004) may require implementation changes; if deferred, track as a follow-up to the OPS-001 mitigation.
