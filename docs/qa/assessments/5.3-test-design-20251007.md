# Test Design: Story 5.3 (Automate Stack Lifecycle Workflows)

Date: 2025-10-07
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 7 (64%)
- Integration tests: 3 (27%)
- Documentation/automation lint: 1 (9%)
- Priority distribution: P0: 7, P1: 4, P2: 1, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Consolidated automation entry point orchestrates end-to-end flow

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 5.3-UNIT-001  | Unit  | P0       | `tests/unit/fancyrag/cli/test_service_workflow.py::test_service_run_invokes_stages_in_order` | Verifies the Make/CLI wrapper calls bootstrap → ingest → export → evaluation → teardown exactly once, protecting sequencing. [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow] |
| 5.3-UNIT-002  | Unit  | P0       | `tests/unit/fancyrag/cli/test_service_workflow.py::test_service_run_uses_typed_settings_cache` | Ensures automation reuses `FancyRAGSettings` and does not rehydrate environment mid-run. [Source: docs/stories/5.2.centralise-typed-settings.md#dev-notes] |
| 5.3-UNIT-003  | Unit  | P1       | `tests/unit/fancyrag/cli/test_service_workflow.py::test_service_run_emits_stage_logs` | Confirms structured logging annotates each stage to aid operators. [Source: docs/architecture/overview.md#built-in-tool-playbook] |

### AC2: Guarded rollback/cleanup commands restore stack state

| ID            | Level       | Priority | Test | Justification |
| ------------- | ----------- | -------- | ---- | ------------- |
| 5.3-UNIT-004  | Unit        | P0       | `tests/unit/fancyrag/cli/test_service_workflow.py::test_service_rollback_invokes_cleanup` | Confirms rollback triggers Neo4j ingest cleanup, Qdrant deletion, and `--destroy-volumes` teardown. [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow] |
| 5.3-UNIT-007  | Unit        | P0       | `tests/unit/fancyrag/cli/test_service_workflow.py::test_stage_failure_sanitizes_summary` | Ensures StageFailure redacts secrets from automation logs/summaries. [Source: docs/architecture/coding-standards.md#Secrets Handling] |
| 5.3-INT-001   | Integration | P0       | `PYTHONPATH=src make service-run && make service-rollback` instrumentation asserts Neo4j/Qdrant counts return to baseline and QA artefacts persist. | End-to-end verification that cleanup restores environment without losing evidence. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#4-data-flow] |

### AC3: Preset and dataset overrides honoured by automation

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 5.3-UNIT-005  | Unit  | P0       | `tests/unit/fancyrag/cli/test_service_workflow.py::test_service_run_applies_preset_env` | Ensures `FANCYRAG_PRESET` and CLI overrides map into `FancyRAGSettings`. [Source: docs/brownfield-architecture.md#configuration-presets--contracts] |
| 5.3-UNIT-006  | Unit  | P1       | `tests/unit/fancyrag/cli/test_service_workflow.py::test_service_run_custom_dataset_path` | Confirms dataset path overrides propagate to ingestion phase. [Source: docs/architecture/projects/fancyrag-kg-build-refactor.md#3-module-level-design] |
| 5.3-INT-002   | Integration | P1       | `FANCYRAG_PRESET=full PYTHONPATH=src make service-run` validating artefact diffs and telemetry thresholds. | Exercises non-default preset to ensure automation covers multiple profiles. [Source: docs/brownfield-architecture.md#configuration-presets--contracts] |

### AC4: Documentation reflects new workflow

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 5.3-DOC-001   | Lint  | P2       | `PYTHONPATH=src python scripts/check_docs.py --strict --select onboarding_automation` | Extends docs lint to verify README/Quickstart reference the Make targets and stay in sync. [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow] |

### AC5: Integration smoke exercises automation entry point

| ID            | Level       | Priority | Test | Justification |
| ------------- | ----------- | -------- | ---- | ------------- |
| 5.3-INT-003   | Integration | P0       | `PYTHONPATH=src pytest tests/integration/local_stack/test_minimal_path_smoke.py::test_service_run_smoke -q` | New smoke test path that invokes `make service-run` and validates QA/evaluation artefacts, satisfying CI parity. [Source: docs/prd.md#story-53-automate-stack-lifecycle-workflows] |

## Risk Coverage

| Scenario ID   | Mitigates Risks          |
| ------------- | ------------------------ |
| 5.3-UNIT-001  | TECH-201                |
| 5.3-UNIT-002  | TECH-201, SEC-097       |
| 5.3-UNIT-003  | OPS-185                 |
| 5.3-UNIT-004  | DATA-122                |
| 5.3-INT-001   | DATA-122, OPS-185       |
| 5.3-UNIT-005  | TECH-201                |
| 5.3-UNIT-006  | TECH-201                |
| 5.3-INT-002   | TECH-201, DATA-122      |
| 5.3-DOC-001   | OPS-185                 |
| 5.3-INT-003   | TECH-201, DATA-122, OPS-185 |
| 5.3-UNIT-007  | SEC-097                 |

## Recommended Execution Order

1. Run automation unit suite (5.3-UNIT-001, 5.3-UNIT-002, 5.3-UNIT-004) to lock in sequencing, typed settings reuse, and rollback hooks.
2. Exercise preset/dataset override units (5.3-UNIT-005, 5.3-UNIT-006) followed by stage logging guard (5.3-UNIT-003) to finish functional coverage.
3. Execute integration tests: baseline smoke (5.3-INT-003), rollback validation (5.3-INT-001), and preset override run (5.3-INT-002).
4. Finish with documentation lint (5.3-DOC-001) to keep onboarding materials aligned with automation behaviour.

## Test Design Summary YAML
```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 7
    integration: 3
    lint: 1
  by_priority:
    p0: 7
    p1: 4
    p2: 1
    p3: 0
  coverage_gaps: []
```

## Notes

- Automation unit suite should leverage `pytest` fixtures that stub CLI subprocess calls to avoid launching Docker during fast tests. [Source: docs/architecture/coding-standards.md#Testing Expectations]
- Integration scenarios must capture artefacts under `artifacts/local_stack/` and record dataset/preset metadata for diffing future runs. [Source: docs/brownfield-architecture.md#automation-surface--rollback-workflow]
- Extend `scripts/check_docs.py` to include the onboarding automation probe so documentation regressions fail fast. [Source: README.md#Run the Stack Automation (Story 5.3)]
