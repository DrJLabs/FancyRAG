# Test Design: Story 4.6 (Neo4j Query Helpers Module)

Date: 2025-10-04
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 4
- Unit tests: 3 (75%)
- Integration tests: 1 (25%)
- E2E tests: 0 (0%)
- Priority distribution: P0: 3, P1: 1, P2: 0, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: Implement `src/fancyrag/db/neo4j_queries.py` housing reset, document relationship, rollback, and QA count helpers

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 4.6-UNIT-001  | Unit  | P0       | `tests/unit/fancyrag/db/test_neo4j_queries.py::test_reset_database_executes_delete` et al validate reset/document/rollback helpers invoke the expected Cypher with structured payloads | Confirms shared helpers encapsulate existing query semantics without depending on live Neo4j |
| 4.6-UNIT-002  | Unit  | P0       | `tests/unit/fancyrag/qa/test_evaluator.py::test_collect_counts_handles_tuple_result` and companions exercise QA count helpers via stubs | Ensures QA metrics consume the shared module and handle varied Neo4j driver responses |

### AC2: Refactor `src/fancyrag/kg/pipeline.py` to invoke the new helpers without altering ingest semantics

| ID            | Level | Priority | Test | Justification |
| ------------- | ----- | -------- | ---- | ------------- |
| 4.6-UNIT-003  | Unit  | P0       | Existing `tests/unit/fancyrag/kg/test_pipeline.py::test_run_pipeline_writes_log` suite patched to stub `_ensure_document_relationships` / `_collect_counts` aliases | Verifies pipeline orchestration still honours reset/rollback wiring against the shared helpers |

### AC3/AC4: Update QA evaluator to use shared helpers and add automated coverage including 4.5-INT-002

| ID            | Level       | Priority | Test | Justification |
| ------------- | ----------- | -------- | ---- | ------------- |
| 4.6-INT-001   | Integration | P0       | `tests/unit/scripts/test_kg_build.py::test_run_with_external_qa_report_dir` (4.5-INT-002) | Demonstrates CLI → pipeline → QA path uses shared helpers and still writes reports to external directories |
| 4.6-UNIT-004  | Unit        | P1       | `tests/unit/fancyrag/db/test_neo4j_queries.py::test_collect_semantic_counts_runs_queries` | Confirms semantic QA counts surface via the shared helper for evaluator consumption |

### AC5: Update architecture and epic documentation

- Verified via documentation diff; no direct automated test required.

## Risk Coverage

| Scenario ID   | Mitigates Risks |
| ------------- | ---------------- |
| 4.6-UNIT-001  | DATA-002 (provenance drift), OPS-002 (orphaned nodes) |
| 4.6-UNIT-002  | QA-001 (inconsistent metrics), DATA-003 (semantic counts divergence) |
| 4.6-UNIT-003  | OPS-002 (rollback failure), TECH-002 (helper integration regressions) |
| 4.6-INT-001   | OPS-003 (CLI path regressions), TECH-003 (external report dir handling) |
| 4.6-UNIT-004  | DATA-003 (semantic count mismatches) |

## Recommended Execution Order

1. Execute helper-focused unit suite (4.6-UNIT-001, 4.6-UNIT-002, 4.6-UNIT-004) to validate Cypher wrappers and QA adapters.
2. Run pipeline unit coverage (4.6-UNIT-003) to confirm orchestration still composes the helpers correctly.
3. Finish with integration scenario 4.6-INT-001 to ensure CLI wiring and external report directories remain functional.

## Test Design Summary YAML
```yaml
test_design:
  scenarios_total: 4
  by_level:
    unit: 3
    integration: 1
    e2e: 0
  by_priority:
    p0: 3
    p1: 1
    p2: 0
    p3: 0
  coverage_gaps: []
```

## Notes
- Helper unit tests rely on stub drivers; no live Neo4j instance required.
- Integration scenario reuses Story 4.5 coverage to close QA follow-up without duplicating fixtures.
- Documentation updates verified via linted diff rather than automated tests.
